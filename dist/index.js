import*as e from"../../../../power-user.js";import*as t from"../../../../../script.js";import*as n from"../../../../world-info.js";import*as r from"../../../../instruct-mode.js";import*as o from"../../../../chats.js";import*as i from"../../../../openai.js";import*as s from"../../../../authors-note.js";import*as a from"../../../../group-chats.js";import*as c from"../../../regex/engine.js";import*as l from"../../../../utils.js";import*as u from"../../../../slash-commands/SlashCommandCommonEnumsProvider.js";import*as d from"../../../../../lib.js";var p={d:(e,t)=>{for(var n in t)p.o(t,n)&&!p.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};class h extends Error{data;constructor(e,t){super(e),this.data=t}toString(){return this.message}}async function f(e,t){const n=SillyTavern.getContext(),r=new FormData;r.append("avatar",new Blob([JSON.stringify(e)],{type:"application/json"}),"character.json"),r.append("file_type","json");const o=n.getRequestHeaders();delete o["Content-Type"];const i=await fetch("/api/characters/import",{method:"POST",headers:o,body:r,cache:"no-cache"});if(!i.ok)throw new h(i.statusText,i);(t??1)&&await n.getCharacters()}class m{settingsKey;defaultSettings;constructor(e,t){this.settingsKey=e,this.defaultSettings=t}async initializeSettings(e={}){const{strategy:t="recursive"}=e,n=this.defaultSettings.version,r=this.defaultSettings.formatVersion,o=SillyTavern.getContext().extensionSettings[this.settingsKey],i={version:{changed:!1,new:n??""},formatVersion:{changed:!1,new:r??""},oldSettings:null,newSettings:this.defaultSettings};if(!o)return SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings(),i;const s={...i,oldSettings:structuredClone(o),version:{changed:!1,old:o.version,new:o.version},formatVersion:{changed:!1,old:o.formatVersion,new:o.formatVersion}};if("recursive"===t){function a(e,t){let n=!1;for(const r of Object.keys(t))void 0===e[r]?(e[r]=t[r],n=!0):"object"==typeof t[r]&&null!==t[r]&&(e[r]=e[r]||{},a(e[r],t[r])&&(n=!0));return n}n&&o.version!==n&&(s.version.changed=!0,s.version.new=n,o.version=n),r&&o.formatVersion!==r&&(s.formatVersion.changed=!0,s.formatVersion.new=r,o.formatVersion=r),(a(o,this.defaultSettings)||s.version.changed||s.formatVersion.changed)&&this.saveSettings()}else if(Array.isArray(t)){n&&!o.version&&(o.version=n,s.version.changed=!0,s.version.new=n),r&&!o.formatVersion&&(o.formatVersion=r,s.formatVersion.changed=!0,s.formatVersion.new=r);let c=structuredClone(o),l=o.formatVersion;try{for(const u of t)if(l===u.from){c=await u.action(c),l=u.to,c.formatVersion=u.to;const d=this.defaultSettings.version;d&&(c.version=d),s.formatVersion.changed=!0,s.formatVersion.new=u.to}if(s.formatVersion.changed){Object.assign(o,c);for(const p of Object.keys(o))Object.keys(c).includes(p)||delete o[p];this.saveSettings()}}catch(h){throw console.error("Failed to apply version changes:",h),new Error(`Version migration failed: ${h instanceof Error?h.message:h}`,{cause:h})}}return s.newSettings=o,s}getSettings(){return SillyTavern.getContext().extensionSettings[this.settingsKey]}updateSetting(e,t){SillyTavern.getContext().extensionSettings[this.settingsKey][e]=t,this.saveSettings()}saveSettings(){SillyTavern.getContext().saveSettingsDebounced()}resetSettings(){SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings()}}function g(e){return Array.isArray?Array.isArray(e):"[object Array]"===E(e)}function v(e){return"string"==typeof e}function y(e){return"number"==typeof e}function x(e){return!0===e||!1===e||function(e){return b(e)&&null!==e}(e)&&"[object Boolean]"==E(e)}function b(e){return"object"==typeof e}function w(e){return null!=e}function C(e){return!e.trim().length}function E(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":Object.prototype.toString.call(e)}const S=Object.prototype.hasOwnProperty;class A{constructor(e){this._keys=[],this._keyMap={};let t=0;e.forEach((e=>{let n=_(e);this._keys.push(n),this._keyMap[n.id]=n,t+=n.weight})),this._keys.forEach((e=>{e.weight/=t}))}get(e){return this._keyMap[e]}keys(){return this._keys}toJSON(){return JSON.stringify(this._keys)}}function _(e){let t=null,n=null,r=null,o=1,i=null;if(v(e)||g(e))r=e,t=P(e),n=k(e);else{if(!S.call(e,"name"))throw new Error((e=>`Missing ${e} property in key`)("name"));const s=e.name;if(r=s,S.call(e,"weight")&&(o=e.weight,o<=0))throw new Error((e=>`Property 'weight' in key '${e}' must be a positive integer`)(s));t=P(s),n=k(s),i=e.getFn}return{path:t,id:n,weight:o,src:r,getFn:i}}function P(e){return g(e)?e:e.split(".")}function k(e){return g(e)?e.join("."):e}var N={isCaseSensitive:!1,ignoreDiacritics:!1,includeScore:!1,keys:[],shouldSort:!0,sortFn:(e,t)=>e.score===t.score?e.idx<t.idx?-1:1:e.score<t.score?-1:1,includeMatches:!1,findAllMatches:!1,minMatchCharLength:1,location:0,threshold:.6,distance:100,...{useExtendedSearch:!1,getFn:function(e,t){let n=[],r=!1;const o=(e,t,i)=>{if(w(e))if(t[i]){const s=e[t[i]];if(!w(s))return;if(i===t.length-1&&(v(s)||y(s)||x(s)))n.push(function(e){return null==e?"":function(e){if("string"==typeof e)return e;let t=e+"";return"0"==t&&1/e==-1/0?"-0":t}(e)}(s));else if(g(s)){r=!0;for(let e=0,n=s.length;e<n;e+=1)o(s[e],t,i+1)}else t.length&&o(s,t,i+1)}else n.push(e)};return o(e,v(t)?t.split("."):t,0),r?n:n[0]},ignoreLocation:!1,ignoreFieldNorm:!1,fieldNormWeight:1}};const T=/[^ ]+/g;class I{constructor({getFn:e=N.getFn,fieldNormWeight:t=N.fieldNormWeight}={}){this.norm=function(e=1,t=3){const n=new Map,r=Math.pow(10,t);return{get(t){const o=t.match(T).length;if(n.has(o))return n.get(o);const i=1/Math.pow(o,.5*e),s=parseFloat(Math.round(i*r)/r);return n.set(o,s),s},clear(){n.clear()}}}(t,3),this.getFn=e,this.isCreated=!1,this.setIndexRecords()}setSources(e=[]){this.docs=e}setIndexRecords(e=[]){this.records=e}setKeys(e=[]){this.keys=e,this._keysMap={},e.forEach(((e,t)=>{this._keysMap[e.id]=t}))}create(){!this.isCreated&&this.docs.length&&(this.isCreated=!0,v(this.docs[0])?this.docs.forEach(((e,t)=>{this._addString(e,t)})):this.docs.forEach(((e,t)=>{this._addObject(e,t)})),this.norm.clear())}add(e){const t=this.size();v(e)?this._addString(e,t):this._addObject(e,t)}removeAt(e){this.records.splice(e,1);for(let t=e,n=this.size();t<n;t+=1)this.records[t].i-=1}getValueForItemAtKeyId(e,t){return e[this._keysMap[t]]}size(){return this.records.length}_addString(e,t){if(!w(e)||C(e))return;let n={v:e,i:t,n:this.norm.get(e)};this.records.push(n)}_addObject(e,t){let n={i:t,$:{}};this.keys.forEach(((t,r)=>{let o=t.getFn?t.getFn(e):this.getFn(e,t.path);if(w(o))if(g(o)){let e=[];const t=[{nestedArrIndex:-1,value:o}];for(;t.length;){const{nestedArrIndex:n,value:r}=t.pop();if(w(r))if(v(r)&&!C(r)){let t={v:r,i:n,n:this.norm.get(r)};e.push(t)}else g(r)&&r.forEach(((e,n)=>{t.push({nestedArrIndex:n,value:e})}))}n.$[r]=e}else if(v(o)&&!C(o)){let e={v:o,n:this.norm.get(o)};n.$[r]=e}})),this.records.push(n)}toJSON(){return{keys:this.keys,records:this.records}}}function D(e,t,{getFn:n=N.getFn,fieldNormWeight:r=N.fieldNormWeight}={}){const o=new I({getFn:n,fieldNormWeight:r});return o.setKeys(e.map(_)),o.setSources(t),o.create(),o}function O(e,{errors:t=0,currentLocation:n=0,expectedLocation:r=0,distance:o=N.distance,ignoreLocation:i=N.ignoreLocation}={}){const s=t/e.length;if(i)return s;const a=Math.abs(r-n);return o?s+a/o:a?1:s}const F=32;function L(e,t,n,{location:r=N.location,distance:o=N.distance,threshold:i=N.threshold,findAllMatches:s=N.findAllMatches,minMatchCharLength:a=N.minMatchCharLength,includeMatches:c=N.includeMatches,ignoreLocation:l=N.ignoreLocation}={}){if(t.length>F)throw new Error(`Pattern length exceeds max of ${F}.`);const u=t.length,d=e.length,p=Math.max(0,Math.min(r,d));let h=i,f=p;const m=a>1||c,g=m?Array(d):[];let v;for(;(v=e.indexOf(t,f))>-1;){let e=O(t,{currentLocation:v,expectedLocation:p,distance:o,ignoreLocation:l});if(h=Math.min(e,h),f=v+u,m){let e=0;for(;e<u;)g[v+e]=1,e+=1}}f=-1;let y=[],x=1,b=u+d;const w=1<<u-1;for(let r=0;r<u;r+=1){let i=0,a=b;for(;i<a;){O(t,{errors:r,currentLocation:p+a,expectedLocation:p,distance:o,ignoreLocation:l})<=h?i=a:b=a,a=Math.floor((b-i)/2+i)}b=a;let c=Math.max(1,p-a+1),v=s?d:Math.min(p+a,d)+u,C=Array(v+2);C[v+1]=(1<<r)-1;for(let i=v;i>=c;i-=1){let s=i-1,a=n[e.charAt(s)];if(m&&(g[s]=+!!a),C[i]=(C[i+1]<<1|1)&a,r&&(C[i]|=(y[i+1]|y[i])<<1|1|y[i+1]),C[i]&w&&(x=O(t,{errors:r,currentLocation:s,expectedLocation:p,distance:o,ignoreLocation:l}),x<=h)){if(h=x,f=s,f<=p)break;c=Math.max(1,2*p-f)}}if(O(t,{errors:r+1,currentLocation:p,expectedLocation:p,distance:o,ignoreLocation:l})>h)break;y=C}const C={isMatch:f>=0,score:Math.max(.001,x)};if(m){const e=function(e=[],t=N.minMatchCharLength){let n=[],r=-1,o=-1,i=0;for(let s=e.length;i<s;i+=1){let s=e[i];s&&-1===r?r=i:s||-1===r||(o=i-1,o-r+1>=t&&n.push([r,o]),r=-1)}return e[i-1]&&i-r>=t&&n.push([r,i-1]),n}(g,a);e.length?c&&(C.indices=e):C.isMatch=!1}return C}function M(e){let t={};for(let n=0,r=e.length;n<r;n+=1){const o=e.charAt(n);t[o]=(t[o]||0)|1<<r-n-1}return t}const j=String.prototype.normalize?e=>e.normalize("NFD").replace(/[\u0300-\u036F\u0483-\u0489\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED\u0711\u0730-\u074A\u07A6-\u07B0\u07EB-\u07F3\u07FD\u0816-\u0819\u081B-\u0823\u0825-\u0827\u0829-\u082D\u0859-\u085B\u08D3-\u08E1\u08E3-\u0903\u093A-\u093C\u093E-\u094F\u0951-\u0957\u0962\u0963\u0981-\u0983\u09BC\u09BE-\u09C4\u09C7\u09C8\u09CB-\u09CD\u09D7\u09E2\u09E3\u09FE\u0A01-\u0A03\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A70\u0A71\u0A75\u0A81-\u0A83\u0ABC\u0ABE-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AE2\u0AE3\u0AFA-\u0AFF\u0B01-\u0B03\u0B3C\u0B3E-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B56\u0B57\u0B62\u0B63\u0B82\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD7\u0C00-\u0C04\u0C3E-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C62\u0C63\u0C81-\u0C83\u0CBC\u0CBE-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CE2\u0CE3\u0D00-\u0D03\u0D3B\u0D3C\u0D3E-\u0D44\u0D46-\u0D48\u0D4A-\u0D4D\u0D57\u0D62\u0D63\u0D82\u0D83\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DF2\u0DF3\u0E31\u0E34-\u0E3A\u0E47-\u0E4E\u0EB1\u0EB4-\u0EB9\u0EBB\u0EBC\u0EC8-\u0ECD\u0F18\u0F19\u0F35\u0F37\u0F39\u0F3E\u0F3F\u0F71-\u0F84\u0F86\u0F87\u0F8D-\u0F97\u0F99-\u0FBC\u0FC6\u102B-\u103E\u1056-\u1059\u105E-\u1060\u1062-\u1064\u1067-\u106D\u1071-\u1074\u1082-\u108D\u108F\u109A-\u109D\u135D-\u135F\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17B4-\u17D3\u17DD\u180B-\u180D\u1885\u1886\u18A9\u1920-\u192B\u1930-\u193B\u1A17-\u1A1B\u1A55-\u1A5E\u1A60-\u1A7C\u1A7F\u1AB0-\u1ABE\u1B00-\u1B04\u1B34-\u1B44\u1B6B-\u1B73\u1B80-\u1B82\u1BA1-\u1BAD\u1BE6-\u1BF3\u1C24-\u1C37\u1CD0-\u1CD2\u1CD4-\u1CE8\u1CED\u1CF2-\u1CF4\u1CF7-\u1CF9\u1DC0-\u1DF9\u1DFB-\u1DFF\u20D0-\u20F0\u2CEF-\u2CF1\u2D7F\u2DE0-\u2DFF\u302A-\u302F\u3099\u309A\uA66F-\uA672\uA674-\uA67D\uA69E\uA69F\uA6F0\uA6F1\uA802\uA806\uA80B\uA823-\uA827\uA880\uA881\uA8B4-\uA8C5\uA8E0-\uA8F1\uA8FF\uA926-\uA92D\uA947-\uA953\uA980-\uA983\uA9B3-\uA9C0\uA9E5\uAA29-\uAA36\uAA43\uAA4C\uAA4D\uAA7B-\uAA7D\uAAB0\uAAB2-\uAAB4\uAAB7\uAAB8\uAABE\uAABF\uAAC1\uAAEB-\uAAEF\uAAF5\uAAF6\uABE3-\uABEA\uABEC\uABED\uFB1E\uFE00-\uFE0F\uFE20-\uFE2F]/g,""):e=>e;class B{constructor(e,{location:t=N.location,threshold:n=N.threshold,distance:r=N.distance,includeMatches:o=N.includeMatches,findAllMatches:i=N.findAllMatches,minMatchCharLength:s=N.minMatchCharLength,isCaseSensitive:a=N.isCaseSensitive,ignoreDiacritics:c=N.ignoreDiacritics,ignoreLocation:l=N.ignoreLocation}={}){if(this.options={location:t,threshold:n,distance:r,includeMatches:o,findAllMatches:i,minMatchCharLength:s,isCaseSensitive:a,ignoreDiacritics:c,ignoreLocation:l},e=a?e:e.toLowerCase(),e=c?j(e):e,this.pattern=e,this.chunks=[],!this.pattern.length)return;const u=(e,t)=>{this.chunks.push({pattern:e,alphabet:M(e),startIndex:t})},d=this.pattern.length;if(d>F){let e=0;const t=d%F,n=d-t;for(;e<n;)u(this.pattern.substr(e,F),e),e+=F;if(t){const e=d-F;u(this.pattern.substr(e),e)}}else u(this.pattern,0)}searchIn(e){const{isCaseSensitive:t,ignoreDiacritics:n,includeMatches:r}=this.options;if(e=t?e:e.toLowerCase(),e=n?j(e):e,this.pattern===e){let t={isMatch:!0,score:0};return r&&(t.indices=[[0,e.length-1]]),t}const{location:o,distance:i,threshold:s,findAllMatches:a,minMatchCharLength:c,ignoreLocation:l}=this.options;let u=[],d=0,p=!1;this.chunks.forEach((({pattern:t,alphabet:n,startIndex:h})=>{const{isMatch:f,score:m,indices:g}=L(e,t,n,{location:o+h,distance:i,threshold:s,findAllMatches:a,minMatchCharLength:c,includeMatches:r,ignoreLocation:l});f&&(p=!0),d+=m,f&&g&&(u=[...u,...g])}));let h={isMatch:p,score:p?d/this.chunks.length:1};return p&&r&&(h.indices=u),h}}class R{constructor(e){this.pattern=e}static isMultiMatch(e){return V(e,this.multiRegex)}static isSingleMatch(e){return V(e,this.singleRegex)}search(){}}function V(e,t){const n=e.match(t);return n?n[1]:null}class q extends R{constructor(e,{location:t=N.location,threshold:n=N.threshold,distance:r=N.distance,includeMatches:o=N.includeMatches,findAllMatches:i=N.findAllMatches,minMatchCharLength:s=N.minMatchCharLength,isCaseSensitive:a=N.isCaseSensitive,ignoreDiacritics:c=N.ignoreDiacritics,ignoreLocation:l=N.ignoreLocation}={}){super(e),this._bitapSearch=new B(e,{location:t,threshold:n,distance:r,includeMatches:o,findAllMatches:i,minMatchCharLength:s,isCaseSensitive:a,ignoreDiacritics:c,ignoreLocation:l})}static get type(){return"fuzzy"}static get multiRegex(){return/^"(.*)"$/}static get singleRegex(){return/^(.*)$/}search(e){return this._bitapSearch.searchIn(e)}}class W extends R{constructor(e){super(e)}static get type(){return"include"}static get multiRegex(){return/^'"(.*)"$/}static get singleRegex(){return/^'(.*)$/}search(e){let t,n=0;const r=[],o=this.pattern.length;for(;(t=e.indexOf(this.pattern,n))>-1;)n=t+o,r.push([t,n-1]);const i=!!r.length;return{isMatch:i,score:i?0:1,indices:r}}}const G=[class extends R{constructor(e){super(e)}static get type(){return"exact"}static get multiRegex(){return/^="(.*)"$/}static get singleRegex(){return/^=(.*)$/}search(e){const t=e===this.pattern;return{isMatch:t,score:t?0:1,indices:[0,this.pattern.length-1]}}},W,class extends R{constructor(e){super(e)}static get type(){return"prefix-exact"}static get multiRegex(){return/^\^"(.*)"$/}static get singleRegex(){return/^\^(.*)$/}search(e){const t=e.startsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,this.pattern.length-1]}}},class extends R{constructor(e){super(e)}static get type(){return"inverse-prefix-exact"}static get multiRegex(){return/^!\^"(.*)"$/}static get singleRegex(){return/^!\^(.*)$/}search(e){const t=!e.startsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},class extends R{constructor(e){super(e)}static get type(){return"inverse-suffix-exact"}static get multiRegex(){return/^!"(.*)"\$$/}static get singleRegex(){return/^!(.*)\$$/}search(e){const t=!e.endsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},class extends R{constructor(e){super(e)}static get type(){return"suffix-exact"}static get multiRegex(){return/^"(.*)"\$$/}static get singleRegex(){return/^(.*)\$$/}search(e){const t=e.endsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[e.length-this.pattern.length,e.length-1]}}},class extends R{constructor(e){super(e)}static get type(){return"inverse-exact"}static get multiRegex(){return/^!"(.*)"$/}static get singleRegex(){return/^!(.*)$/}search(e){const t=-1===e.indexOf(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},q],U=G.length,H=/ +(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/;const X=new Set([q.type,W.type]);class Y{constructor(e,{isCaseSensitive:t=N.isCaseSensitive,ignoreDiacritics:n=N.ignoreDiacritics,includeMatches:r=N.includeMatches,minMatchCharLength:o=N.minMatchCharLength,ignoreLocation:i=N.ignoreLocation,findAllMatches:s=N.findAllMatches,location:a=N.location,threshold:c=N.threshold,distance:l=N.distance}={}){this.query=null,this.options={isCaseSensitive:t,ignoreDiacritics:n,includeMatches:r,minMatchCharLength:o,findAllMatches:s,ignoreLocation:i,location:a,threshold:c,distance:l},e=t?e:e.toLowerCase(),e=n?j(e):e,this.pattern=e,this.query=function(e,t={}){return e.split("|").map((e=>{let n=e.trim().split(H).filter((e=>e&&!!e.trim())),r=[];for(let e=0,o=n.length;e<o;e+=1){const o=n[e];let i=!1,s=-1;for(;!i&&++s<U;){const e=G[s];let n=e.isMultiMatch(o);n&&(r.push(new e(n,t)),i=!0)}if(!i)for(s=-1;++s<U;){const e=G[s];let n=e.isSingleMatch(o);if(n){r.push(new e(n,t));break}}}return r}))}(this.pattern,this.options)}static condition(e,t){return t.useExtendedSearch}searchIn(e){const t=this.query;if(!t)return{isMatch:!1,score:1};const{includeMatches:n,isCaseSensitive:r,ignoreDiacritics:o}=this.options;e=r?e:e.toLowerCase(),e=o?j(e):e;let i=0,s=[],a=0;for(let r=0,o=t.length;r<o;r+=1){const o=t[r];s.length=0,i=0;for(let t=0,r=o.length;t<r;t+=1){const r=o[t],{isMatch:c,indices:l,score:u}=r.search(e);if(!c){a=0,i=0,s.length=0;break}if(i+=1,a+=u,n){const e=r.constructor.type;X.has(e)?s=[...s,...l]:s.push(l)}}if(i){let e={isMatch:!0,score:a/i};return n&&(e.indices=s),e}}return{isMatch:!1,score:1}}}const z=[];function J(e,t){for(let n=0,r=z.length;n<r;n+=1){let r=z[n];if(r.condition(e,t))return new r(e,t)}return new B(e,t)}const K="$and",Z="$or",Q="$path",ee="$val",te=e=>!(!e[K]&&!e[Z]),ne=e=>({[K]:Object.keys(e).map((t=>({[t]:e[t]})))});function re(e,t,{auto:n=!0}={}){const r=e=>{let o=Object.keys(e);const i=(e=>!!e[Q])(e);if(!i&&o.length>1&&!te(e))return r(ne(e));if((e=>!g(e)&&b(e)&&!te(e))(e)){const r=i?e[Q]:o[0],s=i?e[ee]:e[r];if(!v(s))throw new Error((e=>`Invalid value for key ${e}`)(r));const a={keyId:k(r),pattern:s};return n&&(a.searcher=J(s,t)),a}let s={children:[],operator:o[0]};return o.forEach((t=>{const n=e[t];g(n)&&n.forEach((e=>{s.children.push(r(e))}))})),s};return te(e)||(e=ne(e)),r(e)}function oe(e,t){const n=e.matches;t.matches=[],w(n)&&n.forEach((e=>{if(!w(e.indices)||!e.indices.length)return;const{indices:n,value:r}=e;let o={indices:n,value:r};e.key&&(o.key=e.key.src),e.idx>-1&&(o.refIndex=e.idx),t.matches.push(o)}))}function ie(e,t){t.score=e.score}class se{constructor(e,t={},n){this.options={...N,...t},this.options.useExtendedSearch,this._keyStore=new A(this.options.keys),this.setCollection(e,n)}setCollection(e,t){if(this._docs=e,t&&!(t instanceof I))throw new Error("Incorrect 'index' type");this._myIndex=t||D(this.options.keys,this._docs,{getFn:this.options.getFn,fieldNormWeight:this.options.fieldNormWeight})}add(e){w(e)&&(this._docs.push(e),this._myIndex.add(e))}remove(e=()=>!1){const t=[];for(let n=0,r=this._docs.length;n<r;n+=1){const o=this._docs[n];e(o,n)&&(this.removeAt(n),n-=1,r-=1,t.push(o))}return t}removeAt(e){this._docs.splice(e,1),this._myIndex.removeAt(e)}getIndex(){return this._myIndex}search(e,{limit:t=-1}={}){const{includeMatches:n,includeScore:r,shouldSort:o,sortFn:i,ignoreFieldNorm:s}=this.options;let a=v(e)?v(this._docs[0])?this._searchStringList(e):this._searchObjectList(e):this._searchLogical(e);return function(e,{ignoreFieldNorm:t=N.ignoreFieldNorm}){e.forEach((e=>{let n=1;e.matches.forEach((({key:e,norm:r,score:o})=>{const i=e?e.weight:null;n*=Math.pow(0===o&&i?Number.EPSILON:o,(i||1)*(t?1:r))})),e.score=n}))}(a,{ignoreFieldNorm:s}),o&&a.sort(i),y(t)&&t>-1&&(a=a.slice(0,t)),function(e,t,{includeMatches:n=N.includeMatches,includeScore:r=N.includeScore}={}){const o=[];return n&&o.push(oe),r&&o.push(ie),e.map((e=>{const{idx:n}=e,r={item:t[n],refIndex:n};return o.length&&o.forEach((t=>{t(e,r)})),r}))}(a,this._docs,{includeMatches:n,includeScore:r})}_searchStringList(e){const t=J(e,this.options),{records:n}=this._myIndex,r=[];return n.forEach((({v:e,i:n,n:o})=>{if(!w(e))return;const{isMatch:i,score:s,indices:a}=t.searchIn(e);i&&r.push({item:e,idx:n,matches:[{score:s,value:e,norm:o,indices:a}]})})),r}_searchLogical(e){const t=re(e,this.options),n=(e,t,r)=>{if(!e.children){const{keyId:n,searcher:o}=e,i=this._findMatches({key:this._keyStore.get(n),value:this._myIndex.getValueForItemAtKeyId(t,n),searcher:o});return i&&i.length?[{idx:r,item:t,matches:i}]:[]}const o=[];for(let i=0,s=e.children.length;i<s;i+=1){const s=e.children[i],a=n(s,t,r);if(a.length)o.push(...a);else if(e.operator===K)return[]}return o},r=this._myIndex.records,o={},i=[];return r.forEach((({$:e,i:r})=>{if(w(e)){let s=n(t,e,r);s.length&&(o[r]||(o[r]={idx:r,item:e,matches:[]},i.push(o[r])),s.forEach((({matches:e})=>{o[r].matches.push(...e)})))}})),i}_searchObjectList(e){const t=J(e,this.options),{keys:n,records:r}=this._myIndex,o=[];return r.forEach((({$:e,i:r})=>{if(!w(e))return;let i=[];n.forEach(((n,r)=>{i.push(...this._findMatches({key:n,value:e[r],searcher:t}))})),i.length&&o.push({idx:r,item:e,matches:i})})),o}_findMatches({key:e,value:t,searcher:n}){if(!w(t))return[];let r=[];if(g(t))t.forEach((({v:t,i:o,n:i})=>{if(!w(t))return;const{isMatch:s,score:a,indices:c}=n.searchIn(t);s&&r.push({score:a,key:e,value:t,idx:o,norm:i,indices:c})}));else{const{v:o,n:i}=t,{isMatch:s,score:a,indices:c}=n.searchIn(o);s&&r.push({score:a,key:e,value:o,norm:i,indices:c})}return r}}function ae(e,t={}){const n="string"==typeof e?document.querySelector(e):e;if(!n)throw new Error(`Could not find container: ${e}`);const r=t.placeholderText||"Select items...",o=t.closeOnSelect??!1,i=t.enableSearch??!1,s=t.multiple??!0,a=t.searchPlaceholderText||"Search...",c=t.searchNoResultsText||"No results found",l=t.searchDebounceMs??200;let u=[...t.initialList||[]];n.innerHTML="",n.classList.add("fancy-dropdown-container"),Object.assign(n.style,{position:"relative",userSelect:"none"});const d=document.createElement("div");d.className="fancy-dropdown-trigger",Object.assign(d.style,{padding:"8px 12px",border:"1px solid var(--border-color)",backgroundColor:"var(--bg-color)",color:"var(--text-color)",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"space-between"});const p=document.createElement("span");p.className="fancy-dropdown-trigger-text",p.textContent=r;const h=document.createElement("i");h.className="fas fa-chevron-down",h.style.marginLeft="8px",d.append(p,h),n.append(d);const f=document.createElement("div");f.className="fancy-dropdown-list",Object.assign(f.style,{position:"absolute",top:"100%",left:"0",right:"0",maxHeight:"300px",display:"none",zIndex:"1050",border:"1px solid var(--border-color)",borderTop:"none",backgroundColor:"var(--bg-color-popup, var(--bg-color-secondary, var(--greyCAIbg, var(--grey30))))",color:"var(--text-color)",borderRadius:"0 0 4px 4px",boxShadow:"0 4px 8px var(--black50a)",overflowY:"auto"}),n.append(f);let m=null,g=null,v=null,y=null;i&&(g=document.createElement("div"),g.className="fancy-dropdown-search-wrapper",Object.assign(g.style,{padding:"8px",borderBottom:"1px solid var(--border-color)",position:"sticky",top:"0",backgroundColor:"inherit"}),m=document.createElement("input"),m.type="text",m.className="fancy-dropdown-search-input",m.placeholder=a,Object.assign(m.style,{width:"100%",padding:"6px 10px",border:"1px solid var(--border-color)",borderRadius:"3px",boxSizing:"border-box",backgroundColor:"var(--bg-color)",color:"var(--text-color)"}),m.addEventListener("click",(e=>e.stopPropagation())),g.append(m),f.append(g),v=document.createElement("div"),v.className="fancy-dropdown-no-results",v.textContent=c,Object.assign(v.style,{padding:"8px 12px",textAlign:"center",color:"var(--text-color-secondary, var(--grey50))",display:"none"}),f.append(v));let x=!1,b=null;const w=e=>"string"==typeof e?e:e.label,C=e=>"string"==typeof e?e:e.value;let E=(t.initialValues||[]).filter((e=>u.some((t=>C(t)===e))));const S=()=>{if(!i)return;const e={includeScore:!1,threshold:.4,isCaseSensitive:!1,findAllMatches:!0,...t.searchFuseOptions||{},keys:t.searchFuseOptions?.keys||[{name:"label",weight:.7},{name:"value",weight:.3}]},n=u.map((e=>"string"==typeof e?{value:e,label:e}:e));!t.searchFuseOptions?.keys&&u.every((e=>"string"==typeof e))&&(e.keys=["label"]),b=new se(n,e)},A=e=>{let t=!1;f.querySelectorAll(".fancy-dropdown-item").forEach((n=>{const r=n.dataset.value,o=E.includes(r),i=n.querySelector(".checkmark");o?(n.classList.add("selected"),i&&(i.style.display="inline-block")):(n.classList.remove("selected"),i&&(i.style.display="none")),void 0!==e?e.includes(r)?(n.style.display="flex",t=!0):n.style.display="none":(n.style.display="flex",t=!0)})),i&&v&&(v.style.display=void 0===e||t?"none":"block"),(()=>{if(0===E.length)p.textContent=r;else if(1===E.length){const e=E[0],t=u.find((t=>C(t)===e)),n=t?w(t):e;p.textContent=n}else p.textContent=`${E.length} items selected`})()},_=e=>{if(!i||!b)return void A();const t=e.trim();if(""===t)return void A(void 0);const n=b.search(t).map((e=>e.item.value));A(n)},P=()=>{m&&(y&&clearTimeout(y),y=window.setTimeout((()=>{m&&_(m.value)}),l))},k=()=>{x||(x=!0,f.style.display="block",h.classList.remove("fa-chevron-down"),h.classList.add("fa-chevron-up"),i&&m&&setTimeout((()=>m?.focus()),50))},N=()=>{x&&(x=!1,f.style.display="none",i&&m&&(m.value="",_("")),h.classList.remove("fa-chevron-up"),h.classList.add("fa-chevron-down"),y&&clearTimeout(y))};d.addEventListener("click",(e=>{e.stopPropagation(),x?N():k()})),document.addEventListener("click",(e=>{x&&n&&!n.contains(e.target)&&N()})),i&&m&&m.addEventListener("input",P);const T=(e,n)=>{const r=C(e),a=w(e),c=document.createElement("div");c.className="fancy-dropdown-item",c.dataset.value=r,Object.assign(c.style,{padding:"8px 12px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"space-between"}),c.addEventListener("mouseenter",(()=>{c.style.backgroundColor="var(--hover-color, var(--white20a))"})),c.addEventListener("mouseleave",(()=>{c.style.backgroundColor=""}));const l=document.createElement("span");l.textContent=a,c.append(l);const u=document.createElement("i");return u.className="checkmark fa-solid fa-check",Object.assign(u.style,{marginLeft:"8px",display:n?"inline-block":"none"}),c.append(u),c.addEventListener("click",(function(e){e.stopPropagation();const n=e.currentTarget.dataset.value,r=[...E];let a;a=s?E.includes(n)?E.filter((e=>e!==n)):[...E,n]:E.includes(n)?[]:[n];(async()=>{if(t.onBeforeSelection)try{if(!await Promise.resolve(t.onBeforeSelection(r,a)))return!1}catch(e){return console.error("onBeforeSelection callback failed:",e),!1}return!0})().then((e=>{e&&(E=a,i&&m&&""!==m.value.trim()?_(m.value):A(void 0),t.onSelectChange&&Promise.resolve(t.onSelectChange(r,E)).catch((e=>console.error("onSelectChange callback failed:",e))),o&&N())}))})),v?f.insertBefore(c,v):f.append(c),c};u.length>0&&u.forEach((e=>{const t=C(e);T(e,E.includes(t))})),S(),A();return{container:n,dropdownTrigger:d,dropdownList:f,getValues:()=>[...E],setValues:e=>{const n=[...E],r=e.filter((e=>u.some((t=>C(t)===e))));E=[...r],i&&m&&""!==m.value?(m.value="",_("")):A();JSON.stringify(n.sort())!==JSON.stringify(E.sort())&&t.onSelectChange&&Promise.resolve(t.onSelectChange(n,E)).catch((e=>console.error("onSelectChange callback failed:",e)))},getOptions:()=>u.map((e=>"string"==typeof e?{value:e,label:e}:e)),addOption:(e,n=!1)=>{const r=C(e);if(u.some((e=>C(e)===r)))return;u.push(e),T(e,n),S();let o=!1;const a=[...E];n&&!E.includes(r)?(s?E.push(r):E=[r],o=!0):n&&!s&&E.length>0&&E[0]!==r&&(E=[r],o=!0),i&&m&&""!==m.value?_(m.value):A(),o&&t.onSelectChange&&Promise.resolve(t.onSelectChange(a,E)).catch((e=>console.error("onSelectChange callback failed:",e)))},removeOption:e=>{const n=u.length;if(u=u.filter((t=>C(t)!==e)),u.length===n)return;let r=!1;const o=[...E],s=E.indexOf(e);s>-1&&(E.splice(s,1),r=!0);const a=f.querySelector(`.fancy-dropdown-item[data-value="${e}"]`);a?.remove(),S(),i&&m&&""!==m.value?_(m.value):A(),r&&t.onSelectChange&&Promise.resolve(t.onSelectChange(o,E)).catch((e=>console.error("onSelectChange callback failed:",e)))},selectAll:()=>{if(!s)return;const e=[...E],n=u.map(C);E=[...new Set([...E,...n])];const r=JSON.stringify(e.sort())!==JSON.stringify(E.sort());i&&m&&""!==m.value?_(m.value):A(),r&&t.onSelectChange&&Promise.resolve(t.onSelectChange(e,E)).catch((e=>console.error("onSelectChange callback failed:",e)))},deselectAll:()=>{const e=[...E];E.length>0&&(E=[],i&&m&&""!==m.value?_(m.value):A(),t.onSelectChange&&Promise.resolve(t.onSelectChange(e,E)).catch((e=>console.error("onSelectChange callback failed:",e))))},disable:()=>{n.style.pointerEvents="none",n.style.opacity="0.6",x&&N()},enable:()=>{n.style.pointerEvents="auto",n.style.opacity="1"},open:k,close:N,toggle:()=>x?N():k()}}se.version="7.1.0",se.createIndex=D,se.parseIndex=function(e,{getFn:t=N.getFn,fieldNormWeight:n=N.fieldNormWeight}={}){const{keys:r,records:o}=e,i=new I({getFn:t,fieldNormWeight:n});return i.setKeys(r),i.setIndexRecords(o),i},se.config=N,se.parseQuery=re,function(...e){z.push(...e)}(Y);const ce=(e=>{var t={};return p.d(t,e),t})({persona_description_positions:()=>e.persona_description_positions,renderStoryString:()=>e.renderStoryString});const le=(e=>{var t={};return p.d(t,e),t})({baseChatReplace:()=>t.baseChatReplace,chat_metadata:()=>t.chat_metadata,depth_prompt_depth_default:()=>t.depth_prompt_depth_default,depth_prompt_role_default:()=>t.depth_prompt_role_default,extension_prompt_types:()=>t.extension_prompt_types,getMaxContextSize:()=>t.getMaxContextSize,name1:()=>t.name1,name2:()=>t.name2,parseMesExamples:()=>t.parseMesExamples,this_chid:()=>t.this_chid});const ue=(e=>{var t={};return p.d(t,e),t})({createWorldInfoEntry:()=>n.createWorldInfoEntry,wi_anchor_position:()=>n.wi_anchor_position,world_info_include_names:()=>n.world_info_include_names,world_names:()=>n.world_names});const de=(e=>{var t={};return p.d(t,e),t})({formatInstructModeExamples:()=>r.formatInstructModeExamples,formatInstructModeSystemPrompt:()=>r.formatInstructModeSystemPrompt});const pe=(e=>{var t={};return p.d(t,e),t})({appendFileContent:()=>o.appendFileContent});const he=(e=>{var t={};return p.d(t,e),t})({formatWorldInfo:()=>i.formatWorldInfo,getPromptPosition:()=>i.getPromptPosition,getPromptRole:()=>i.getPromptRole,prepareOpenAIMessages:()=>i.prepareOpenAIMessages,setOpenAIMessageExamples:()=>i.setOpenAIMessageExamples,setOpenAIMessages:()=>i.setOpenAIMessages});const fe=(e=>{var t={};return p.d(t,e),t})({metadata_keys:()=>s.metadata_keys});const me=(e=>{var t={};return p.d(t,e),t})({getGroupDepthPrompts:()=>a.getGroupDepthPrompts,selected_group:()=>a.selected_group});const ge=(e=>{var t={};return p.d(t,e),t})({getRegexedString:()=>c.getRegexedString,regex_placement:()=>c.regex_placement});(e=>{var t={};p.d(t,e)})({});(e=>{var t={};p.d(t,e)})({});async function ve(e,t,{escapeHtml:n=!0}={}){await async function(e,...t){await SillyTavern.getContext().SlashCommandParser.commands[e].callback(...t)}("echo",{severity:e,escapeHtml:Boolean(n).toString()},t)}function ye(e){return(0,le.getMaxContextSize)(e)}function xe(e,t){return(0,le.parseMesExamples)(e,t)}function be(e,t,n){return(0,le.baseChatReplace)(e,t,n)}function we(e){return(0,he.getPromptRole)(e)}function Ce(e,{wiFormat:t}={}){return(0,he.formatWorldInfo)(e,{wiFormat:t})}function Ee(e){return(0,he.getPromptPosition)(e)}function Se(e,t={}){const n=SillyTavern.getContext(),r=t.readOnlyValues||[],o=document.querySelector(e);if(!o)throw new Error(`Could not find preset select: ${e}`);const i=e=>t.label?t.label(e):e,s=document.createElement("div");s.className="preset-select-container",s.style.display="flex",s.style.alignItems="center";const a=e=>r.includes(e);if(o.parentNode?.insertBefore(s,o),s.appendChild(o),t.initialList&&t.initialList.length>0){o.innerHTML="";const e=e=>"string"==typeof e?e:e.value;for(const n of t.initialList){const t=document.createElement("option"),r=e(n);t.value=r,t.textContent=i(r),a(r)&&(t.dataset.readonly="true"),o.appendChild(t)}}if(t.initialValue){const e=Array.from(o.options).find((e=>e.value===t.initialValue));e&&(o.value=e.value)}let c=o.value;if(o.addEventListener("change",(async()=>{const e=o.value;t.onSelectChange&&c!==e&&await t.onSelectChange(c,e),c=e})),t.create){const e=document.createElement("i");e.className="menu_button fa-solid fa-file-circle-plus";const r=i("");e.title=`Create a new ${r}`,e.setAttribute("data-i18n",`[title]Create a new ${r}`),e.addEventListener("click",(async()=>{t.create?.onPopupOpen&&await t.create.onPopupOpen();const e=i(""),r=await n.Popup.show.input(`Create a new ${e}`,`Please enter a name for the new ${e}:`,"");if(null===r||""===r.trim())return;let s=r.trim();if(Array.from(o.options).some((e=>e.value===s)))return void await ve("warning",`A ${i(s)} with this name already exists.`);if(t.create?.onBeforeCreate){if(!await t.create.onBeforeCreate(s))return}if(t.create?.onAfterCreate){const e=await t.create.onAfterCreate(s);"string"==typeof e&&(s=e)}const a=document.createElement("option");a.value=s,a.textContent=i(s),o.appendChild(a);const l=o.value;o.value=s,t.onSelectChange&&l!==s&&await t.onSelectChange(l,s),c=s})),s.appendChild(e)}if(t.rename){const e=document.createElement("i");e.className="menu_button fa-solid fa-pencil";const r=i("");e.title=`Rename a ${r}`,e.setAttribute("data-i18n",`[title]Rename a ${r}`),e.addEventListener("click",(async()=>{if(-1===o.selectedIndex)return void await ve("warning",`Please select a ${i("")} to rename.`);const e=o.options[o.selectedIndex];let r=e.value;if(a(r))return void await ve("warning",`This ${i(r)} cannot be renamed as it is read-only.`);t.rename?.onPopupOpen&&await t.rename.onPopupOpen();const s=await n.Popup.show.input(`Rename ${i(r)}`,`Please enter a new name for "${r}":`,r);if(null===s||""===s.trim()||s===r)return;let l=s.trim();if(Array.from(o.options).some((t=>t.value===l&&t!==e)))await ve("warning",`A ${i(l)} with this name already exists.`);else{if(t.rename?.onBeforeRename){if(!await t.rename.onBeforeRename(r,l))return}if(t.rename?.onAfterRename){const e=await t.rename.onAfterRename(r,l);"string"==typeof e&&(l=e)}e.value=l,e.textContent=i(l),r===c&&(c=l),t.onSelectChange&&o.value===l&&await t.onSelectChange(r,l)}})),s.appendChild(e)}if(t.delete){const e=document.createElement("i");e.className="menu_button fa-solid fa-trash-can";const r=i("");e.title=`Delete a ${r}`,e.setAttribute("data-i18n",`[title]Delete a ${r}`),e.addEventListener("click",(async()=>{if(-1===o.selectedIndex)return void await ve("warning",`Please select a ${i("")} to delete.`);const e=o.options[o.selectedIndex],r=e.value,s=o.selectedIndex;if(a(r))return void await ve("warning",`This ${i(r)} cannot be deleted as it is read-only.`);t.delete?.onPopupOpen&&await t.delete.onPopupOpen();if(!await n.Popup.show.confirm(`Delete ${i(r)}`,`Are you sure you want to delete "${r}"?`))return;if(t.delete?.onBeforeDelete){if(!await t.delete.onBeforeDelete(r))return}const l=r;let u,d=-1;o.options.length>1&&(d=s<o.options.length-1?s:s-1,u=o.options[d].value),o.removeChild(e),d>=0?(o.selectedIndex=d,c=u,t.onSelectChange&&await t.onSelectChange(l,u)):(t.onSelectChange&&await t.onSelectChange(l,void 0),c=void 0),t.delete?.onAfterDelete&&await t.delete.onAfterDelete(l)})),s.appendChild(e)}return{select:o,container:s}}async function Ae(e,{targetCharacterId:t,presetName:n,instructName:r,contextName:o,syspromptName:i,maxContext:s,includeNames:a,ignoreCharacterFields:c,ignoreAuthorNote:l,ignoreWorldInfo:u,messageIndexesBetween:d}={}){if(!["textgenerationwebui","openai"].includes(e))throw new Error("Unsupported API");const p=SillyTavern.getContext();let h=[],{description:f,personality:m,persona:g,scenario:v,mesExamples:y,system:x,jailbreak:b}=c?{description:"",personality:"",persona:"",scenario:"",mesExamples:"",system:"",jailbreak:""}:p.getCharacterCardFields({chid:t});const w="textgenerationwebui"===e?p.getPresetManager("instruct")?.getCompletionPresetByName(r):void 0,C=!!w?.enabled;let E=xe(y,C);const S=function(){if("number"==typeof s)return s;if(!s)return ye();if("active"===s||!n)return ye();if("number"==typeof s)return s;let t;if("textgenerationwebui"===e){const e=p.getPresetManager("textgenerationwebui")?.getCompletionPresetByName(n);t=e?.max_length}else{const e=p.getPresetManager("openai")?.getCompletionPresetByName(n);t=e?.openai_max_context}return"number"==typeof t?t:ye()}();if(S<=0)return[];const A=p.ToolManager.isToolCallingSupported(),_=d?.start??0,P=d?.end?d.end+1:void 0;let k=-1===_&&0===P?[]:p.chat.slice(_,P).filter((e=>!e.is_system||A&&Array.isArray(e.extra?.tool_invocations)));k=await Promise.all(k.map((async(e,t)=>{let n=function(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:i,depth:s}){return(0,ge.getRegexedString)(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:i,depth:s})}(e.mes,e.is_user?ge.regex_placement.USER_INPUT:ge.regex_placement.AI_OUTPUT,{isPrompt:!0,depth:k.length-t-1});return n=await async function(e,t){return await(0,pe.appendFileContent)(e,t)}(e,n),e?.extra?.append_title&&e?.extra?.title&&(n=`${n}\n\n${e.extra.title}`),{...e,mes:n,index:t}})));const N=k.map((e=>ue.world_info_include_names?`${e.name}: ${e.mes}`:e.mes)).reverse(),{worldInfoString:T,worldInfoBefore:I,worldInfoAfter:D,worldInfoExamples:O,worldInfoDepth:F,anBefore:L,anAfter:M}=u?{worldInfoString:"",worldInfoBefore:"",worldInfoAfter:"",worldInfoExamples:[],worldInfoDepth:[],anBefore:[],anAfter:[]}:await p.getWorldInfoPrompt(N,S,!1);for(const U of O){const H=U.content;if(0===H.length)continue;const X=xe(be(H,le.name1,le.name2),C);U.position===ue.wi_anchor_position.before?E.unshift(...X):E.push(...X)}function j(){let e=0;const t=[];for(let n=k.length-1;n>=0;n--){const r=k[n];if(r.extra?.token_count&&e+r.extra.token_count>S)break;e+=r.extra?.token_count||0,t.unshift({role:r.is_user?"user":"assistant",content:a?`${r.name}: ${r.mes}`:r.mes})}h.push(...t)}if("textgenerationwebui"===e){const Y=[...E];E&&(E=function(e,t,n){return(0,de.formatInstructModeExamples)(e,t,n)}(E,le.name1,le.name2));const z=p.getPresetManager("sysprompt")?.getCompletionPresetByName(i);z&&(x=p.powerUserSettings.prefer_character_prompt&&x?x:be(z.content,le.name1,le.name2),x=C?(R=p.substituteParams(x,le.name1,le.name2,z.content),$=w,(0,de.formatInstructModeSystemPrompt)(R,$)):x);const J={description:f,personality:m,persona:p.powerUserSettings.persona_description_position==ce.persona_description_positions.IN_PROMPT?g:"",scenario:v,system:x,char:le.name2,user:le.name1,wiBefore:I,wiAfter:D,loreBefore:I,loreAfter:D,mesExamples:E.join(""),mesExamplesRaw:Y.join("")},K=p.getPresetManager("context")?.getCompletionPresetByName(o);let Z=function(e,{customStoryString:t,customInstructSettings:n}={}){return(0,ce.renderStoryString)(e,{customStoryString:t,customInstructSettings:n})}(J,{customInstructSettings:w,customStoryString:K?.story_string});h.push({role:"system",content:Z,ignoreInstruct:!0}),j()}else{let Q=(B=k,(0,he.setOpenAIMessages)(B)),ee=function(e){return(0,he.setOpenAIMessageExamples)(e)}(E);async function te(){let[e,t]=await function({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:i,bias:s,type:a,quietPrompt:c,quietImage:l,extensionPrompts:u,cyclePrompt:d,systemPromptOverride:p,jailbreakPromptOverride:h,personaDescription:f,messages:m,messageExamples:g},v){return(0,he.prepareOpenAIMessages)({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:i,bias:s,type:a,quietPrompt:c,quietImage:l,cyclePrompt:d,systemPromptOverride:p,jailbreakPromptOverride:h,personaDescription:f,extensionPrompts:u,messages:m,messageExamples:g},v)}({name2:le.name2,charDescription:f,charPersonality:m,Scenario:v,worldInfoBefore:I,worldInfoAfter:D,extensionPrompts:p.extensionPrompts,bias:"",type:"normal",quietPrompt:void 0,quietImage:void 0,cyclePrompt:"",systemPromptOverride:x,jailbreakPromptOverride:b,personaDescription:g,messages:Q,messageExamples:ee},!1);h.push(...e)}if(!n)return await te(),h;const ne=p.getPresetManager("openai")?.getCompletionPresetByName(n);if(!ne)return console.warn(`Preset not found: ${n}. Using current preset.`),te(),h;let re=ne.prompt_order.find((e=>e.character_id===le.this_chid));if(!re&&ne.prompt_order.length>0&&(re=ne.prompt_order[0]),!re)return console.warn(`No prompt order found for preset: ${n}. Using current preset.`),te(),h;const oe=v&&ne.scenario_format?p.substituteParams(ne.scenario_format):"",ie=m&&ne.personality_format?p.substituteParams(ne.personality_format):"",se=p.substituteParams(ne.group_nudge_prompt),ae=ne.impersonation_prompt?p.substituteParams(ne.impersonation_prompt):"",ve=[];u&&ve.push({role:"system",content:Ce(I,{wiFormat:ne.wi_format}),identifier:"worldInfoBefore"},{role:"system",content:Ce(D,{wiFormat:ne.wi_format}),identifier:"worldInfoAfter"}),c||ve.push({role:"system",content:f,identifier:"charDescription"},{role:"system",content:ie,identifier:"charPersonality"},{role:"system",content:oe,identifier:"scenario"}),ve.push({role:"system",content:ae,identifier:"impersonate"},{role:"system",content:se,identifier:"groupNudge"});const Se=p.extensionPrompts["1_memory"];Se&&Se.value&&ve.push({role:we(Se.role),content:Se.value,identifier:"summary",position:Ee(Se.position)});const Ae=p.extensionPrompts["2_floating_prompt"];!l&&Ae&&Ae.value&&ve.push({role:we(Ae.role),content:Ae.value,identifier:"authorsNote",position:Ee(Ae.position)});const _e=p.extensionPrompts["3_vectors"];_e&&_e.value&&ve.push({role:"system",content:_e.value,identifier:"vectorsMemory",position:Ee(_e.position)});const Pe=p.extensionPrompts["4_vectors_data_bank"];Pe&&Pe.value&&ve.push({role:we(Pe.role),content:Pe.value,identifier:"vectorsDataBank",position:Ee(Pe.position)});const ke=p.extensionPrompts.chromadb;ke&&ke.value&&ve.push({role:"system",content:ke.value,identifier:"smartContext",position:Ee(ke.position)}),!c&&p.powerUserSettings.persona_description&&p.powerUserSettings.persona_description_position===ce.persona_description_positions.IN_PROMPT&&ve.push({role:"system",content:p.powerUserSettings.persona_description,identifier:"personaDescription"}),re.order.forEach((e=>{if(!e.enabled)return;const t=(n=e.identifier,ve.find((e=>e.identifier===n)));var n;t&&t.content?h.push({role:t.role??"system",content:p.substituteParams(t.content)}):"chatHistory"===e.identifier&&j()}))}var B,R,$;const V=["1_memory","2_floating_prompt","3_vectors","4_vectors_data_bank","chromadb","PERSONA_DESCRIPTION","QUIET_PROMPT","DEPTH_PROMPT"];for(const Ne in p.extensionPrompts)if(Object.hasOwn(p.extensionPrompts,Ne)){const Te=p.extensionPrompts[Ne];if(V.includes(Ne))continue;if(!p.extensionPrompts[Ne].value)continue;if(![le.extension_prompt_types.BEFORE_PROMPT,le.extension_prompt_types.IN_PROMPT].includes(Te.position))continue;if("function"==typeof Te.filter&&!await Te.filter())continue;Te.position===le.extension_prompt_types.BEFORE_PROMPT?h=[...h.slice(0,Te.depth),{role:we(Te.role)??"system",content:Te.value},...h.slice(Te.depth)]:Te.position===le.extension_prompt_types.IN_PROMPT&&(h=[...h.slice(0,h.length-Te.depth),{role:we(Te.role)??"system",content:Te.value},...h.slice(h.length-Te.depth)])}for(const Ie of F)h=[...h.slice(0,h.length-Ie.depth),{role:we(Ie.role),content:Ie.entries.join("\n")},...h.slice(h.length-Ie.depth)];if(!c){const De=(q=me.selected_group,W=Number(le.this_chid),(0,me.getGroupDepthPrompts)(q,W));if(me.selected_group&&Array.isArray(De)&&De.length>0)De.filter((e=>e.text)).forEach(((e,t)=>{h=[...h.slice(0,h.length-e.depth),{role:e.role,content:e.text},...h.slice(h.length-e.depth)]}));else{const Oe=be(p.characters[le.this_chid]?.data?.extensions?.depth_prompt?.prompt?.trim(),le.name1,le.name2)||"";if(Oe){const Fe=le.depth_prompt_depth_default,Le=p.characters[le.this_chid]?.data?.extensions?.depth_prompt?.role??le.depth_prompt_role_default;h=[...h.slice(0,h.length-Fe),{role:we(Le),content:Oe},...h.slice(h.length-Fe)]}}}var q,W;let G=-1;if(!l){const Me={prompt:le.chat_metadata[fe.metadata_keys.prompt],interval:le.chat_metadata[fe.metadata_keys.interval],position:le.chat_metadata[fe.metadata_keys.position],depth:le.chat_metadata[fe.metadata_keys.depth],role:le.chat_metadata[fe.metadata_keys.role]};if(Me.prompt)switch(Me.prompt=be(Me.prompt,le.name1,le.name2),Me.position){case le.extension_prompt_types.IN_PROMPT:h=[...h.slice(0,1),{role:"user",content:Me.prompt},...h.slice(1)],G=1;break;case le.extension_prompt_types.IN_CHAT:h=[...h.slice(0,h.length-Me.depth),{role:we(Me.role),content:Me.prompt},...h.slice(h.length-Me.depth)],G=h.length-Me.depth-1;break;case le.extension_prompt_types.BEFORE_PROMPT:h.unshift({role:"user",content:Me.prompt}),G=0}}return G>=0&&(L.length>0&&(h=[...h.slice(0,G),{role:"system",content:L.join("\n")},...h.slice(G)],G++),M.length>0&&(h=[...h.slice(0,G+1),{role:"system",content:M.join("\n")},...h.slice(G+1)])),h}async function _e({entry:e,selectedWorldName:t,skipSave:n=!1,skipReload:r=!1,operation:o="auto"}){const i=SillyTavern.getContext(),s=await i.loadWorldInfo(t);if(!s)throw new Error("Failed to load world info");const a=Object.values(s.entries),c=a.length>0?a[a.length-1]:void 0;let l;if("update"===o||"auto"===o){const t=Object.values(s.entries).find((t=>t.uid===e.uid));if(t)("auto"===o||"update"===o)&&(l=t);else if("update"===o)throw new Error("Entry not found for update operation")}const u=l?"update":"add";if(!l){if(d=t,p=s,l=(0,ue.createWorldInfoEntry)(d,p),!l)throw new Error("Failed to create entry");if(c){const e=l.uid;Object.assign(l,c),l.uid=e}}var d,p;return l.key=e.key,l.content=e.content,l.comment=e.comment,n||await i.saveWorldInfo(t,s),r||i.reloadWorldInfoEditor(t,!0),{entry:l,operation:u}}var Pe,ke;!function(e){e[e.TEXT=1]="TEXT",e[e.CONFIRM=2]="CONFIRM",e[e.INPUT=3]="INPUT",e[e.DISPLAY=4]="DISPLAY"}(Pe||(Pe={})),function(e){e[e.AFFIRMATIVE=1]="AFFIRMATIVE",e[e.NEGATIVE=0]="NEGATIVE",e[e.CANCELLED=null]="CANCELLED"}(ke||(ke={}));const Ne=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",Te=new RegExp("^"+("["+Ne+"]["+(Ne+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040")+"]*")+"$");function Ie(e,t){const n=[];let r=t.exec(e);for(;r;){const o=[];o.startIndex=t.lastIndex-r[0].length;const i=r.length;for(let e=0;e<i;e++)o.push(r[e]);n.push(o),r=t.exec(e)}return n}const De=function(e){const t=Te.exec(e);return!(null==t)};const Oe={allowBooleanAttributes:!1,unpairedTags:[]};function Fe(e,t){t=Object.assign({},Oe,t);const n=[];let r=!1,o=!1;"\ufeff"===e[0]&&(e=e.substr(1));for(let i=0;i<e.length;i++)if("<"===e[i]&&"?"===e[i+1]){if(i+=2,i=Me(e,i),i.err)return i}else{if("<"!==e[i]){if(Le(e[i]))continue;return Ge("InvalidChar","char '"+e[i]+"' is not expected.",He(e,i))}{let s=i;if(i++,"!"===e[i]){i=je(e,i);continue}{let a=!1;"/"===e[i]&&(a=!0,i++);let c="";for(;i<e.length&&">"!==e[i]&&" "!==e[i]&&"\t"!==e[i]&&"\n"!==e[i]&&"\r"!==e[i];i++)c+=e[i];if(c=c.trim(),"/"===c[c.length-1]&&(c=c.substring(0,c.length-1),i--),!De(c)){let t;return t=0===c.trim().length?"Invalid space after '<'.":"Tag '"+c+"' is an invalid name.",Ge("InvalidTag",t,He(e,i))}const l=$e(e,i);if(!1===l)return Ge("InvalidAttr","Attributes for '"+c+"' have open quote.",He(e,i));let u=l.value;if(i=l.index,"/"===u[u.length-1]){const n=i-u.length;u=u.substring(0,u.length-1);const o=qe(u,t);if(!0!==o)return Ge(o.err.code,o.err.msg,He(e,n+o.err.line));r=!0}else if(a){if(!l.tagClosed)return Ge("InvalidTag","Closing tag '"+c+"' doesn't have proper closing.",He(e,i));if(u.trim().length>0)return Ge("InvalidTag","Closing tag '"+c+"' can't have attributes or invalid starting.",He(e,s));if(0===n.length)return Ge("InvalidTag","Closing tag '"+c+"' has not been opened.",He(e,s));{const t=n.pop();if(c!==t.tagName){let n=He(e,t.tagStartPos);return Ge("InvalidTag","Expected closing tag '"+t.tagName+"' (opened in line "+n.line+", col "+n.col+") instead of closing tag '"+c+"'.",He(e,s))}0==n.length&&(o=!0)}}else{const a=qe(u,t);if(!0!==a)return Ge(a.err.code,a.err.msg,He(e,i-u.length+a.err.line));if(!0===o)return Ge("InvalidXml","Multiple possible root nodes found.",He(e,i));-1!==t.unpairedTags.indexOf(c)||n.push({tagName:c,tagStartPos:s}),r=!0}for(i++;i<e.length;i++)if("<"===e[i]){if("!"===e[i+1]){i++,i=je(e,i);continue}if("?"!==e[i+1])break;if(i=Me(e,++i),i.err)return i}else if("&"===e[i]){const t=We(e,i);if(-1==t)return Ge("InvalidChar","char '&' is not expected.",He(e,i));i=t}else if(!0===o&&!Le(e[i]))return Ge("InvalidXml","Extra text at the end",He(e,i));"<"===e[i]&&i--}}}return r?1==n.length?Ge("InvalidTag","Unclosed tag '"+n[0].tagName+"'.",He(e,n[0].tagStartPos)):!(n.length>0)||Ge("InvalidXml","Invalid '"+JSON.stringify(n.map((e=>e.tagName)),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1}):Ge("InvalidXml","Start tag expected.",1)}function Le(e){return" "===e||"\t"===e||"\n"===e||"\r"===e}function Me(e,t){const n=t;for(;t<e.length;t++)if("?"!=e[t]&&" "!=e[t]);else{const r=e.substr(n,t-n);if(t>5&&"xml"===r)return Ge("InvalidXml","XML declaration allowed only at the start of the document.",He(e,t));if("?"==e[t]&&">"==e[t+1]){t++;break}}return t}function je(e,t){if(e.length>t+5&&"-"===e[t+1]&&"-"===e[t+2]){for(t+=3;t<e.length;t++)if("-"===e[t]&&"-"===e[t+1]&&">"===e[t+2]){t+=2;break}}else if(e.length>t+8&&"D"===e[t+1]&&"O"===e[t+2]&&"C"===e[t+3]&&"T"===e[t+4]&&"Y"===e[t+5]&&"P"===e[t+6]&&"E"===e[t+7]){let n=1;for(t+=8;t<e.length;t++)if("<"===e[t])n++;else if(">"===e[t]&&(n--,0===n))break}else if(e.length>t+9&&"["===e[t+1]&&"C"===e[t+2]&&"D"===e[t+3]&&"A"===e[t+4]&&"T"===e[t+5]&&"A"===e[t+6]&&"["===e[t+7])for(t+=8;t<e.length;t++)if("]"===e[t]&&"]"===e[t+1]&&">"===e[t+2]){t+=2;break}return t}const Be='"',Re="'";function $e(e,t){let n="",r="",o=!1;for(;t<e.length;t++){if(e[t]===Be||e[t]===Re)""===r?r=e[t]:r!==e[t]||(r="");else if(">"===e[t]&&""===r){o=!0;break}n+=e[t]}return""===r&&{value:n,index:t,tagClosed:o}}const Ve=new RegExp("(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['\"])(([\\s\\S])*?)\\5)?","g");function qe(e,t){const n=Ie(e,Ve),r={};for(let e=0;e<n.length;e++){if(0===n[e][1].length)return Ge("InvalidAttr","Attribute '"+n[e][2]+"' has no space in starting.",Xe(n[e]));if(void 0!==n[e][3]&&void 0===n[e][4])return Ge("InvalidAttr","Attribute '"+n[e][2]+"' is without value.",Xe(n[e]));if(void 0===n[e][3]&&!t.allowBooleanAttributes)return Ge("InvalidAttr","boolean attribute '"+n[e][2]+"' is not allowed.",Xe(n[e]));const o=n[e][2];if(!Ue(o))return Ge("InvalidAttr","Attribute '"+o+"' is an invalid name.",Xe(n[e]));if(r.hasOwnProperty(o))return Ge("InvalidAttr","Attribute '"+o+"' is repeated.",Xe(n[e]));r[o]=1}return!0}function We(e,t){if(";"===e[++t])return-1;if("#"===e[t])return function(e,t){let n=/\d/;for("x"===e[t]&&(t++,n=/[\da-fA-F]/);t<e.length;t++){if(";"===e[t])return t;if(!e[t].match(n))break}return-1}(e,++t);let n=0;for(;t<e.length;t++,n++)if(!(e[t].match(/\w/)&&n<20)){if(";"===e[t])break;return-1}return t}function Ge(e,t,n){return{err:{code:e,msg:t,line:n.line||n,col:n.col}}}function Ue(e){return De(e)}function He(e,t){const n=e.substring(0,t).split(/\r?\n/);return{line:n.length,col:n[n.length-1].length+1}}function Xe(e){return e.startIndex+e[1].length}const Ye={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(e,t,n){return e}};class ze{constructor(e){this.tagname=e,this.child=[],this[":@"]={}}add(e,t){"__proto__"===e&&(e="#__proto__"),this.child.push({[e]:t})}addChild(e){"__proto__"===e.tagname&&(e.tagname="#__proto__"),e[":@"]&&Object.keys(e[":@"]).length>0?this.child.push({[e.tagname]:e.child,":@":e[":@"]}):this.child.push({[e.tagname]:e.child})}}function Je(e,t){const n={};if("O"!==e[t+3]||"C"!==e[t+4]||"T"!==e[t+5]||"Y"!==e[t+6]||"P"!==e[t+7]||"E"!==e[t+8])throw new Error("Invalid Tag instead of DOCTYPE");{t+=9;let r=1,o=!1,i=!1,s="";for(;t<e.length;t++)if("<"!==e[t]||i)if(">"===e[t]){if(i?"-"===e[t-1]&&"-"===e[t-2]&&(i=!1,r--):r--,0===r)break}else"["===e[t]?o=!0:s+=e[t];else{if(o&&Qe(e,t)){let r,o;t+=7,[r,o,t]=Ke(e,t+1),-1===o.indexOf("&")&&(n[rt(r)]={regx:RegExp(`&${r};`,"g"),val:o})}else if(o&&et(e,t))t+=8;else if(o&&tt(e,t))t+=8;else if(o&&nt(e,t))t+=9;else{if(!Ze)throw new Error("Invalid DOCTYPE");i=!0}r++,s=""}if(0!==r)throw new Error("Unclosed DOCTYPE")}return{entities:n,i:t}}function Ke(e,t){let n="";for(;t<e.length&&"'"!==e[t]&&'"'!==e[t];t++)n+=e[t];if(n=n.trim(),-1!==n.indexOf(" "))throw new Error("External entites are not supported");const r=e[t++];let o="";for(;t<e.length&&e[t]!==r;t++)o+=e[t];return[n,o,t]}function Ze(e,t){return"!"===e[t+1]&&"-"===e[t+2]&&"-"===e[t+3]}function Qe(e,t){return"!"===e[t+1]&&"E"===e[t+2]&&"N"===e[t+3]&&"T"===e[t+4]&&"I"===e[t+5]&&"T"===e[t+6]&&"Y"===e[t+7]}function et(e,t){return"!"===e[t+1]&&"E"===e[t+2]&&"L"===e[t+3]&&"E"===e[t+4]&&"M"===e[t+5]&&"E"===e[t+6]&&"N"===e[t+7]&&"T"===e[t+8]}function tt(e,t){return"!"===e[t+1]&&"A"===e[t+2]&&"T"===e[t+3]&&"T"===e[t+4]&&"L"===e[t+5]&&"I"===e[t+6]&&"S"===e[t+7]&&"T"===e[t+8]}function nt(e,t){return"!"===e[t+1]&&"N"===e[t+2]&&"O"===e[t+3]&&"T"===e[t+4]&&"A"===e[t+5]&&"T"===e[t+6]&&"I"===e[t+7]&&"O"===e[t+8]&&"N"===e[t+9]}function rt(e){if(De(e))return e;throw new Error(`Invalid entity name ${e}`)}const ot=/^[-+]?0x[a-fA-F0-9]+$/,it=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,st={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function at(e,t={}){if(t=Object.assign({},st,t),!e||"string"!=typeof e)return e;let n=e.trim();if(void 0!==t.skipLike&&t.skipLike.test(n))return e;if("0"===e)return 0;if(t.hex&&ot.test(n))return function(e,t){if(parseInt)return parseInt(e,t);if(Number.parseInt)return Number.parseInt(e,t);if(window&&window.parseInt)return window.parseInt(e,t);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}(n,16);if(-1!==n.search(/[eE]/)){const r=n.match(/^([-\+])?(0*)([0-9]*(\.[0-9]*)?[eE][-\+]?[0-9]+)$/);if(r){if(t.leadingZeros)n=(r[1]||"")+r[3];else if("0"!==r[2]||"."!==r[3][0])return e;return t.eNotation?Number(n):e}return e}{const r=it.exec(n);if(r){const o=r[1],i=r[2];let s=function(e){if(e&&-1!==e.indexOf("."))return"."===(e=e.replace(/0+$/,""))?e="0":"."===e[0]?e="0"+e:"."===e[e.length-1]&&(e=e.substr(0,e.length-1)),e;return e}(r[3]);if(!t.leadingZeros&&i.length>0&&o&&"."!==n[2])return e;if(!t.leadingZeros&&i.length>0&&!o&&"."!==n[1])return e;if(t.leadingZeros&&i===e)return 0;{const r=Number(n),a=""+r;return-1!==a.search(/[eE]/)?t.eNotation?r:e:-1!==n.indexOf(".")?"0"===a&&""===s||a===s||o&&a==="-"+s?r:e:i?s===a||o+s===a?r:e:n===a||n===o+a?r:e}}return e}}function ct(e){return"function"==typeof e?e:Array.isArray(e)?t=>{for(const n of e){if("string"==typeof n&&t===n)return!0;if(n instanceof RegExp&&n.test(t))return!0}}:()=>!1}class lt{constructor(e){this.options=e,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(e,t)=>String.fromCodePoint(Number.parseInt(t,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(e,t)=>String.fromCodePoint(Number.parseInt(t,16))}},this.addExternalEntities=ut,this.parseXml=mt,this.parseTextData=dt,this.resolveNameSpace=pt,this.buildAttributesMap=ft,this.isItStopNode=xt,this.replaceEntitiesValue=vt,this.readStopNodeData=Ct,this.saveTextToParentTag=yt,this.addChild=gt,this.ignoreAttributesFn=ct(this.options.ignoreAttributes)}}function ut(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];this.lastEntities[r]={regex:new RegExp("&"+r+";","g"),val:e[r]}}}function dt(e,t,n,r,o,i,s){if(void 0!==e&&(this.options.trimValues&&!r&&(e=e.trim()),e.length>0)){s||(e=this.replaceEntitiesValue(e));const r=this.options.tagValueProcessor(t,e,n,o,i);if(null==r)return e;if(typeof r!=typeof e||r!==e)return r;if(this.options.trimValues)return Et(e,this.options.parseTagValue,this.options.numberParseOptions);return e.trim()===e?Et(e,this.options.parseTagValue,this.options.numberParseOptions):e}}function pt(e){if(this.options.removeNSPrefix){const t=e.split(":"),n="/"===e.charAt(0)?"/":"";if("xmlns"===t[0])return"";2===t.length&&(e=n+t[1])}return e}const ht=new RegExp("([^\\s=]+)\\s*(=\\s*(['\"])([\\s\\S]*?)\\3)?","gm");function ft(e,t,n){if(!0!==this.options.ignoreAttributes&&"string"==typeof e){const n=Ie(e,ht),r=n.length,o={};for(let e=0;e<r;e++){const r=this.resolveNameSpace(n[e][1]);if(this.ignoreAttributesFn(r,t))continue;let i=n[e][4],s=this.options.attributeNamePrefix+r;if(r.length)if(this.options.transformAttributeName&&(s=this.options.transformAttributeName(s)),"__proto__"===s&&(s="#__proto__"),void 0!==i){this.options.trimValues&&(i=i.trim()),i=this.replaceEntitiesValue(i);const e=this.options.attributeValueProcessor(r,i,t);o[s]=null==e?i:typeof e!=typeof i||e!==i?e:Et(i,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(o[s]=!0)}if(!Object.keys(o).length)return;if(this.options.attributesGroupName){const e={};return e[this.options.attributesGroupName]=o,e}return o}}const mt=function(e){e=e.replace(/\r\n?/g,"\n");const t=new ze("!xml");let n=t,r="",o="";for(let i=0;i<e.length;i++){if("<"===e[i])if("/"===e[i+1]){const t=bt(e,">",i,"Closing Tag is not closed.");let s=e.substring(i+2,t).trim();if(this.options.removeNSPrefix){const e=s.indexOf(":");-1!==e&&(s=s.substr(e+1))}this.options.transformTagName&&(s=this.options.transformTagName(s)),n&&(r=this.saveTextToParentTag(r,n,o));const a=o.substring(o.lastIndexOf(".")+1);if(s&&-1!==this.options.unpairedTags.indexOf(s))throw new Error(`Unpaired tag can not be used as closing tag: </${s}>`);let c=0;a&&-1!==this.options.unpairedTags.indexOf(a)?(c=o.lastIndexOf(".",o.lastIndexOf(".")-1),this.tagsNodeStack.pop()):c=o.lastIndexOf("."),o=o.substring(0,c),n=this.tagsNodeStack.pop(),r="",i=t}else if("?"===e[i+1]){let t=wt(e,i,!1,"?>");if(!t)throw new Error("Pi Tag is not closed.");if(r=this.saveTextToParentTag(r,n,o),this.options.ignoreDeclaration&&"?xml"===t.tagName||this.options.ignorePiTags);else{const e=new ze(t.tagName);e.add(this.options.textNodeName,""),t.tagName!==t.tagExp&&t.attrExpPresent&&(e[":@"]=this.buildAttributesMap(t.tagExp,o,t.tagName)),this.addChild(n,e,o)}i=t.closeIndex+1}else if("!--"===e.substr(i+1,3)){const t=bt(e,"--\x3e",i+4,"Comment is not closed.");if(this.options.commentPropName){const s=e.substring(i+4,t-2);r=this.saveTextToParentTag(r,n,o),n.add(this.options.commentPropName,[{[this.options.textNodeName]:s}])}i=t}else if("!D"===e.substr(i+1,2)){const t=Je(e,i);this.docTypeEntities=t.entities,i=t.i}else if("!["===e.substr(i+1,2)){const t=bt(e,"]]>",i,"CDATA is not closed.")-2,s=e.substring(i+9,t);r=this.saveTextToParentTag(r,n,o);let a=this.parseTextData(s,n.tagname,o,!0,!1,!0,!0);null==a&&(a=""),this.options.cdataPropName?n.add(this.options.cdataPropName,[{[this.options.textNodeName]:s}]):n.add(this.options.textNodeName,a),i=t+2}else{let s=wt(e,i,this.options.removeNSPrefix),a=s.tagName;const c=s.rawTagName;let l=s.tagExp,u=s.attrExpPresent,d=s.closeIndex;this.options.transformTagName&&(a=this.options.transformTagName(a)),n&&r&&"!xml"!==n.tagname&&(r=this.saveTextToParentTag(r,n,o,!1));const p=n;if(p&&-1!==this.options.unpairedTags.indexOf(p.tagname)&&(n=this.tagsNodeStack.pop(),o=o.substring(0,o.lastIndexOf("."))),a!==t.tagname&&(o+=o?"."+a:a),this.isItStopNode(this.options.stopNodes,o,a)){let t="";if(l.length>0&&l.lastIndexOf("/")===l.length-1)"/"===a[a.length-1]?(a=a.substr(0,a.length-1),o=o.substr(0,o.length-1),l=a):l=l.substr(0,l.length-1),i=s.closeIndex;else if(-1!==this.options.unpairedTags.indexOf(a))i=s.closeIndex;else{const n=this.readStopNodeData(e,c,d+1);if(!n)throw new Error(`Unexpected end of ${c}`);i=n.i,t=n.tagContent}const r=new ze(a);a!==l&&u&&(r[":@"]=this.buildAttributesMap(l,o,a)),t&&(t=this.parseTextData(t,a,o,!0,u,!0,!0)),o=o.substr(0,o.lastIndexOf(".")),r.add(this.options.textNodeName,t),this.addChild(n,r,o)}else{if(l.length>0&&l.lastIndexOf("/")===l.length-1){"/"===a[a.length-1]?(a=a.substr(0,a.length-1),o=o.substr(0,o.length-1),l=a):l=l.substr(0,l.length-1),this.options.transformTagName&&(a=this.options.transformTagName(a));const e=new ze(a);a!==l&&u&&(e[":@"]=this.buildAttributesMap(l,o,a)),this.addChild(n,e,o),o=o.substr(0,o.lastIndexOf("."))}else{const e=new ze(a);this.tagsNodeStack.push(n),a!==l&&u&&(e[":@"]=this.buildAttributesMap(l,o,a)),this.addChild(n,e,o),n=e}r="",i=d}}else r+=e[i]}return t.child};function gt(e,t,n){const r=this.options.updateTag(t.tagname,n,t[":@"]);!1===r||("string"==typeof r?(t.tagname=r,e.addChild(t)):e.addChild(t))}const vt=function(e){if(this.options.processEntities){for(let t in this.docTypeEntities){const n=this.docTypeEntities[t];e=e.replace(n.regx,n.val)}for(let t in this.lastEntities){const n=this.lastEntities[t];e=e.replace(n.regex,n.val)}if(this.options.htmlEntities)for(let t in this.htmlEntities){const n=this.htmlEntities[t];e=e.replace(n.regex,n.val)}e=e.replace(this.ampEntity.regex,this.ampEntity.val)}return e};function yt(e,t,n,r){return e&&(void 0===r&&(r=0===t.child.length),void 0!==(e=this.parseTextData(e,t.tagname,n,!1,!!t[":@"]&&0!==Object.keys(t[":@"]).length,r))&&""!==e&&t.add(this.options.textNodeName,e),e=""),e}function xt(e,t,n){const r="*."+n;for(const n in e){const o=e[n];if(r===o||t===o)return!0}return!1}function bt(e,t,n,r){const o=e.indexOf(t,n);if(-1===o)throw new Error(r);return o+t.length-1}function wt(e,t,n,r=">"){const o=function(e,t,n=">"){let r,o="";for(let i=t;i<e.length;i++){let t=e[i];if(r)t===r&&(r="");else if('"'===t||"'"===t)r=t;else if(t===n[0]){if(!n[1])return{data:o,index:i};if(e[i+1]===n[1])return{data:o,index:i}}else"\t"===t&&(t=" ");o+=t}}(e,t+1,r);if(!o)return;let i=o.data;const s=o.index,a=i.search(/\s/);let c=i,l=!0;-1!==a&&(c=i.substring(0,a),i=i.substring(a+1).trimStart());const u=c;if(n){const e=c.indexOf(":");-1!==e&&(c=c.substr(e+1),l=c!==o.data.substr(e+1))}return{tagName:c,tagExp:i,closeIndex:s,attrExpPresent:l,rawTagName:u}}function Ct(e,t,n){const r=n;let o=1;for(;n<e.length;n++)if("<"===e[n])if("/"===e[n+1]){const i=bt(e,">",n,`${t} is not closed`);if(e.substring(n+2,i).trim()===t&&(o--,0===o))return{tagContent:e.substring(r,n),i};n=i}else if("?"===e[n+1]){n=bt(e,"?>",n+1,"StopNode is not closed.")}else if("!--"===e.substr(n+1,3)){n=bt(e,"--\x3e",n+3,"StopNode is not closed.")}else if("!["===e.substr(n+1,2)){n=bt(e,"]]>",n,"StopNode is not closed.")-2}else{const r=wt(e,n,">");if(r){(r&&r.tagName)===t&&"/"!==r.tagExp[r.tagExp.length-1]&&o++,n=r.closeIndex}}}function Et(e,t,n){if(t&&"string"==typeof e){const t=e.trim();return"true"===t||"false"!==t&&at(e,n)}return void 0!==e?e:""}function St(e,t){return At(e,t)}function At(e,t,n){let r;const o={};for(let i=0;i<e.length;i++){const s=e[i],a=_t(s);let c="";if(c=void 0===n?a:n+"."+a,a===t.textNodeName)void 0===r?r=s[a]:r+=""+s[a];else{if(void 0===a)continue;if(s[a]){let e=At(s[a],t,c);const n=kt(e,t);s[":@"]?Pt(e,s[":@"],c,t):1!==Object.keys(e).length||void 0===e[t.textNodeName]||t.alwaysCreateTextNode?0===Object.keys(e).length&&(t.alwaysCreateTextNode?e[t.textNodeName]="":e=""):e=e[t.textNodeName],void 0!==o[a]&&o.hasOwnProperty(a)?(Array.isArray(o[a])||(o[a]=[o[a]]),o[a].push(e)):t.isArray(a,c,n)?o[a]=[e]:o[a]=e}}}return"string"==typeof r?r.length>0&&(o[t.textNodeName]=r):void 0!==r&&(o[t.textNodeName]=r),o}function _t(e){const t=Object.keys(e);for(let e=0;e<t.length;e++){const n=t[e];if(":@"!==n)return n}}function Pt(e,t,n,r){if(t){const o=Object.keys(t),i=o.length;for(let s=0;s<i;s++){const i=o[s];r.isArray(i,n+"."+i,!0,!0)?e[i]=[t[i]]:e[i]=t[i]}}}function kt(e,t){const{textNodeName:n}=t,r=Object.keys(e).length;return 0===r||!(1!==r||!e[n]&&"boolean"!=typeof e[n]&&0!==e[n])}function Nt(e,t){let n="";return t.format&&t.indentBy.length>0&&(n="\n"),Tt(e,t,"",n)}function Tt(e,t,n,r){let o="",i=!1;for(let s=0;s<e.length;s++){const a=e[s],c=It(a);if(void 0===c)continue;let l="";if(l=0===n.length?c:`${n}.${c}`,c===t.textNodeName){let e=a[c];Ot(l,t)||(e=t.tagValueProcessor(c,e),e=Ft(e,t)),i&&(o+=r),o+=e,i=!1;continue}if(c===t.cdataPropName){i&&(o+=r),o+=`<![CDATA[${a[c][0][t.textNodeName]}]]>`,i=!1;continue}if(c===t.commentPropName){o+=r+`\x3c!--${a[c][0][t.textNodeName]}--\x3e`,i=!0;continue}if("?"===c[0]){const e=Dt(a[":@"],t),n="?xml"===c?"":r;let s=a[c][0][t.textNodeName];s=0!==s.length?" "+s:"",o+=n+`<${c}${s}${e}?>`,i=!0;continue}let u=r;""!==u&&(u+=t.indentBy);const d=r+`<${c}${Dt(a[":@"],t)}`,p=Tt(a[c],t,l,u);-1!==t.unpairedTags.indexOf(c)?t.suppressUnpairedNode?o+=d+">":o+=d+"/>":p&&0!==p.length||!t.suppressEmptyNode?p&&p.endsWith(">")?o+=d+`>${p}${r}</${c}>`:(o+=d+">",p&&""!==r&&(p.includes("/>")||p.includes("</"))?o+=r+t.indentBy+p+r:o+=p,o+=`</${c}>`):o+=d+"/>",i=!0}return o}function It(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];if(e.hasOwnProperty(r)&&":@"!==r)return r}}function Dt(e,t){let n="";if(e&&!t.ignoreAttributes)for(let r in e){if(!e.hasOwnProperty(r))continue;let o=t.attributeValueProcessor(r,e[r]);o=Ft(o,t),!0===o&&t.suppressBooleanAttributes?n+=` ${r.substr(t.attributeNamePrefix.length)}`:n+=` ${r.substr(t.attributeNamePrefix.length)}="${o}"`}return n}function Ot(e,t){let n=(e=e.substr(0,e.length-t.textNodeName.length-1)).substr(e.lastIndexOf(".")+1);for(let r in t.stopNodes)if(t.stopNodes[r]===e||t.stopNodes[r]==="*."+n)return!0;return!1}function Ft(e,t){if(e&&e.length>0&&t.processEntities)for(let n=0;n<t.entities.length;n++){const r=t.entities[n];e=e.replace(r.regex,r.val)}return e}const Lt={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],oneListGroup:!1};function Mt(e){this.options=Object.assign({},Lt,e),!0===this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.ignoreAttributesFn=ct(this.options.ignoreAttributes),this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=Rt),this.processTextOrObjNode=jt,this.options.format?(this.indentate=Bt,this.tagEndChar=">\n",this.newLine="\n"):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine="")}function jt(e,t,n,r){const o=this.j2x(e,n+1,r.concat(t));return void 0!==e[this.options.textNodeName]&&1===Object.keys(e).length?this.buildTextValNode(e[this.options.textNodeName],t,o.attrStr,n):this.buildObjectNode(o.val,t,o.attrStr,n)}function Bt(e){return this.options.indentBy.repeat(e)}function Rt(e){return!(!e.startsWith(this.options.attributeNamePrefix)||e===this.options.textNodeName)&&e.substr(this.attrPrefixLen)}Mt.prototype.build=function(e){return this.options.preserveOrder?Nt(e,this.options):(Array.isArray(e)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1&&(e={[this.options.arrayNodeName]:e}),this.j2x(e,0,[]).val)},Mt.prototype.j2x=function(e,t,n){let r="",o="";const i=n.join(".");for(let s in e)if(Object.prototype.hasOwnProperty.call(e,s))if(void 0===e[s])this.isAttribute(s)&&(o+="");else if(null===e[s])this.isAttribute(s)||s===this.options.cdataPropName?o+="":"?"===s[0]?o+=this.indentate(t)+"<"+s+"?"+this.tagEndChar:o+=this.indentate(t)+"<"+s+"/"+this.tagEndChar;else if(e[s]instanceof Date)o+=this.buildTextValNode(e[s],s,"",t);else if("object"!=typeof e[s]){const n=this.isAttribute(s);if(n&&!this.ignoreAttributesFn(n,i))r+=this.buildAttrPairStr(n,""+e[s]);else if(!n)if(s===this.options.textNodeName){let t=this.options.tagValueProcessor(s,""+e[s]);o+=this.replaceEntitiesValue(t)}else o+=this.buildTextValNode(e[s],s,"",t)}else if(Array.isArray(e[s])){const r=e[s].length;let i="",a="";for(let c=0;c<r;c++){const r=e[s][c];if(void 0===r);else if(null===r)"?"===s[0]?o+=this.indentate(t)+"<"+s+"?"+this.tagEndChar:o+=this.indentate(t)+"<"+s+"/"+this.tagEndChar;else if("object"==typeof r)if(this.options.oneListGroup){const e=this.j2x(r,t+1,n.concat(s));i+=e.val,this.options.attributesGroupName&&r.hasOwnProperty(this.options.attributesGroupName)&&(a+=e.attrStr)}else i+=this.processTextOrObjNode(r,s,t,n);else if(this.options.oneListGroup){let e=this.options.tagValueProcessor(s,r);e=this.replaceEntitiesValue(e),i+=e}else i+=this.buildTextValNode(r,s,"",t)}this.options.oneListGroup&&(i=this.buildObjectNode(i,s,a,t)),o+=i}else if(this.options.attributesGroupName&&s===this.options.attributesGroupName){const t=Object.keys(e[s]),n=t.length;for(let o=0;o<n;o++)r+=this.buildAttrPairStr(t[o],""+e[s][t[o]])}else o+=this.processTextOrObjNode(e[s],s,t,n);return{attrStr:r,val:o}},Mt.prototype.buildAttrPairStr=function(e,t){return t=this.options.attributeValueProcessor(e,""+t),t=this.replaceEntitiesValue(t),this.options.suppressBooleanAttributes&&"true"===t?" "+e:" "+e+'="'+t+'"'},Mt.prototype.buildObjectNode=function(e,t,n,r){if(""===e)return"?"===t[0]?this.indentate(r)+"<"+t+n+"?"+this.tagEndChar:this.indentate(r)+"<"+t+n+this.closeTag(t)+this.tagEndChar;{let o="</"+t+this.tagEndChar,i="";return"?"===t[0]&&(i="?",o=""),!n&&""!==n||-1!==e.indexOf("<")?!1!==this.options.commentPropName&&t===this.options.commentPropName&&0===i.length?this.indentate(r)+`\x3c!--${e}--\x3e`+this.newLine:this.indentate(r)+"<"+t+n+i+this.tagEndChar+e+this.indentate(r)+o:this.indentate(r)+"<"+t+n+i+">"+e+o}},Mt.prototype.closeTag=function(e){let t="";return-1!==this.options.unpairedTags.indexOf(e)?this.options.suppressUnpairedNode||(t="/"):t=this.options.suppressEmptyNode?"/":`></${e}`,t},Mt.prototype.buildTextValNode=function(e,t,n,r){if(!1!==this.options.cdataPropName&&t===this.options.cdataPropName)return this.indentate(r)+`<![CDATA[${e}]]>`+this.newLine;if(!1!==this.options.commentPropName&&t===this.options.commentPropName)return this.indentate(r)+`\x3c!--${e}--\x3e`+this.newLine;if("?"===t[0])return this.indentate(r)+"<"+t+n+"?"+this.tagEndChar;{let o=this.options.tagValueProcessor(t,e);return o=this.replaceEntitiesValue(o),""===o?this.indentate(r)+"<"+t+n+this.closeTag(t)+this.tagEndChar:this.indentate(r)+"<"+t+n+">"+o+"</"+t+this.tagEndChar}},Mt.prototype.replaceEntitiesValue=function(e){if(e&&e.length>0&&this.options.processEntities)for(let t=0;t<this.options.entities.length;t++){const n=this.options.entities[t];e=e.replace(n.regex,n.val)}return e};var $t=new class{constructor(e){this.externalEntities={},this.options=function(e){return Object.assign({},Ye,e)}(e)}parse(e,t){if("string"==typeof e);else{if(!e.toString)throw new Error("XML data is accepted in String or Bytes[] form.");e=e.toString()}if(t){!0===t&&(t={});const n=Fe(e,t);if(!0!==n)throw Error(`${n.err.msg}:${n.err.line}:${n.err.col}`)}const n=new lt(this.options);n.addExternalEntities(this.externalEntities);const r=n.parseXml(e);return this.options.preserveOrder||void 0===r?r:St(r,this.options)}addEntity(e,t){if(-1!==t.indexOf("&"))throw new Error("Entity value can't have '&'");if(-1!==e.indexOf("&")||-1!==e.indexOf(";"))throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if("&"===t)throw new Error("An entity with value '&' is not permitted");this.externalEntities[e]=t}}({ignoreAttributes:!1,allowBooleanAttributes:!0});function Vt(e,t){var n,r,o,i,s=e.match(/```(?:\w+\n|\n)([\s\S]*?)```/),a=s?s[1].trim():e.trim();try{switch(t){case"xml":var c=$t.parse(a),l=null!==(n=null!==(r=null==c?void 0:c.response)&&void 0!==r?r:null==c||null===(o=c.root)||void 0===o?void 0:o.response)&&void 0!==n?n:null==c||null===(i=c.data)||void 0===i?void 0:i.response;if("string"==typeof l)return l.trim();if(l&&"string"==typeof l["#text"])return l["#text"].trim();if(c&&Object.keys(c).length>0){var u=Object.values(c)[0];if("string"==typeof u)return u.trim();if("string"==typeof(null==u?void 0:u["#text"]))return u["#text"].trim()}throw new Error("Invalid XML format: <response> tag content not found or not a string.");case"json":var d=JSON.parse(a);if(d&&"string"==typeof d.response)return d.response.trim();if(null!=d&&d.response&&Object.keys(d.response).length>0)return String(Object.values(d.response)[0]).trim();if(d&&Object.keys(d).length>0)return String(Object.values(d)[0]).trim();throw new Error('Invalid JSON format: "response" key not found or its value is not a string.');case"none":return a;default:throw new Error("Unsupported format specified: ".concat(t))}}catch(n){throw console.error("Error parsing response in format '".concat(t,"':"),n),console.error("Raw content received:",e),"xml"===t&&n.message.includes("Invalid XML")?new Error("Model response is not valid XML or does not contain the <response> tag."):"json"===t&&n instanceof SyntaxError?new Error('Model response is not valid JSON or does not follow the {"response": "..."} structure.'):new Error("Failed to parse response as ".concat(t,": ").concat(n.message))}}const qt=(e=>{var t={};return p.d(t,e),t})({Handlebars:()=>d.Handlebars});function Wt(e){return Wt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Wt(e)}function Gt(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */Gt=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},i="function"==typeof Symbol?Symbol:{},s=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var i=t&&t.prototype instanceof v?t:v,s=Object.create(i.prototype),a=new T(r||[]);return o(s,"_invoke",{value:_(e,n,a)}),s}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var p="suspendedStart",h="suspendedYield",f="executing",m="completed",g={};function v(){}function y(){}function x(){}var b={};l(b,s,(function(){return this}));var w=Object.getPrototypeOf,C=w&&w(w(I([])));C&&C!==n&&r.call(C,s)&&(b=C);var E=x.prototype=v.prototype=Object.create(b);function S(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function A(e,t){function n(o,i,s,a){var c=d(e[o],e,i);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==Wt(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,s,a)}),(function(e){n("throw",e,s,a)})):t.resolve(u).then((function(e){l.value=e,s(l)}),(function(e){return n("throw",e,s,a)}))}a(c.arg)}var i;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return i=i?i.then(o,o):o()}})}function _(t,n,r){var o=p;return function(i,s){if(o===f)throw Error("Generator is already running");if(o===m){if("throw"===i)throw s;return{value:e,done:!0}}for(r.method=i,r.arg=s;;){var a=r.delegate;if(a){var c=P(a,r);if(c){if(c===g)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===p)throw o=m,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=f;var l=d(t,n,r);if("normal"===l.type){if(o=r.done?m:h,l.arg===g)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o=m,r.method="throw",r.arg=l.arg)}}}function P(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,P(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var i=d(o,t.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,g;var s=i.arg;return s?s.done?(n[t.resultName]=s.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):s:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function N(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function I(t){if(t||""===t){var n=t[s];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,i=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return i.next=i}}throw new TypeError(Wt(t)+" is not iterable")}return y.prototype=x,o(E,"constructor",{value:x,configurable:!0}),o(x,"constructor",{value:y,configurable:!0}),y.displayName=l(x,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,x):(e.__proto__=x,l(e,c,"GeneratorFunction")),e.prototype=Object.create(E),e},t.awrap=function(e){return{__await:e}},S(A.prototype),l(A.prototype,a,(function(){return this})),t.AsyncIterator=A,t.async=function(e,n,r,o,i){void 0===i&&(i=Promise);var s=new A(u(e,n,r,o),i);return t.isGeneratorFunction(n)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},S(E),l(E,c,"Generator"),l(E,s,(function(){return this})),l(E,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=I,T.prototype={constructor:T,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(N),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return a.type="throw",a.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i],a=s.completion;if("root"===s.tryLoc)return o("end");if(s.tryLoc<=this.prev){var c=r.call(s,"catchLoc"),l=r.call(s,"finallyLoc");if(c&&l){if(this.prev<s.catchLoc)return o(s.catchLoc,!0);if(this.prev<s.finallyLoc)return o(s.finallyLoc)}else if(c){if(this.prev<s.catchLoc)return o(s.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return o(s.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var s=i?i.completion:{};return s.type=e,s.arg=t,i?(this.method="next",this.next=i.finallyLoc,g):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),N(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;N(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:I(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),g}},t}function Ut(e){return function(e){if(Array.isArray(e))return Yt(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||Xt(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ht(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,i,s,a=[],c=!0,l=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=i.call(n)).done)&&(a.push(r.value),a.length!==t);c=!0);}catch(e){l=!0,o=e}finally{try{if(!c&&null!=n.return&&(s=n.return(),Object(s)!==s))return}finally{if(l)throw o}}return a}}(e,t)||Xt(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Xt(e,t){if(e){if("string"==typeof e)return Yt(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Yt(e,t):void 0}}function Yt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function zt(e,t,n,r,o,i,s){try{var a=e[i](s),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,o)}var Jt=SillyTavern.getContext(),Kt=["name","description","personality","scenario","first_mes","mes_example"];new m("dumb",{}).getSettings();function Zt(e){return Qt.apply(this,arguments)}function Qt(){var e;return e=Gt().mark((function e(t){var n,r,o,i,s,a,c,l,u,d,p,h,f,m,g,v,y,x,b,w,C,E,S,A,_,P,k,N,T,I,D,O,F,L,M,j,B,R;return Gt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.profileId,o=t.userPrompt,i=t.buildPromptOptions,s=t.contextToSend,a=t.session,c=t.allCharacters,l=t.entriesGroupByWorldName,u=t.promptSettings,d=t.formatDescription,p=t.mainContextTemplate,h=t.maxResponseToken,f=t.targetField,m=t.outputFormat,r){e.next=3;break}throw new Error("No connection profile selected.");case 3:if(g=null===(n=Jt.extensionSettings.connectionManager)||void 0===n||null===(n=n.profiles)||void 0===n?void 0:n.find((function(e){return e.id===r}))){e.next=6;break}throw new Error('Connection profile with ID "'.concat(r,'" not found.'));case 6:if(v=Jt.substituteParams(o.trim()),y=g.api?Jt.CONNECT_API_MAP[g.api].selected:void 0){e.next=10;break}throw new Error('Could not determine API for profile "'.concat(g.name,'".'));case 10:return x={},e.next=13,Ae(y,i);case 13:if(b=e.sent,s.stDescription&&(x.stDescription=u.stCharCard.content),!(s.charCard&&a.selectedCharacterIndexes.length>0)){e.next=27;break}e.prev=16,w=qt.Handlebars.compile(u.charDefinition.content,{noEscape:!0}),C=[],a.selectedCharacterIndexes.forEach((function(e){var t=parseInt(e),n=c[t];n&&C.push(n)})),C.length>0&&(E=w({characters:C}))&&(x.charDefinitions=E),e.next=27;break;case 23:throw e.prev=23,e.t0=e.catch(16),console.error("Error compiling or executing Handlebars template for character definitions:",e.t0),new Error("Error compiling or executing Handlebars template for character definitions: ".concat(e.t0.message));case 27:if(!(s.worldInfo&&a.selectedWorldNames.length>0)){e.next=39;break}e.prev=28,S=qt.Handlebars.compile(u.lorebookDefinition.content,{noEscape:!0}),A={},Object.entries(l).filter((function(e){var t=Ht(e,2),n=t[0],r=t[1];return r.length>0&&a.selectedWorldNames.includes(n)&&r.some((function(e){return!e.disable}))})).forEach((function(e){var t=Ht(e,2),n=t[0],r=t[1];A[n]=r.filter((function(e){return!e.disable}))})),Object.keys(A).length>0&&(_=S({lorebooks:A}))&&(x.lorebookDefinitions=_),e.next=39;break;case 35:throw e.prev=35,e.t1=e.catch(28),console.error("Error compiling or executing Handlebars template for lorebook definitions:",e.t1),new Error("Error compiling or executing Handlebars template for lorebook definitions: ".concat(e.t1.message));case 39:for(s.existingFields&&a.fields&&Object.keys(a.fields).length>0&&(P=qt.Handlebars.compile(u.existingFieldsDefinition.content,{noEscape:!0}),k=Object.fromEntries(Object.entries(a.fields).map((function(e){var t=Ht(e,2);return[t[0],t[1].value]}))),(N=P({fields:k}))&&(x.existingFields=N)),x.outputFormatInstructions=d.content,T=qt.Handlebars.compile(u.taskDescription.content,{noEscape:!0}),(I=T({userInstructions:v,fieldSpecificInstructions:a.fields[f].prompt,targetField:f}))&&(x.taskDescription=I),D=[],O=p.split("[CREC_NEXT_MESSAGE]"),F=0;F<O.length;F++)(L=O[F].trim())&&(M=qt.Handlebars.compile(L,{noEscape:!0}),L.includes("{{chatHistory}}")&&b.length>0?M({chatHistory:b.length>0?b:void 0}).trim()&&D.push.apply(D,Ut(b)):(j=M(x).trim())&&D.push({role:"system",content:j}));return e.next=49,Jt.ConnectionManagerRequestService.sendRequest(r,D,h);case 49:return B=e.sent,R=Vt(B.content,m),e.abrupt("return",R);case 52:case"end":return e.stop()}}),e,null,[[16,23],[28,35]])})),Qt=function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function s(e){zt(i,r,o,s,a,"next",e)}function a(e){zt(i,r,o,s,a,"throw",e)}s(void 0)}))},Qt.apply(this,arguments)}var en="{{#if chatHistory}}\n{{chatHistory}}\n{{/if}}\n[CREC_NEXT_MESSAGE]\n{{#if stDescription}}\n{{stDescription}}\n{{/if}}\n[CREC_NEXT_MESSAGE]\n{{#if charDefinitions}}\n{{charDefinitions}}\n{{/if}}\n[CREC_NEXT_MESSAGE]\n{{#if lorebookDefinitions}}\n{{lorebookDefinitions}}\n{{/if}}\n[CREC_NEXT_MESSAGE]\n{{#if existingFields}}\n{{existingFields}}\n{{/if}}\n[CREC_NEXT_MESSAGE]\n{{#if outputFormatInstructions}}\n{{outputFormatInstructions}}\n{{/if}}\n[CREC_NEXT_MESSAGE]\n{{#if taskDescription}}\n{{taskDescription}}\n{{/if}}",tn="=== CURRENT CHARACTER FIELD VALUES ===\n- **Description:** {{#if fields.description}}{{fields.description}}{{else}}*Not provided*{{/if}}\n- **Personality:** {{#if fields.personality}}{{fields.personality}}{{else}}*Not provided*{{/if}}\n- **Scenario:** {{#if fields.scenario}}{{fields.scenario}}{{else}}*Not provided*{{/if}}\n- **First Message:** {{#if fields.first_mes}}{{fields.first_mes}}{{else}}*Not provided*{{/if}}\n- **Example Dialogue:**\n  {{#if fields.mes_example}}{{fields.mes_example}}{{else}}*Not provided*{{/if}}",nn='Your task is to generate the content for the "{{targetField}}" field of a character card. Base your response on the preceding context (chat history, persona, system prompts, character/lore definitions, existing fields, etc.).\n{{#if userInstructions}}\n\nFollow these user instructions: {{userInstructions}}\n{{/if}}\n{{#if fieldSpecificInstructions}}\n\nField-specific instructions: {{fieldSpecificInstructions}}\n{{/if}}',rn="SillyTavern-Character-Creator",on=["stCharCard","charDefinition","lorebookDefinition","xmlFormat","jsonFormat","noneFormat","worldInfoCharDefinition","existingFieldsDefinition","taskDescription"],sn={stCharCard:'=======\n\nWhen creating a **character card** in SillyTavern, you can define a structured profile to guide the AI\'s behavior and ensure consistency in roleplay or storytelling. Below are the common fields and their purposes, based on community templates and best practices:\n\n---\n\n### **1. Name**\n**Purpose**:\nThe character’s primary identifier. The AI uses this to reference the character in dialogue and narration.\n**Key Tips**:\n- Use a memorable name that reflects their role (e.g., "Zara the Shadowblade" implies stealth/combat).\n- Avoid overly complex or ambiguous names (e.g., "Xy’lthraa" may confuse the AI).\n**Example**:\n`"Seraphina Vale"` (Elegant, hints at nobility) vs. `"Rusty"` (Casual, rugged).\n\n---\n\n### **2. Description**\n**Purpose**:\nA snapshot of the character’s identity, combining **appearance**, **personality**, and **key traits** to guide the AI’s "mental image."\n**Structure**:\n- **Appearance**: Physical traits (e.g., scars, clothing, species).\n- **Personality**: Core demeanor (e.g., stoic, playful).\n- **Mannerisms**: Unique habits (e.g., "taps fingers when lying").\n**Example**:\n> *"A hulking orc with moss-green skin and a chipped tusk, wearing a patchwork cloak. Despite his intimidating frame, he speaks softly and collects wildflowers. Secretly fears fire."*\n**Tips**:\n- Use vivid, concise language.\n- Prioritize traits critical to roleplay (e.g., "blind in one eye" affects interactions).\n\n---\n\n### **3. Personality**\n**Purpose**:\nExplicitly defines **how the character thinks/behaves**, reducing ambiguity for the AI.\n**What to Include**:\n- Core traits (e.g., "optimistic", "paranoid").\n- Motivations (e.g., "seeks revenge against the crown").\n- Flaws (e.g., "impulsive", "overly trusting").\n**Example**:\n`"Charismatic but manipulative; values loyalty only when it benefits him. Haunted by guilt over a failed rescue mission."`\n**Tips**:\n- Use bullet points or short phrases for clarity.\n- Avoid contradictions (e.g., "shy" vs. "loves public speaking").\n\n---\n\n### **4. Scenario**\n**Purpose**:\nSets the stage for the interaction, providing **contextual boundaries** for the AI.\n**What to Include**:\n- **Location**: Where the scene takes place (e.g., "a smoky tavern").\n- **Time**: Era or time-sensitive context (e.g., "during a solar eclipse").\n- **Relationship**: Predefined ties to the user (e.g., "childhood rivals reunited").\n**Example**:\n`"A cyberpunk night market in 2147. {{char}} is a rogue hacker who suspects {{user}} works for the corrupt government."`\n**Tips**:\n- Use dynamic placeholders like `{{user}}` to personalize the scenario.\n\n---\n\n### **5. First Message**\n**Purpose**:\nThe character’s **opening line**, critical for establishing tone, voice, and narrative momentum.\n**Key Elements**:\n- **Dialogue**: Shows speech style (formal, slang-heavy).\n- **Actions**: Subtle body language (e.g., "crosses arms skeptically").\n- **Hook**: Encourages user engagement (e.g., a question or mystery).\n**Example**:\n`*{{char}} adjusts her gas mask, voice muffled.* "You’re the third outsider this week. What makes you think you’ll survive the Wastes?"`\n**Tips**:\n- Avoid passive openings (e.g., "Hello, how can I help you?").\n- Mirror the character’s personality (e.g., a shy character might stammer).\n\n---\n\n### **6. Example Dialogue**\n**Purpose**:\nTeaches the AI the character’s **speech patterns**, **formatting preferences**, and **interaction style**.\n**Structure**:\n- Use `{{char}}` and `{{user}}` placeholders.\n- Mix dialogue and actions (e.g., `*{{char}} smirks.* "You’re bold. I like that."`).\n- Show range (e.g., anger, sarcasm, vulnerability).\n**Example**:\n```\n{{user}}: Why should I trust you?\n{{char}}: *Pulls a dagger from her boot and twirls it.* "You shouldn’t. But I’m your only way out of this alive."\n```\n**Tips**:\n- Include 3–5 varied exchanges.\n- Match the character’s voice (e.g., a poet might use metaphors).\n\n---\n\n### **Advanced Tips**\n- **Avoid "Wall of Text"**: Use line breaks and punctuation to improve readability for the AI.\n\n---\n\n### **Example Character Card Snippet**\n```json\n{\n  "name": "Kael Stormveil",\n  "description": "A storm sorcerer with crackling electricity in his eyes. Wears a cloak woven from thunderclouds. Pragmatic to a fault, but secretly fears losing control of his powers.",\n  "personality": "Analytical, blunt, distrusts authority. Motto: \'Chaosis just order waiting to be deciphered.\'",\n  "scenario": "A floating library during a magical hurricane. {{user}} is a novice mage Kael reluctantly mentors.",\n  "first_message": "*Kael’s hands spark as he slams a tome shut.* ‘You’ve got five minutes to explain why I shouldn’t toss you into the storm.’",\n  "example_dialogue": "{{user}}: Can you teach me to control the storm?\n{{char}}: *Snorts.* ‘Control is an illusion. You ride the storm or drown.’"\n}\n```\n\n=======',charDefinition:"## Selected Characters for Context\n{{#each characters}}\n### {{this.name}}\n{{#if this.description}}\n#### Description\n{{this.description}}\n{{/if}}\n{{#if this.personality}}\n#### Personality\n{{this.personality}}\n{{/if}}\n{{#if this.scenario}}\n#### Scenario\n{{this.scenario}}\n{{/if}}\n{{#if this.first_mes}}\n#### First Message\n{{this.first_mes}}\n{{/if}}\n{{#if this.mes_example}}\n#### Example Dialogue\n{{this.mes_example}}\n{{/if}}\n\n{{/each}}",lorebookDefinition:"## Selected Lorebooks for Context\n{{#each lorebooks}}\n### {{@key}}\n  {{#each this as |entry|}}\n#### {{#if entry.comment}}{{entry.comment}}{{else}}*No title*{{/if}}\nTriggers: {{#if entry.key}}{{join entry.key ', '}}{{else}}*No triggers*{{/if}}\nContent: {{#if entry.content}}{{entry.content}}{{else}}*No content*{{/if}}\n\n  {{/each}}\n\n\n{{/each}}",xmlFormat:"=== RESPONSE FORMAT INSTRUCTIONS ===\nYou MUST provide your response wrapped ONLY in a single <response> XML tag.\n\nWhen providing code in your response, wrap it in triple backticks:\n\nExample:\n```\n<response>Generated content for the field goes here.</response>\n```",jsonFormat:'=== RESPONSE FORMAT INSTRUCTIONS ===\nYou MUST provide your response as a JSON object with a single key "response" containing the generated content as a string.\n\nWhen providing code in your response, wrap it in triple backticks:\n\nExample:\n```\n{\n  "response": "Generated content for the field goes here."\n}\n```',noneFormat:"=== RESPONSE FORMAT INSTRUCTIONS ===\nYou MUST provide ONLY the raw text content for the field, without any formatting, XML tags, JSON structure, or explanatory text. Just the content itself.\n\nWhen providing code in your response, wrap it in triple backticks:\n\nExample:\n```\nGenerated content for the field goes here.\n```",worldInfoCharDefinition:"### {{character.name}}\n- **Description:** {{#if character.description}}{{character.description}}{{else}}*Not provided*{{/if}}\n- **Personality:** {{#if character.personality}}{{character.personality}}{{else}}*Not provided*{{/if}}\n- **Scenario:** {{#if character.scenario}}{{character.scenario}}{{else}}*Not provided*{{/if}}\n- **First Message:** {{#if character.first_mes}}{{character.first_mes}}{{else}}*Not provided*{{/if}}\n- **Example Dialogue:**\n  {{#if character.mes_example}}{{character.mes_example}}{{else}}*Not provided*{{/if}}",existingFieldsDefinition:tn,taskDescription:nn,mainContextTemplate:en};function an(e){var t=e.replace(/[^\w\s]/g,"").split(/\s+/).filter(Boolean),n=!1;return t.map((function(e,t){var r=e.replace(/^\d+/,"");if(r){var o=n?"".concat(r[0].toUpperCase()).concat(r.slice(1).toLowerCase()):r.toLowerCase();return n||(n=!0),o}return""})).join("")}var cn=new m("charCreator",{version:"0.1.3",formatVersion:"F_1.1",profileId:"",maxContextType:"profile",maxContextValue:16384,maxResponseToken:1024,outputFormat:"xml",contextToSend:{stDescription:!0,messages:{type:"last",first:10,last:10,range:{start:0,end:10}},charCard:!0,existingFields:!0,worldInfo:!0},prompts:{stCharCard:{content:sn.stCharCard,isDefault:!0,label:"ST/Char Card Description"},charDefinition:{content:sn.charDefinition,isDefault:!0,label:"Character Definition Template"},lorebookDefinition:{content:sn.lorebookDefinition,isDefault:!0,label:"Lorebook Definition Template"},xmlFormat:{content:sn.xmlFormat,isDefault:!0,label:"XML Format Description"},jsonFormat:{content:sn.jsonFormat,isDefault:!0,label:"JSON Format Description"},noneFormat:{content:sn.noneFormat,isDefault:!0,label:"Plain Text Format Description"},worldInfoCharDefinition:{content:sn.worldInfoCharDefinition,isDefault:!0,label:"World Info Character Definition Template"},existingFieldsDefinition:{content:tn,isDefault:!0,label:"Existing Fields Definition Template"},taskDescription:{content:nn,isDefault:!0,label:"Task Description Template"}},promptPreset:"default",promptPresets:{default:{content:"Generate the field content based on the chat history and existing character details. Be creative but consistent."}},mainContextTemplatePreset:"default",mainContextTemplatePresets:{default:{content:en}},showSaveAsWorldInfoEntry:{show:!1}});function ln(e){return ln="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ln(e)}function un(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function dn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?un(Object(n),!0).forEach((function(t){pn(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):un(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function pn(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=ln(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=ln(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==ln(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function hn(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */hn=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},i="function"==typeof Symbol?Symbol:{},s=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var i=t&&t.prototype instanceof v?t:v,s=Object.create(i.prototype),a=new T(r||[]);return o(s,"_invoke",{value:_(e,n,a)}),s}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var p="suspendedStart",h="suspendedYield",f="executing",m="completed",g={};function v(){}function y(){}function x(){}var b={};l(b,s,(function(){return this}));var w=Object.getPrototypeOf,C=w&&w(w(I([])));C&&C!==n&&r.call(C,s)&&(b=C);var E=x.prototype=v.prototype=Object.create(b);function S(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function A(e,t){function n(o,i,s,a){var c=d(e[o],e,i);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==ln(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,s,a)}),(function(e){n("throw",e,s,a)})):t.resolve(u).then((function(e){l.value=e,s(l)}),(function(e){return n("throw",e,s,a)}))}a(c.arg)}var i;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return i=i?i.then(o,o):o()}})}function _(t,n,r){var o=p;return function(i,s){if(o===f)throw Error("Generator is already running");if(o===m){if("throw"===i)throw s;return{value:e,done:!0}}for(r.method=i,r.arg=s;;){var a=r.delegate;if(a){var c=P(a,r);if(c){if(c===g)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===p)throw o=m,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=f;var l=d(t,n,r);if("normal"===l.type){if(o=r.done?m:h,l.arg===g)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o=m,r.method="throw",r.arg=l.arg)}}}function P(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,P(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var i=d(o,t.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,g;var s=i.arg;return s?s.done?(n[t.resultName]=s.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):s:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function k(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function N(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(k,this),this.reset(!0)}function I(t){if(t||""===t){var n=t[s];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,i=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return i.next=i}}throw new TypeError(ln(t)+" is not iterable")}return y.prototype=x,o(E,"constructor",{value:x,configurable:!0}),o(x,"constructor",{value:y,configurable:!0}),y.displayName=l(x,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,x):(e.__proto__=x,l(e,c,"GeneratorFunction")),e.prototype=Object.create(E),e},t.awrap=function(e){return{__await:e}},S(A.prototype),l(A.prototype,a,(function(){return this})),t.AsyncIterator=A,t.async=function(e,n,r,o,i){void 0===i&&(i=Promise);var s=new A(u(e,n,r,o),i);return t.isGeneratorFunction(n)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},S(E),l(E,c,"Generator"),l(E,s,(function(){return this})),l(E,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=I,T.prototype={constructor:T,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(N),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return a.type="throw",a.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i],a=s.completion;if("root"===s.tryLoc)return o("end");if(s.tryLoc<=this.prev){var c=r.call(s,"catchLoc"),l=r.call(s,"finallyLoc");if(c&&l){if(this.prev<s.catchLoc)return o(s.catchLoc,!0);if(this.prev<s.finallyLoc)return o(s.finallyLoc)}else if(c){if(this.prev<s.catchLoc)return o(s.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return o(s.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var s=i?i.completion:{};return s.type=e,s.arg=t,i?(this.method="next",this.next=i.finallyLoc,g):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),N(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;N(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:I(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),g}},t}function fn(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,i,s,a=[],c=!0,l=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=i.call(n)).done)&&(a.push(r.value),a.length!==t);c=!0);}catch(e){l=!0,o=e}finally{try{if(!c&&null!=n.return&&(s=n.return(),Object(s)!==s))return}finally{if(l)throw o}}return a}}(e,t)||function(e,t){if(e){if("string"==typeof e)return mn(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?mn(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function mn(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function gn(e,t,n,r,o,i,s){try{var a=e[i](s),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,o)}function vn(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function s(e){gn(i,r,o,s,a,"next",e)}function a(e){gn(i,r,o,s,a,"throw",e)}s(void 0)}))}}function yn(){return(yn=vn(hn().mark((function e(){var t,n,r,o,i,s,a,c,l,u,d,p,h,f;return hn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Jt.renderExtensionTemplateAsync("third-party/".concat(rn),"templates/settings");case 2:if(t=e.sent,$("#extensions_settings").append(t),n=document.querySelector(".charCreator_settings")){e.next=7;break}return e.abrupt("return");case 7:r=cn.getSettings(),i=n.querySelector("#charCreator_mainContextTemplatePreset"),s=n.querySelector("#charCreator_mainContextTemplateContent"),a=n.querySelector("#charCreator_restoreMainContextTemplateDefault"),s.value=null===(o=r.mainContextTemplatePresets[r.mainContextTemplatePreset])||void 0===o?void 0:o.content,Se("#charCreator_mainContextTemplatePreset",{initialList:Object.keys(r.mainContextTemplatePresets),initialValue:r.mainContextTemplatePreset,readOnlyValues:["default"],onSelectChange:function(e,t){var n=null!=t?t:"default";s.value=r.mainContextTemplatePresets[n].content,r.mainContextTemplatePreset=n,cn.saveSettings()},create:{onAfterCreate:function(e){var t=r.mainContextTemplatePresets[r.mainContextTemplatePreset];t||(t=r.mainContextTemplatePresets.default),r.mainContextTemplatePresets[e]=structuredClone(t)}},rename:{onAfterRename:function(e,t){r.mainContextTemplatePresets[t]=r.mainContextTemplatePresets[e],delete r.mainContextTemplatePresets[e]}},delete:{onAfterDelete:function(e){delete r.mainContextTemplatePresets[e]}}}),s.addEventListener("change",(function(){r.mainContextTemplatePresets[r.mainContextTemplatePreset].content=s.value,cn.saveSettings()})),a.addEventListener("click",vn(hn().mark((function e(){return hn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Jt.Popup.show.confirm("Restore default","Are you sure you want to restore the default prompt?");case 2:if(e.sent){e.next=5;break}return e.abrupt("return");case 5:r.mainContextTemplatePresets.default={content:en},"default"!==i.value?(i.value="default",i.dispatchEvent(new Event("change"))):(s.value=en,cn.saveSettings());case 7:case"end":return e.stop()}}),e)})))),c=n.querySelector("#charCreator_systemPromptPreset"),l=n.querySelector("#charCreator_systemPromptContent"),u=n.querySelector("#charCreator_restoreSystemPromptDefault"),Se("#charCreator_systemPromptPreset",{initialList:Object.keys(r.prompts),readOnlyValues:on,initialValue:on[0],label:function(e){if(""===e)return"prompt";var t=r.prompts[e];return t?"".concat(t.label," (").concat(e,")"):e},create:{onBeforeCreate:function(e){var t=an(e);return t?!r.prompts[t]||(ve("error","Prompt name already exists: ".concat(t)),!1):(ve("error","Invalid prompt name: ".concat(e)),!1)},onAfterCreate:function(e){var t=an(e);return r.prompts[t]={content:l.value,isDefault:!1,label:e},t}},rename:{onBeforeRename:function(e,t){var n=an(t);return n?!r.prompts[n]||(ve("error","Prompt name already exists: ".concat(n)),!1):(ve("error","Invalid prompt name: ".concat(t)),!1)},onAfterRename:function(e,t){var n=an(t);return r.prompts[n]=dn(dn({},r.prompts[e]),{},{label:t}),delete r.prompts[e],n}},delete:{onAfterDelete:function(e){delete r.prompts[e]}},onSelectChange:function(e,t){var n,o=null!=t?t:"",i=r.prompts[o];i&&(l.value=null!==(n=i.content)&&void 0!==n?n:"",u.style.display=on.includes(o)?"block":"none",cn.saveSettings())}}),d=c.value,(p=r.prompts[d])&&(l.value=null!==(h=p.content)&&void 0!==h?h:"",u.style.display=on.includes(d)?"block":"none"),l.addEventListener("change",(function(){var e=c.value,t=l.value,n=r.prompts[e];n&&(n.content=t,n.isDefault=!!on.includes(e)&&sn[e]===t,u.style.display=on.includes(e)?"block":"none",cn.saveSettings())})),u.addEventListener("click",vn(hn().mark((function e(){var t,n,o;return hn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=c.value,n=sn[t],!(o=r.prompts[t])){e.next=10;break}return e.next=6,Jt.Popup.show.confirm("Restore Default",'Are you sure you want to restore the default for "'.concat(o.label,'"?'));case 6:e.sent&&(l.value=n,l.dispatchEvent(new Event("change"))),e.next=11;break;case 10:ve("warning","No prompt selected.");case 11:case"end":return e.stop()}}),e)})))),(f=n.querySelector("#charCreator_showSaveAsWorldInfo"))&&(f.checked=r.showSaveAsWorldInfoEntry.show,f.addEventListener("change",(function(){r.showSaveAsWorldInfoEntry.show=f.checked,cn.saveSettings()})));case 26:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function xn(){return xn=vn(hn().mark((function e(){var t;return hn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t='<div class="menu_button fa-solid fa-user-astronaut interactable charCreator-icon" title="Character Creator"></div>',$(".form_create_bottom_buttons_block").prepend(t),$("#GroupFavDelOkBack").prepend(t),$("#form_character_search_form").prepend(t),document.querySelectorAll(".charCreator-icon").forEach((function(e){e.addEventListener("click",vn(hn().mark((function e(){var t,n,r,o,i,s,a,c,l,u,d,p,h,m,g,v,y,x,b,w,C,E,S,A,_,P,k,N,T,I,D,O,F,L,M,j,B,R,$,V,q,W,G,U,H,X,Y,z,J;return hn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Jt.renderExtensionTemplateAsync("third-party/".concat(rn),"templates/popup");case 2:if(u=e.sent,Jt.callGenericPopup(u,Pe.DISPLAY,void 0,{large:!0,wide:!0}),d=document.getElementById("charCreatorPopup")){e.next=7;break}return e.abrupt("return");case 7:p=cn.getSettings(),Jt.ConnectionManagerRequestService.handleDropdown("#charCreatorPopup #charCreator_connectionProfile",p.profileId,(function(e){var t;p.profileId=null!==(t=null==e?void 0:e.id)&&void 0!==t?t:"",cn.saveSettings()})),h=d.querySelector("#charCreator_stDescription"),m=d.querySelector("#charCreator_includeChars"),g=d.querySelector("#charCreator_charIncludeContainer"),v=d.querySelector("#charCreator_includeWorldInfo"),y=d.querySelector("#charCreator_worldInfoIncludeContainer"),x=d.querySelector("#charCreator_includeExistingFields"),h.checked=p.contextToSend.stDescription,m.checked=p.contextToSend.charCard,x.checked=p.contextToSend.existingFields,v.checked=p.contextToSend.worldInfo,g.style.display=m.checked?"block":"none",y.style.display=v.checked?"block":"none",h.addEventListener("change",(function(){p.contextToSend.stDescription=h.checked,cn.saveSettings()})),m.addEventListener("change",(function(){p.contextToSend.charCard=m.checked,g.style.display=m.checked?"block":"none",cn.saveSettings()})),v.addEventListener("change",(function(){p.contextToSend.worldInfo=v.checked,y.style.display=v.checked?"block":"none",cn.saveSettings()})),x.addEventListener("change",(function(){p.contextToSend.existingFields=x.checked,cn.saveSettings()})),b=d.querySelector(".message-options"),w=d.querySelector("#charCreator_messageType"),C=d.querySelector("#charCreator_firstX"),E=d.querySelector("#charCreator_lastX"),S=d.querySelector("#charCreator_rangeX"),A=d.querySelector("#charCreator_firstXMessages"),_=d.querySelector("#charCreator_lastXMessages"),P=d.querySelector("#charCreator_rangeStart"),k=d.querySelector("#charCreator_rangeEnd"),w.value=p.contextToSend.messages.type,A.value=String(null!==(t=p.contextToSend.messages.first)&&void 0!==t?t:10),_.value=String(null!==(n=p.contextToSend.messages.last)&&void 0!==n?n:10),P.value=String(null!==(r=null===(o=p.contextToSend.messages.range)||void 0===o?void 0:o.start)&&void 0!==r?r:0),k.value=String(null!==(i=null===(s=p.contextToSend.messages.range)||void 0===s?void 0:s.end)&&void 0!==i?i:10),(N=function(e){C.style.display="first"===e?"block":"none",E.style.display="last"===e?"block":"none",S.style.display="range"===e?"block":"none"})(w.value),"none"!==p.contextToSend.messages.type||void 0!==le.this_chid||me.selected_group||(b.style.display="none"),w.addEventListener("change",(function(){var e=w.value;p.contextToSend.messages.type=e,cn.saveSettings(),N(e)})),A.addEventListener("change",(function(){p.contextToSend.messages.first=parseInt(A.value)||10,cn.saveSettings()})),_.addEventListener("change",(function(){p.contextToSend.messages.last=parseInt(_.value)||10,cn.saveSettings()})),P.addEventListener("change",(function(){var e,t;p.contextToSend.messages.range={start:parseInt(P.value)||0,end:null!==(e=null===(t=p.contextToSend.messages.range)||void 0===t?void 0:t.end)&&void 0!==e?e:10},cn.saveSettings()})),k.addEventListener("change",(function(){var e,t;p.contextToSend.messages.range={start:null!==(e=null===(t=p.contextToSend.messages.range)||void 0===t?void 0:t.start)&&void 0!==e?e:0,end:parseInt(k.value)||10},cn.saveSettings()})),T=d.querySelector("#charCreator_maxContextType"),I=d.querySelector("#charCreator_maxTokens_container"),D=d.querySelector("#charCreator_maxTokens"),T.value=p.maxContextType,I.style.display="custom"===p.maxContextType?"block":"none",D.value=String(p.maxContextValue),T.addEventListener("change",(function(){var e=T.value;p.maxContextType=e,cn.saveSettings(),I.style.display="custom"===e?"block":"none"})),D.addEventListener("change",(function(){p.maxContextValue=Number(D.value)||16384,cn.saveSettings()})),(O=d.querySelector("#charCreator_maxResponseTokens")).value=String(p.maxResponseToken),O.addEventListener("change",(function(){p.maxResponseToken=Number(O.value)||1024,cn.saveSettings()})),(F=d.querySelector("#charCreator_outputFormat")).value=p.outputFormat,F.addEventListener("change",(function(){p.outputFormat=F.value,cn.saveSettings()})),L="charCreator",(M=JSON.parse(null!==(a=localStorage.getItem(L))&&void 0!==a?a:"{}")).selectedCharacterIndexes||(M.selectedCharacterIndexes=le.this_chid?[le.this_chid]:[]),M.selectedWorldNames||(M.selectedWorldNames=[]),M.fields||(M.fields={}),Kt.forEach((function(e){M.fields[e]||(M.fields[e]={value:"",prompt:""})})),j=function(){localStorage.setItem(L,JSON.stringify(M))},B=SillyTavern.getContext(),M.selectedCharacterIndexes=M.selectedCharacterIndexes.filter((function(e){return B.characters[Number(e)]})),d.querySelector("#charCreator_characterSelector")&&ae("#charCreator_characterSelector",{initialList:R=B.characters.map((function(e){return{value:B.characters.indexOf(e).toString(),label:e.name}})),initialValues:M.selectedCharacterIndexes,placeholderText:"Select characters...",enableSearch:R.length>10,onSelectChange:function(e,t){M.selectedCharacterIndexes=t,j()}}),$=d.querySelector("#charCreator_worldInfoSelector"),V=structuredClone(ue.world_names);try{$&&V.length>0?ae("#charCreator_worldInfoSelector",{initialList:V,initialValues:M.selectedWorldNames,placeholderText:"Select lorebooks...",enableSearch:V.length>10,onSelectChange:function(e,t){M.selectedWorldNames=t,j()}}):$&&($.textContent="No active lorebooks found.")}catch(e){console.error("Failed to get active world info:",e),$&&($.textContent="Error loading lorebooks.")}q=d.querySelector("#charCreator_prompt"),Se("#charCreatorPopup #charCreator_promptPreset",{initialValue:p.promptPreset,initialList:Object.keys(p.promptPresets),readOnlyValues:["default"],onSelectChange:function(){var e=vn(hn().mark((function e(t,n){var r,o,i;return hn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=null!=n?n:"default",p.promptPreset=i,cn.saveSettings(),q.value=null!==(r=null===(o=p.promptPresets[i])||void 0===o?void 0:o.content)&&void 0!==r?r:"";case 4:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),create:{onAfterCreate:function(e){var t,n=p.promptPresets[p.promptPreset];p.promptPresets[e]={content:null!==(t=null==n?void 0:n.content)&&void 0!==t?t:""}}},rename:{onAfterRename:function(e,t){p.promptPresets[t]=p.promptPresets[e],delete p.promptPresets[e]}},delete:{onAfterDelete:function(e){delete p.promptPresets[e]}}}),q.value=null!==(c=null===(l=p.promptPresets[p.promptPreset])||void 0===l?void 0:l.content)&&void 0!==c?c:"",q.addEventListener("change",(function(){p.promptPresets[p.promptPreset]&&(p.promptPresets[p.promptPreset].content=q.value,cn.saveSettings())})),W={name:{label:"Name",rows:1,large:!1,promptEnabled:!1},description:{label:"Description",rows:5,large:!0,promptEnabled:!0},personality:{label:"Personality",rows:4,large:!0,promptEnabled:!0},scenario:{label:"Scenario",rows:3,large:!0,promptEnabled:!0},first_mes:{label:"First Message",rows:3,large:!0,promptEnabled:!0},mes_example:{label:"Example Dialogue",rows:6,large:!0,promptEnabled:!0}},G=d.querySelector("#charCreator_fieldTemplate"),U=d.querySelector("#charCreator_fieldsContainer"),H={},G&&U&&Kt.forEach((function(e){var t=W[e],n=G.content.cloneNode(!0),r=n.querySelector(".character-field"),o=n.querySelector("label"),i=n.querySelector(".field-container textarea"),s=n.querySelector(".generate-field-button"),a=n.querySelector(".field-prompt-container textarea");if(r&&o&&i&&s&&a){var c,l,u,d,p,h;if(i.id="charCreator_field_".concat(e),a.id="charCreator_prompt_".concat(e),o.dataset.for=i.id,o.textContent=t.label,i.rows=t.rows,i.value=null!==(c=null===(l=M.fields[e])||void 0===l?void 0:l.value)&&void 0!==c?c:"",s.dataset.field=e,s.title="Generate ".concat(t.label),a.placeholder="Enter addiitonal prompt for ".concat(t.label.toLowerCase(),"..."),a.value=null!==(u=null===(d=M.fields[e])||void 0===d?void 0:d.prompt)&&void 0!==u?u:"",!t.promptEnabled)null===(p=a.closest(".field-prompt-container"))||void 0===p||p.remove();if(t.large)null===(h=i.closest(".field-container"))||void 0===h||h.classList.add("large-field");H[e]={textarea:i,button:s,promptTextarea:a}}U.appendChild(n)})),d.querySelector("#charCreator_loadCharSelector")&&ae("#charCreator_loadCharSelector",{initialList:X=B.characters.map((function(e){return{value:B.characters.indexOf(e).toString(),label:e.name}})),initialValues:[],placeholderText:"Load Character Data...",enableSearch:X.length>10,multiple:!1,closeOnSelect:!0,onBeforeSelection:function(e,t){return vn(hn().mark((function e(){return hn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.length){e.next=2;break}return e.abrupt("return",!1);case 2:if(0!==t[0].length){e.next=5;break}return e.abrupt("return",!1);case 5:if(Kt.every((function(e){var t,n=null===(t=H[e])||void 0===t?void 0:t.textarea;return n&&""===n.value.trim()}))){e.next=12;break}return e.next=9,Jt.Popup.show.confirm("Load Character Data","Are you sure you want to overwrite existing data? This cannot be undone.");case 9:if(e.sent){e.next=12;break}return e.abrupt("return",!1);case 12:return e.abrupt("return",!0);case 13:case"end":return e.stop()}}),e)})))()},onSelectChange:function(){var e=vn(hn().mark((function e(t,n){var r,o;return hn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==n.length){e.next=2;break}return e.abrupt("return");case 2:if(0!==(r=n[0]).length){e.next=5;break}return e.abrupt("return");case 5:if(o=B.characters[parseInt(r)]){e.next=9;break}return ve("warning","Selected character not found."),e.abrupt("return");case 9:Kt.forEach((function(e){var t,n,r,i=null===(t=H[e])||void 0===t?void 0:t.textarea,s=null===(n=H[e])||void 0===n?void 0:n.promptTextarea;i&&(i.value=null!==(r=o[e])&&void 0!==r?r:"",i.dispatchEvent(new Event("change")));s&&""!==s.value.trim()&&(s.value="",s.dispatchEvent(new Event("change")))}));case 10:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()}),d.querySelector("#charCreator_reset").addEventListener("click",vn(hn().mark((function e(){return hn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Jt.Popup.show.confirm("Reset Fields","Are you sure you want to reset all fields? This cannot be undone.");case 2:e.sent&&Kt.forEach((function(e){var t,n;null!==(t=H[e])&&void 0!==t&&t.textarea&&(H[e].textarea.value="",H[e].textarea.dispatchEvent(new Event("change"))),null!==(n=H[e])&&void 0!==n&&n.promptTextarea&&(H[e].promptTextarea.value="",H[e].promptTextarea.dispatchEvent(new Event("change")))}));case 4:case"end":return e.stop()}}),e)})))),d.querySelector("#charCreator_saveAsNewCharacter").addEventListener("click",vn(hn().mark((function e(){var t;return hn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(M.fields.name.value){e.next=3;break}return ve("warning","Please enter a name for the new character."),e.abrupt("return");case 3:return e.next=5,Jt.Popup.show.confirm("Save as New Character","Are you sure?");case 5:if(e.sent){e.next=8;break}return e.abrupt("return");case 8:return t={name:M.fields.name.value,description:M.fields.description.value,personality:M.fields.personality.value,scenario:M.fields.scenario.value,first_mes:M.fields.first_mes.value,mes_example:M.fields.mes_example.value,data:{name:M.fields.name.value,description:M.fields.description.value,personality:M.fields.personality.value,scenario:M.fields.scenario.value,first_mes:M.fields.first_mes.value,mes_example:M.fields.mes_example.value,tags:[],avatar:"none"},avatar:"none",tags:[],spec:"chara_card_v3",spec_version:"3.0"},e.prev=9,e.next=12,f(t,!0);case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(9),ve("error","Failed to create character: ".concat(e.t0.message));case 17:case"end":return e.stop()}}),e,null,[[9,14]])})))),Y=d.querySelector("#charCreator_saveAsWorldInfoSelector"),p.showSaveAsWorldInfoEntry.show?(z=ae(Y,{placeholderText:"Save as World Info Entry",initialList:ue.world_names,closeOnSelect:!0,multiple:!1,enableSearch:!0,onBeforeSelection:function(e,t){return vn(hn().mark((function e(){var n,r,o,i,s;return hn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.length){e.next=2;break}return e.abrupt("return",!1);case 2:if((n={name:M.fields.name.value,description:M.fields.description.value,first_mes:M.fields.first_mes.value,scenario:M.fields.scenario.value,personality:M.fields.personality.value,mes_example:M.fields.mes_example.value,avatar:"none"}).name){e.next=7;break}return ve("warning","Please enter a name for the character."),J(),e.abrupt("return",!1);case 7:r="",e.prev=8,o=qt.Handlebars.compile(p.prompts.charDefinition.content,{noEscape:!0}),r=o({character:n}),e.next=19;break;case 13:return e.prev=13,e.t0=e.catch(8),console.error("Failed to compile character definition prompt: ".concat(e.t0.message)),ve("error","Failed to compile character definition prompt: ".concat(e.t0.message)),J(),e.abrupt("return",!1);case 19:return i=t[0],s={uid:-1,key:[M.fields.name.value],content:r,comment:M.fields.name.value,disable:!1},e.prev=21,e.next=24,_e({entry:s,selectedWorldName:i,operation:"add"});case 24:ve("success","Entry added"),e.next=30;break;case 27:e.prev=27,e.t1=e.catch(21),ve("error","Failed to create world info entry: ".concat(e.t1.message));case 30:return J(),e.abrupt("return",!1);case 32:case"end":return e.stop()}}),e,null,[[8,13],[21,27]])})))()}}),J=z.close):Y.style.display="none",Object.entries(H).forEach((function(e){var t=fn(e,2),n=t[0],r=t[1],o=r.textarea,i=r.button,s=r.promptTextarea;i&&(i.addEventListener("click",vn(hn().mark((function e(){var t,r,s,a,c,l,u,h,f,m,g,v,y,x,b,w,C,E,S,A;return hn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(f=n,i.disabled=!0,m=i.innerHTML,i.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>',e.prev=4,v=d.querySelector("#charCreator_prompt").value,p.profileId){e.next=9;break}return ve("warning","Please select a connection profile."),e.abrupt("return");case 9:if(y=null===(g=B.extensionSettings.connectionManager)||void 0===g||null===(g=g.profiles)||void 0===g?void 0:g.find((function(e){return e.id===p.profileId}))){e.next=13;break}return ve("warning","Connection profile not found."),e.abrupt("return");case 13:x={presetName:null==y?void 0:y.preset,contextName:null==y?void 0:y.context,instructName:null==y?void 0:y.instruct,targetCharacterId:le.this_chid,ignoreCharacterFields:!0,ignoreWorldInfo:!0,ignoreAuthorNote:!0,maxContext:"custom"===p.maxContextType?p.maxContextValue:"profile"===p.maxContextType?"preset":"active",includeNames:!!me.selected_group},b=p.contextToSend.messages,e.t0=b.type,e.next="none"===e.t0?18:"first"===e.t0?20:"last"===e.t0?22:"range"===e.t0?26:(e.t0,28);break;case 18:return x.messageIndexesBetween={start:-1,end:-1},e.abrupt("break",29);case 20:return x.messageIndexesBetween={start:0,end:null!==(t=b.first)&&void 0!==t?t:10},e.abrupt("break",29);case 22:return w=null!==(r=null===(s=Jt.chat)||void 0===s?void 0:s.length)&&void 0!==r?r:0,C=null!==(a=b.last)&&void 0!==a?a:10,x.messageIndexesBetween={end:Math.max(0,w-1),start:Math.max(0,w-C)},e.abrupt("break",29);case 26:return x.messageIndexesBetween={start:null!==(c=null===(l=b.range)||void 0===l?void 0:l.start)&&void 0!==c?c:0,end:null!==(u=null===(h=b.range)||void 0===h?void 0:h.end)&&void 0!==u?u:10},e.abrupt("break",29);case 28:return e.abrupt("break",29);case 29:void 0!==le.this_chid||me.selected_group||(x.messageIndexesBetween={start:-1,end:-1}),E="",e.t1=p.outputFormat,e.next="xml"===e.t1?34:"json"===e.t1?36:"none"===e.t1?38:40;break;case 34:return E=p.prompts.xmlFormat.content,e.abrupt("break",40);case 36:return E=p.prompts.jsonFormat.content,e.abrupt("break",40);case 38:return E=p.prompts.noneFormat.content,e.abrupt("break",40);case 40:return S={},ue.world_names.filter((function(e){return M.selectedWorldNames.includes(e)})).forEach(function(){var e=vn(hn().mark((function e(t){var n;return hn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Jt.loadWorldInfo(t);case 2:(n=e.sent)&&(S[t]=Object.values(n.entries));case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=44,Zt({profileId:p.profileId,userPrompt:v,buildPromptOptions:x,contextToSend:p.contextToSend,session:M,allCharacters:B.characters,entriesGroupByWorldName:S,promptSettings:p.prompts,formatDescription:{content:E},mainContextTemplate:p.mainContextTemplatePresets[p.mainContextTemplatePreset].content,maxResponseToken:p.maxResponseToken,targetField:f,outputFormat:p.outputFormat});case 44:A=e.sent,o.value=A,o.dispatchEvent(new Event("change")),e.next=53;break;case 49:e.prev=49,e.t2=e.catch(4),console.error("Error generating field ".concat(f,":"),e.t2),ve("error","Failed to generate ".concat(f,": ").concat(e.t2.message||e.t2));case 53:return e.prev=53,i.disabled=!1,i.innerHTML=m,e.finish(53);case 57:case"end":return e.stop()}}),e,null,[[4,49,53,57]])})))),o.addEventListener("change",(function(){var e=n;M.fields[e]=dn(dn({},M.fields[e]),{},{value:o.value}),j()})),null==s||s.addEventListener("change",(function(){var e=n;M.fields[e]=dn(dn({},M.fields[e]),{},{prompt:s.value}),j()})))}));case 93:case"end":return e.stop()}}),e)}))))}));case 6:case"end":return e.stop()}}),e)}))),xn.apply(this,arguments)}function bn(){!function(){yn.apply(this,arguments)}(),function(){xn.apply(this,arguments)}()}qt.Handlebars.helpers.join||qt.Handlebars.registerHelper("join",(function(e,t){return Array.isArray(e)?e.join("string"==typeof t?t:", "):""})),qt.Handlebars.registerHelper("ifValue",(function(e,t){return e&&String(e).trim().length>0?t.fn(this):t.inverse(this)})),Jt.ConnectionManagerRequestService?cn.initializeSettings().then((function(e){var t=cn.getSettings(),n=!1;if(e.formatVersion.changed&&e.oldSettings&&e.formatVersion.changed){console.log("[".concat(rn,"] Migrating settings from format ").concat(e.formatVersion.old," to ").concat(e.formatVersion.new)),n=!0;var r=function(n,r,o){void 0!==e.oldSettings[r]?(t.prompts[n].content=e.oldSettings[r],void 0!==e.oldSettings[o]?t.prompts[n].isDefault=e.oldSettings[o]:t.prompts[n].isDefault=e.oldSettings[r]===sn[n],delete t[r],delete t[o]):void 0!==t[r]&&(delete t[r],delete t[o])};r("stCharCard","stCharCardPrompt","usingDefaultStCharCardPrompt"),r("charDefinition","charCardDefinitionPrompt","usingDefaultCharCardDefinitionPrompt"),r("lorebookDefinition","lorebookDefinitionPrompt","usingDefaultLorebookDefinitionPrompt"),r("xmlFormat","xmlFormatDesc","usingDefaultXmlFormatDesc"),r("jsonFormat","jsonFormatDesc","usingDefaultJsonFormatDesc"),r("noneFormat","noneFormatDesc","usingDefaultNoneFormatDesc");var o=e.oldSettings.showSaveAsWorldInfoEntry,i="characterDefinitionPrompt",s="usingDefaultCharacterDefinitionPrompt";o&&void 0!==o[i]&&(t.prompts.worldInfoCharDefinition.content=o[i],void 0!==o[s]?t.prompts.worldInfoCharDefinition.isDefault=o[s]:t.prompts.worldInfoCharDefinition.isDefault=o[i]===sn.worldInfoCharDefinition),t.showSaveAsWorldInfoEntry&&(void 0!==t.showSaveAsWorldInfoEntry[i]&&delete t.showSaveAsWorldInfoEntry[i],void 0!==t.showSaveAsWorldInfoEntry[s]&&delete t.showSaveAsWorldInfoEntry[s])}e.version.changed&&Object.entries(sn).forEach((function(e){var r=fn(e,2),o=r[0],i=r[1],s=o,a=t.prompts[s];a&&a.isDefault&&a.content!==i&&(console.log("[".concat(rn,"] Updating default for prompt: ").concat(s)),t.prompts[s].content=i,n=!0)})),n&&(console.log("[".concat(rn,"] Data migration complete. Saving settings...")),cn.saveSettings()),bn()})).catch((function(e){console.error("[".concat(rn,"] Error initializing settings:"),e),ve("error","[".concat(rn,"] Failed to initialize settings: ").concat(e.message)),Jt.Popup.show.confirm("[".concat(rn,"] Failed to load settings. This might be due to an update. Reset settings to default?"),"Extension Error").then((function(e){e&&(cn.resetSettings(),ve("success","[".concat(rn,"] Settings reset. Reloading may be required.")),bn())}))})):ve("error","[".concat(rn,"] Make sure you are on staging branch and staging is updated."));