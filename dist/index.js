import*as e from"../../../../power-user.js";import*as t from"../../../../../script.js";import*as n from"../../../../world-info.js";import*as r from"../../../../instruct-mode.js";import*as o from"../../../../chats.js";import*as i from"../../../../openai.js";import*as s from"../../../../authors-note.js";import*as a from"../../../../group-chats.js";import*as c from"../../../regex/engine.js";import*as l from"../../../../utils.js";import*as u from"../../../../slash-commands/SlashCommandCommonEnumsProvider.js";import*as h from"../../../../../lib.js";var d={d:(e,t)=>{for(var n in t)d.o(t,n)&&!d.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};class p extends Error{data;constructor(e,t){super(e),this.data=t}toString(){return this.message}}async function f(e,t){const n=SillyTavern.getContext(),r=new FormData;r.append("avatar",new Blob([JSON.stringify(e)],{type:"application/json"}),"character.json"),r.append("file_type","json");const o=n.getRequestHeaders();delete o["Content-Type"];const i=await fetch("/api/characters/import",{method:"POST",headers:o,body:r,cache:"no-cache"});if(!i.ok)throw new p(i.statusText,i);(t??1)&&await n.getCharacters()}function g(e){return Array.isArray?Array.isArray(e):"[object Array]"===C(e)}function m(e){return"string"==typeof e}function v(e){return"number"==typeof e}function y(e){return!0===e||!1===e||function(e){return x(e)&&null!==e}(e)&&"[object Boolean]"==C(e)}function x(e){return"object"==typeof e}function b(e){return null!=e}function w(e){return!e.trim().length}function C(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":Object.prototype.toString.call(e)}const E=Object.prototype.hasOwnProperty;class S{constructor(e){this._keys=[],this._keyMap={};let t=0;e.forEach((e=>{let n=A(e);this._keys.push(n),this._keyMap[n.id]=n,t+=n.weight})),this._keys.forEach((e=>{e.weight/=t}))}get(e){return this._keyMap[e]}keys(){return this._keys}toJSON(){return JSON.stringify(this._keys)}}function A(e){let t=null,n=null,r=null,o=1,i=null;if(m(e)||g(e))r=e,t=_(e),n=P(e);else{if(!E.call(e,"name"))throw new Error((e=>`Missing ${e} property in key`)("name"));const s=e.name;if(r=s,E.call(e,"weight")&&(o=e.weight,o<=0))throw new Error((e=>`Property 'weight' in key '${e}' must be a positive integer`)(s));t=_(s),n=P(s),i=e.getFn}return{path:t,id:n,weight:o,src:r,getFn:i}}function _(e){return g(e)?e:e.split(".")}function P(e){return g(e)?e.join("."):e}var N={isCaseSensitive:!1,ignoreDiacritics:!1,includeScore:!1,keys:[],shouldSort:!0,sortFn:(e,t)=>e.score===t.score?e.idx<t.idx?-1:1:e.score<t.score?-1:1,includeMatches:!1,findAllMatches:!1,minMatchCharLength:1,location:0,threshold:.6,distance:100,...{useExtendedSearch:!1,getFn:function(e,t){let n=[],r=!1;const o=(e,t,i)=>{if(b(e))if(t[i]){const s=e[t[i]];if(!b(s))return;if(i===t.length-1&&(m(s)||v(s)||y(s)))n.push(function(e){return null==e?"":function(e){if("string"==typeof e)return e;let t=e+"";return"0"==t&&1/e==-1/0?"-0":t}(e)}(s));else if(g(s)){r=!0;for(let e=0,n=s.length;e<n;e+=1)o(s[e],t,i+1)}else t.length&&o(s,t,i+1)}else n.push(e)};return o(e,m(t)?t.split("."):t,0),r?n:n[0]},ignoreLocation:!1,ignoreFieldNorm:!1,fieldNormWeight:1}};const k=/[^ ]+/g;class T{constructor({getFn:e=N.getFn,fieldNormWeight:t=N.fieldNormWeight}={}){this.norm=function(e=1,t=3){const n=new Map,r=Math.pow(10,t);return{get(t){const o=t.match(k).length;if(n.has(o))return n.get(o);const i=1/Math.pow(o,.5*e),s=parseFloat(Math.round(i*r)/r);return n.set(o,s),s},clear(){n.clear()}}}(t,3),this.getFn=e,this.isCreated=!1,this.setIndexRecords()}setSources(e=[]){this.docs=e}setIndexRecords(e=[]){this.records=e}setKeys(e=[]){this.keys=e,this._keysMap={},e.forEach(((e,t)=>{this._keysMap[e.id]=t}))}create(){!this.isCreated&&this.docs.length&&(this.isCreated=!0,m(this.docs[0])?this.docs.forEach(((e,t)=>{this._addString(e,t)})):this.docs.forEach(((e,t)=>{this._addObject(e,t)})),this.norm.clear())}add(e){const t=this.size();m(e)?this._addString(e,t):this._addObject(e,t)}removeAt(e){this.records.splice(e,1);for(let t=e,n=this.size();t<n;t+=1)this.records[t].i-=1}getValueForItemAtKeyId(e,t){return e[this._keysMap[t]]}size(){return this.records.length}_addString(e,t){if(!b(e)||w(e))return;let n={v:e,i:t,n:this.norm.get(e)};this.records.push(n)}_addObject(e,t){let n={i:t,$:{}};this.keys.forEach(((t,r)=>{let o=t.getFn?t.getFn(e):this.getFn(e,t.path);if(b(o))if(g(o)){let e=[];const t=[{nestedArrIndex:-1,value:o}];for(;t.length;){const{nestedArrIndex:n,value:r}=t.pop();if(b(r))if(m(r)&&!w(r)){let t={v:r,i:n,n:this.norm.get(r)};e.push(t)}else g(r)&&r.forEach(((e,n)=>{t.push({nestedArrIndex:n,value:e})}))}n.$[r]=e}else if(m(o)&&!w(o)){let e={v:o,n:this.norm.get(o)};n.$[r]=e}})),this.records.push(n)}toJSON(){return{keys:this.keys,records:this.records}}}function I(e,t,{getFn:n=N.getFn,fieldNormWeight:r=N.fieldNormWeight}={}){const o=new T({getFn:n,fieldNormWeight:r});return o.setKeys(e.map(A)),o.setSources(t),o.create(),o}function O(e,{errors:t=0,currentLocation:n=0,expectedLocation:r=0,distance:o=N.distance,ignoreLocation:i=N.ignoreLocation}={}){const s=t/e.length;if(i)return s;const a=Math.abs(r-n);return o?s+a/o:a?1:s}const D=32;function F(e,t,n,{location:r=N.location,distance:o=N.distance,threshold:i=N.threshold,findAllMatches:s=N.findAllMatches,minMatchCharLength:a=N.minMatchCharLength,includeMatches:c=N.includeMatches,ignoreLocation:l=N.ignoreLocation}={}){if(t.length>D)throw new Error(`Pattern length exceeds max of ${D}.`);const u=t.length,h=e.length,d=Math.max(0,Math.min(r,h));let p=i,f=d;const g=a>1||c,m=g?Array(h):[];let v;for(;(v=e.indexOf(t,f))>-1;){let e=O(t,{currentLocation:v,expectedLocation:d,distance:o,ignoreLocation:l});if(p=Math.min(e,p),f=v+u,g){let e=0;for(;e<u;)m[v+e]=1,e+=1}}f=-1;let y=[],x=1,b=u+h;const w=1<<u-1;for(let r=0;r<u;r+=1){let i=0,a=b;for(;i<a;){O(t,{errors:r,currentLocation:d+a,expectedLocation:d,distance:o,ignoreLocation:l})<=p?i=a:b=a,a=Math.floor((b-i)/2+i)}b=a;let c=Math.max(1,d-a+1),v=s?h:Math.min(d+a,h)+u,C=Array(v+2);C[v+1]=(1<<r)-1;for(let i=v;i>=c;i-=1){let s=i-1,a=n[e.charAt(s)];if(g&&(m[s]=+!!a),C[i]=(C[i+1]<<1|1)&a,r&&(C[i]|=(y[i+1]|y[i])<<1|1|y[i+1]),C[i]&w&&(x=O(t,{errors:r,currentLocation:s,expectedLocation:d,distance:o,ignoreLocation:l}),x<=p)){if(p=x,f=s,f<=d)break;c=Math.max(1,2*d-f)}}if(O(t,{errors:r+1,currentLocation:d,expectedLocation:d,distance:o,ignoreLocation:l})>p)break;y=C}const C={isMatch:f>=0,score:Math.max(.001,x)};if(g){const e=function(e=[],t=N.minMatchCharLength){let n=[],r=-1,o=-1,i=0;for(let s=e.length;i<s;i+=1){let s=e[i];s&&-1===r?r=i:s||-1===r||(o=i-1,o-r+1>=t&&n.push([r,o]),r=-1)}return e[i-1]&&i-r>=t&&n.push([r,i-1]),n}(m,a);e.length?c&&(C.indices=e):C.isMatch=!1}return C}function L(e){let t={};for(let n=0,r=e.length;n<r;n+=1){const o=e.charAt(n);t[o]=(t[o]||0)|1<<r-n-1}return t}const M=String.prototype.normalize?e=>e.normalize("NFD").replace(/[\u0300-\u036F\u0483-\u0489\u0591-\u05BD\u05BF\u05C1\u05C2\u05C4\u05C5\u05C7\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED\u0711\u0730-\u074A\u07A6-\u07B0\u07EB-\u07F3\u07FD\u0816-\u0819\u081B-\u0823\u0825-\u0827\u0829-\u082D\u0859-\u085B\u08D3-\u08E1\u08E3-\u0903\u093A-\u093C\u093E-\u094F\u0951-\u0957\u0962\u0963\u0981-\u0983\u09BC\u09BE-\u09C4\u09C7\u09C8\u09CB-\u09CD\u09D7\u09E2\u09E3\u09FE\u0A01-\u0A03\u0A3C\u0A3E-\u0A42\u0A47\u0A48\u0A4B-\u0A4D\u0A51\u0A70\u0A71\u0A75\u0A81-\u0A83\u0ABC\u0ABE-\u0AC5\u0AC7-\u0AC9\u0ACB-\u0ACD\u0AE2\u0AE3\u0AFA-\u0AFF\u0B01-\u0B03\u0B3C\u0B3E-\u0B44\u0B47\u0B48\u0B4B-\u0B4D\u0B56\u0B57\u0B62\u0B63\u0B82\u0BBE-\u0BC2\u0BC6-\u0BC8\u0BCA-\u0BCD\u0BD7\u0C00-\u0C04\u0C3E-\u0C44\u0C46-\u0C48\u0C4A-\u0C4D\u0C55\u0C56\u0C62\u0C63\u0C81-\u0C83\u0CBC\u0CBE-\u0CC4\u0CC6-\u0CC8\u0CCA-\u0CCD\u0CD5\u0CD6\u0CE2\u0CE3\u0D00-\u0D03\u0D3B\u0D3C\u0D3E-\u0D44\u0D46-\u0D48\u0D4A-\u0D4D\u0D57\u0D62\u0D63\u0D82\u0D83\u0DCA\u0DCF-\u0DD4\u0DD6\u0DD8-\u0DDF\u0DF2\u0DF3\u0E31\u0E34-\u0E3A\u0E47-\u0E4E\u0EB1\u0EB4-\u0EB9\u0EBB\u0EBC\u0EC8-\u0ECD\u0F18\u0F19\u0F35\u0F37\u0F39\u0F3E\u0F3F\u0F71-\u0F84\u0F86\u0F87\u0F8D-\u0F97\u0F99-\u0FBC\u0FC6\u102B-\u103E\u1056-\u1059\u105E-\u1060\u1062-\u1064\u1067-\u106D\u1071-\u1074\u1082-\u108D\u108F\u109A-\u109D\u135D-\u135F\u1712-\u1714\u1732-\u1734\u1752\u1753\u1772\u1773\u17B4-\u17D3\u17DD\u180B-\u180D\u1885\u1886\u18A9\u1920-\u192B\u1930-\u193B\u1A17-\u1A1B\u1A55-\u1A5E\u1A60-\u1A7C\u1A7F\u1AB0-\u1ABE\u1B00-\u1B04\u1B34-\u1B44\u1B6B-\u1B73\u1B80-\u1B82\u1BA1-\u1BAD\u1BE6-\u1BF3\u1C24-\u1C37\u1CD0-\u1CD2\u1CD4-\u1CE8\u1CED\u1CF2-\u1CF4\u1CF7-\u1CF9\u1DC0-\u1DF9\u1DFB-\u1DFF\u20D0-\u20F0\u2CEF-\u2CF1\u2D7F\u2DE0-\u2DFF\u302A-\u302F\u3099\u309A\uA66F-\uA672\uA674-\uA67D\uA69E\uA69F\uA6F0\uA6F1\uA802\uA806\uA80B\uA823-\uA827\uA880\uA881\uA8B4-\uA8C5\uA8E0-\uA8F1\uA8FF\uA926-\uA92D\uA947-\uA953\uA980-\uA983\uA9B3-\uA9C0\uA9E5\uAA29-\uAA36\uAA43\uAA4C\uAA4D\uAA7B-\uAA7D\uAAB0\uAAB2-\uAAB4\uAAB7\uAAB8\uAABE\uAABF\uAAC1\uAAEB-\uAAEF\uAAF5\uAAF6\uABE3-\uABEA\uABEC\uABED\uFB1E\uFE00-\uFE0F\uFE20-\uFE2F]/g,""):e=>e;class j{constructor(e,{location:t=N.location,threshold:n=N.threshold,distance:r=N.distance,includeMatches:o=N.includeMatches,findAllMatches:i=N.findAllMatches,minMatchCharLength:s=N.minMatchCharLength,isCaseSensitive:a=N.isCaseSensitive,ignoreDiacritics:c=N.ignoreDiacritics,ignoreLocation:l=N.ignoreLocation}={}){if(this.options={location:t,threshold:n,distance:r,includeMatches:o,findAllMatches:i,minMatchCharLength:s,isCaseSensitive:a,ignoreDiacritics:c,ignoreLocation:l},e=a?e:e.toLowerCase(),e=c?M(e):e,this.pattern=e,this.chunks=[],!this.pattern.length)return;const u=(e,t)=>{this.chunks.push({pattern:e,alphabet:L(e),startIndex:t})},h=this.pattern.length;if(h>D){let e=0;const t=h%D,n=h-t;for(;e<n;)u(this.pattern.substr(e,D),e),e+=D;if(t){const e=h-D;u(this.pattern.substr(e),e)}}else u(this.pattern,0)}searchIn(e){const{isCaseSensitive:t,ignoreDiacritics:n,includeMatches:r}=this.options;if(e=t?e:e.toLowerCase(),e=n?M(e):e,this.pattern===e){let t={isMatch:!0,score:0};return r&&(t.indices=[[0,e.length-1]]),t}const{location:o,distance:i,threshold:s,findAllMatches:a,minMatchCharLength:c,ignoreLocation:l}=this.options;let u=[],h=0,d=!1;this.chunks.forEach((({pattern:t,alphabet:n,startIndex:p})=>{const{isMatch:f,score:g,indices:m}=F(e,t,n,{location:o+p,distance:i,threshold:s,findAllMatches:a,minMatchCharLength:c,includeMatches:r,ignoreLocation:l});f&&(d=!0),h+=g,f&&m&&(u=[...u,...m])}));let p={isMatch:d,score:d?h/this.chunks.length:1};return d&&r&&(p.indices=u),p}}class B{constructor(e){this.pattern=e}static isMultiMatch(e){return R(e,this.multiRegex)}static isSingleMatch(e){return R(e,this.singleRegex)}search(){}}function R(e,t){const n=e.match(t);return n?n[1]:null}class V extends B{constructor(e,{location:t=N.location,threshold:n=N.threshold,distance:r=N.distance,includeMatches:o=N.includeMatches,findAllMatches:i=N.findAllMatches,minMatchCharLength:s=N.minMatchCharLength,isCaseSensitive:a=N.isCaseSensitive,ignoreDiacritics:c=N.ignoreDiacritics,ignoreLocation:l=N.ignoreLocation}={}){super(e),this._bitapSearch=new j(e,{location:t,threshold:n,distance:r,includeMatches:o,findAllMatches:i,minMatchCharLength:s,isCaseSensitive:a,ignoreDiacritics:c,ignoreLocation:l})}static get type(){return"fuzzy"}static get multiRegex(){return/^"(.*)"$/}static get singleRegex(){return/^(.*)$/}search(e){return this._bitapSearch.searchIn(e)}}class q extends B{constructor(e){super(e)}static get type(){return"include"}static get multiRegex(){return/^'"(.*)"$/}static get singleRegex(){return/^'(.*)$/}search(e){let t,n=0;const r=[],o=this.pattern.length;for(;(t=e.indexOf(this.pattern,n))>-1;)n=t+o,r.push([t,n-1]);const i=!!r.length;return{isMatch:i,score:i?0:1,indices:r}}}const W=[class extends B{constructor(e){super(e)}static get type(){return"exact"}static get multiRegex(){return/^="(.*)"$/}static get singleRegex(){return/^=(.*)$/}search(e){const t=e===this.pattern;return{isMatch:t,score:t?0:1,indices:[0,this.pattern.length-1]}}},q,class extends B{constructor(e){super(e)}static get type(){return"prefix-exact"}static get multiRegex(){return/^\^"(.*)"$/}static get singleRegex(){return/^\^(.*)$/}search(e){const t=e.startsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,this.pattern.length-1]}}},class extends B{constructor(e){super(e)}static get type(){return"inverse-prefix-exact"}static get multiRegex(){return/^!\^"(.*)"$/}static get singleRegex(){return/^!\^(.*)$/}search(e){const t=!e.startsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},class extends B{constructor(e){super(e)}static get type(){return"inverse-suffix-exact"}static get multiRegex(){return/^!"(.*)"\$$/}static get singleRegex(){return/^!(.*)\$$/}search(e){const t=!e.endsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},class extends B{constructor(e){super(e)}static get type(){return"suffix-exact"}static get multiRegex(){return/^"(.*)"\$$/}static get singleRegex(){return/^(.*)\$$/}search(e){const t=e.endsWith(this.pattern);return{isMatch:t,score:t?0:1,indices:[e.length-this.pattern.length,e.length-1]}}},class extends B{constructor(e){super(e)}static get type(){return"inverse-exact"}static get multiRegex(){return/^!"(.*)"$/}static get singleRegex(){return/^!(.*)$/}search(e){const t=-1===e.indexOf(this.pattern);return{isMatch:t,score:t?0:1,indices:[0,e.length-1]}}},V],G=W.length,U=/ +(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/;const H=new Set([V.type,q.type]);class X{constructor(e,{isCaseSensitive:t=N.isCaseSensitive,ignoreDiacritics:n=N.ignoreDiacritics,includeMatches:r=N.includeMatches,minMatchCharLength:o=N.minMatchCharLength,ignoreLocation:i=N.ignoreLocation,findAllMatches:s=N.findAllMatches,location:a=N.location,threshold:c=N.threshold,distance:l=N.distance}={}){this.query=null,this.options={isCaseSensitive:t,ignoreDiacritics:n,includeMatches:r,minMatchCharLength:o,findAllMatches:s,ignoreLocation:i,location:a,threshold:c,distance:l},e=t?e:e.toLowerCase(),e=n?M(e):e,this.pattern=e,this.query=function(e,t={}){return e.split("|").map((e=>{let n=e.trim().split(U).filter((e=>e&&!!e.trim())),r=[];for(let e=0,o=n.length;e<o;e+=1){const o=n[e];let i=!1,s=-1;for(;!i&&++s<G;){const e=W[s];let n=e.isMultiMatch(o);n&&(r.push(new e(n,t)),i=!0)}if(!i)for(s=-1;++s<G;){const e=W[s];let n=e.isSingleMatch(o);if(n){r.push(new e(n,t));break}}}return r}))}(this.pattern,this.options)}static condition(e,t){return t.useExtendedSearch}searchIn(e){const t=this.query;if(!t)return{isMatch:!1,score:1};const{includeMatches:n,isCaseSensitive:r,ignoreDiacritics:o}=this.options;e=r?e:e.toLowerCase(),e=o?M(e):e;let i=0,s=[],a=0;for(let r=0,o=t.length;r<o;r+=1){const o=t[r];s.length=0,i=0;for(let t=0,r=o.length;t<r;t+=1){const r=o[t],{isMatch:c,indices:l,score:u}=r.search(e);if(!c){a=0,i=0,s.length=0;break}if(i+=1,a+=u,n){const e=r.constructor.type;H.has(e)?s=[...s,...l]:s.push(l)}}if(i){let e={isMatch:!0,score:a/i};return n&&(e.indices=s),e}}return{isMatch:!1,score:1}}}const Y=[];function z(e,t){for(let n=0,r=Y.length;n<r;n+=1){let r=Y[n];if(r.condition(e,t))return new r(e,t)}return new j(e,t)}const J="$and",K="$or",Z="$path",Q="$val",ee=e=>!(!e[J]&&!e[K]),te=e=>({[J]:Object.keys(e).map((t=>({[t]:e[t]})))});function ne(e,t,{auto:n=!0}={}){const r=e=>{let o=Object.keys(e);const i=(e=>!!e[Z])(e);if(!i&&o.length>1&&!ee(e))return r(te(e));if((e=>!g(e)&&x(e)&&!ee(e))(e)){const r=i?e[Z]:o[0],s=i?e[Q]:e[r];if(!m(s))throw new Error((e=>`Invalid value for key ${e}`)(r));const a={keyId:P(r),pattern:s};return n&&(a.searcher=z(s,t)),a}let s={children:[],operator:o[0]};return o.forEach((t=>{const n=e[t];g(n)&&n.forEach((e=>{s.children.push(r(e))}))})),s};return ee(e)||(e=te(e)),r(e)}function re(e,t){const n=e.matches;t.matches=[],b(n)&&n.forEach((e=>{if(!b(e.indices)||!e.indices.length)return;const{indices:n,value:r}=e;let o={indices:n,value:r};e.key&&(o.key=e.key.src),e.idx>-1&&(o.refIndex=e.idx),t.matches.push(o)}))}function oe(e,t){t.score=e.score}class ie{constructor(e,t={},n){this.options={...N,...t},this.options.useExtendedSearch,this._keyStore=new S(this.options.keys),this.setCollection(e,n)}setCollection(e,t){if(this._docs=e,t&&!(t instanceof T))throw new Error("Incorrect 'index' type");this._myIndex=t||I(this.options.keys,this._docs,{getFn:this.options.getFn,fieldNormWeight:this.options.fieldNormWeight})}add(e){b(e)&&(this._docs.push(e),this._myIndex.add(e))}remove(e=()=>!1){const t=[];for(let n=0,r=this._docs.length;n<r;n+=1){const o=this._docs[n];e(o,n)&&(this.removeAt(n),n-=1,r-=1,t.push(o))}return t}removeAt(e){this._docs.splice(e,1),this._myIndex.removeAt(e)}getIndex(){return this._myIndex}search(e,{limit:t=-1}={}){const{includeMatches:n,includeScore:r,shouldSort:o,sortFn:i,ignoreFieldNorm:s}=this.options;let a=m(e)?m(this._docs[0])?this._searchStringList(e):this._searchObjectList(e):this._searchLogical(e);return function(e,{ignoreFieldNorm:t=N.ignoreFieldNorm}){e.forEach((e=>{let n=1;e.matches.forEach((({key:e,norm:r,score:o})=>{const i=e?e.weight:null;n*=Math.pow(0===o&&i?Number.EPSILON:o,(i||1)*(t?1:r))})),e.score=n}))}(a,{ignoreFieldNorm:s}),o&&a.sort(i),v(t)&&t>-1&&(a=a.slice(0,t)),function(e,t,{includeMatches:n=N.includeMatches,includeScore:r=N.includeScore}={}){const o=[];return n&&o.push(re),r&&o.push(oe),e.map((e=>{const{idx:n}=e,r={item:t[n],refIndex:n};return o.length&&o.forEach((t=>{t(e,r)})),r}))}(a,this._docs,{includeMatches:n,includeScore:r})}_searchStringList(e){const t=z(e,this.options),{records:n}=this._myIndex,r=[];return n.forEach((({v:e,i:n,n:o})=>{if(!b(e))return;const{isMatch:i,score:s,indices:a}=t.searchIn(e);i&&r.push({item:e,idx:n,matches:[{score:s,value:e,norm:o,indices:a}]})})),r}_searchLogical(e){const t=ne(e,this.options),n=(e,t,r)=>{if(!e.children){const{keyId:n,searcher:o}=e,i=this._findMatches({key:this._keyStore.get(n),value:this._myIndex.getValueForItemAtKeyId(t,n),searcher:o});return i&&i.length?[{idx:r,item:t,matches:i}]:[]}const o=[];for(let i=0,s=e.children.length;i<s;i+=1){const s=e.children[i],a=n(s,t,r);if(a.length)o.push(...a);else if(e.operator===J)return[]}return o},r=this._myIndex.records,o={},i=[];return r.forEach((({$:e,i:r})=>{if(b(e)){let s=n(t,e,r);s.length&&(o[r]||(o[r]={idx:r,item:e,matches:[]},i.push(o[r])),s.forEach((({matches:e})=>{o[r].matches.push(...e)})))}})),i}_searchObjectList(e){const t=z(e,this.options),{keys:n,records:r}=this._myIndex,o=[];return r.forEach((({$:e,i:r})=>{if(!b(e))return;let i=[];n.forEach(((n,r)=>{i.push(...this._findMatches({key:n,value:e[r],searcher:t}))})),i.length&&o.push({idx:r,item:e,matches:i})})),o}_findMatches({key:e,value:t,searcher:n}){if(!b(t))return[];let r=[];if(g(t))t.forEach((({v:t,i:o,n:i})=>{if(!b(t))return;const{isMatch:s,score:a,indices:c}=n.searchIn(t);s&&r.push({score:a,key:e,value:t,idx:o,norm:i,indices:c})}));else{const{v:o,n:i}=t,{isMatch:s,score:a,indices:c}=n.searchIn(o);s&&r.push({score:a,key:e,value:o,norm:i,indices:c})}return r}}function se(e,t={}){const n="string"==typeof e?document.querySelector(e):e;if(!n)throw new Error(`Could not find container: ${e}`);const r=t.placeholderText||"Select items...",o=t.closeOnSelect??!1,i=t.enableSearch??!1,s=t.multiple??!0,a=t.searchPlaceholderText||"Search...",c=t.searchNoResultsText||"No results found",l=t.searchDebounceMs??200;let u=[...t.initialList||[]];n.innerHTML="",n.classList.add("fancy-dropdown-container"),Object.assign(n.style,{position:"relative",userSelect:"none"});const h=document.createElement("div");h.className="fancy-dropdown-trigger",Object.assign(h.style,{padding:"8px 12px",border:"1px solid var(--border-color)",backgroundColor:"var(--bg-color)",color:"var(--text-color)",borderRadius:"4px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"space-between"});const d=document.createElement("span");d.className="fancy-dropdown-trigger-text",d.textContent=r;const p=document.createElement("i");p.className="fas fa-chevron-down",p.style.marginLeft="8px",h.append(d,p),n.append(h);const f=document.createElement("div");f.className="fancy-dropdown-list",Object.assign(f.style,{position:"absolute",top:"100%",left:"0",right:"0",maxHeight:"300px",display:"none",zIndex:"1050",border:"1px solid var(--border-color)",borderTop:"none",backgroundColor:"var(--bg-color-popup, var(--bg-color-secondary, var(--greyCAIbg, var(--grey30))))",color:"var(--text-color)",borderRadius:"0 0 4px 4px",boxShadow:"0 4px 8px var(--black50a)",overflowY:"auto"}),n.append(f);let g=null,m=null,v=null,y=null;i&&(m=document.createElement("div"),m.className="fancy-dropdown-search-wrapper",Object.assign(m.style,{padding:"8px",borderBottom:"1px solid var(--border-color)",position:"sticky",top:"0",backgroundColor:"inherit"}),g=document.createElement("input"),g.type="text",g.className="fancy-dropdown-search-input",g.placeholder=a,Object.assign(g.style,{width:"100%",padding:"6px 10px",border:"1px solid var(--border-color)",borderRadius:"3px",boxSizing:"border-box",backgroundColor:"var(--bg-color)",color:"var(--text-color)"}),g.addEventListener("click",(e=>e.stopPropagation())),m.append(g),f.append(m),v=document.createElement("div"),v.className="fancy-dropdown-no-results",v.textContent=c,Object.assign(v.style,{padding:"8px 12px",textAlign:"center",color:"var(--text-color-secondary, var(--grey50))",display:"none"}),f.append(v));let x=!1,b=null;const w=e=>"string"==typeof e?e:e.label,C=e=>"string"==typeof e?e:e.value;let E=(t.initialValues||[]).filter((e=>u.some((t=>C(t)===e))));const S=()=>{if(!i)return;const e={includeScore:!1,threshold:.4,isCaseSensitive:!1,findAllMatches:!0,...t.searchFuseOptions||{},keys:t.searchFuseOptions?.keys||[{name:"label",weight:.7},{name:"value",weight:.3}]},n=u.map((e=>"string"==typeof e?{value:e,label:e}:e));!t.searchFuseOptions?.keys&&u.every((e=>"string"==typeof e))&&(e.keys=["label"]),b=new ie(n,e)},A=e=>{let t=!1;f.querySelectorAll(".fancy-dropdown-item").forEach((n=>{const r=n.dataset.value,o=E.includes(r),i=n.querySelector(".checkmark");o?(n.classList.add("selected"),i&&(i.style.display="inline-block")):(n.classList.remove("selected"),i&&(i.style.display="none")),void 0!==e?e.includes(r)?(n.style.display="flex",t=!0):n.style.display="none":(n.style.display="flex",t=!0)})),i&&v&&(v.style.display=void 0===e||t?"none":"block"),(()=>{if(0===E.length)d.textContent=r;else if(1===E.length){const e=E[0],t=u.find((t=>C(t)===e)),n=t?w(t):e;d.textContent=n}else d.textContent=`${E.length} items selected`})()},_=e=>{if(!i||!b)return void A();const t=e.trim();if(""===t)return void A(void 0);const n=b.search(t).map((e=>e.item.value));A(n)},P=()=>{g&&(y&&clearTimeout(y),y=window.setTimeout((()=>{g&&_(g.value)}),l))},N=()=>{x||(x=!0,f.style.display="block",p.classList.remove("fa-chevron-down"),p.classList.add("fa-chevron-up"),i&&g&&setTimeout((()=>g?.focus()),50))},k=()=>{x&&(x=!1,f.style.display="none",i&&g&&(g.value="",_("")),p.classList.remove("fa-chevron-up"),p.classList.add("fa-chevron-down"),y&&clearTimeout(y))};h.addEventListener("click",(e=>{e.stopPropagation(),x?k():N()})),document.addEventListener("click",(e=>{x&&n&&!n.contains(e.target)&&k()})),i&&g&&g.addEventListener("input",P);const T=(e,n)=>{const r=C(e),a=w(e),c=document.createElement("div");c.className="fancy-dropdown-item",c.dataset.value=r,Object.assign(c.style,{padding:"8px 12px",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"space-between"}),c.addEventListener("mouseenter",(()=>{c.style.backgroundColor="var(--hover-color, var(--white20a))"})),c.addEventListener("mouseleave",(()=>{c.style.backgroundColor=""}));const l=document.createElement("span");l.textContent=a,c.append(l);const u=document.createElement("i");return u.className="checkmark fa-solid fa-check",Object.assign(u.style,{marginLeft:"8px",display:n?"inline-block":"none"}),c.append(u),c.addEventListener("click",(function(e){e.stopPropagation();const n=e.currentTarget.dataset.value,r=[...E];let a;a=s?E.includes(n)?E.filter((e=>e!==n)):[...E,n]:E.includes(n)?[]:[n];(async()=>{if(t.onBeforeSelection)try{if(!await Promise.resolve(t.onBeforeSelection(r,a)))return!1}catch(e){return console.error("onBeforeSelection callback failed:",e),!1}return!0})().then((e=>{e&&(E=a,i&&g&&""!==g.value.trim()?_(g.value):A(void 0),t.onSelectChange&&Promise.resolve(t.onSelectChange(r,E)).catch((e=>console.error("onSelectChange callback failed:",e))),o&&k())}))})),v?f.insertBefore(c,v):f.append(c),c};u.length>0&&u.forEach((e=>{const t=C(e);T(e,E.includes(t))})),S(),A();return{container:n,dropdownTrigger:h,dropdownList:f,getValues:()=>[...E],setValues:e=>{const n=[...E],r=e.filter((e=>u.some((t=>C(t)===e))));E=[...r],i&&g&&""!==g.value?(g.value="",_("")):A();JSON.stringify(n.sort())!==JSON.stringify(E.sort())&&t.onSelectChange&&Promise.resolve(t.onSelectChange(n,E)).catch((e=>console.error("onSelectChange callback failed:",e)))},getOptions:()=>u.map((e=>"string"==typeof e?{value:e,label:e}:e)),addOption:(e,n=!1)=>{const r=C(e);if(u.some((e=>C(e)===r)))return;u.push(e),T(e,n),S();let o=!1;const a=[...E];n&&!E.includes(r)?(s?E.push(r):E=[r],o=!0):n&&!s&&E.length>0&&E[0]!==r&&(E=[r],o=!0),i&&g&&""!==g.value?_(g.value):A(),o&&t.onSelectChange&&Promise.resolve(t.onSelectChange(a,E)).catch((e=>console.error("onSelectChange callback failed:",e)))},removeOption:e=>{const n=u.length;if(u=u.filter((t=>C(t)!==e)),u.length===n)return;let r=!1;const o=[...E],s=E.indexOf(e);s>-1&&(E.splice(s,1),r=!0);const a=f.querySelector(`.fancy-dropdown-item[data-value="${e}"]`);a?.remove(),S(),i&&g&&""!==g.value?_(g.value):A(),r&&t.onSelectChange&&Promise.resolve(t.onSelectChange(o,E)).catch((e=>console.error("onSelectChange callback failed:",e)))},selectAll:()=>{if(!s)return;const e=[...E],n=u.map(C);E=[...new Set([...E,...n])];const r=JSON.stringify(e.sort())!==JSON.stringify(E.sort());i&&g&&""!==g.value?_(g.value):A(),r&&t.onSelectChange&&Promise.resolve(t.onSelectChange(e,E)).catch((e=>console.error("onSelectChange callback failed:",e)))},deselectAll:()=>{const e=[...E];E.length>0&&(E=[],i&&g&&""!==g.value?_(g.value):A(),t.onSelectChange&&Promise.resolve(t.onSelectChange(e,E)).catch((e=>console.error("onSelectChange callback failed:",e))))},disable:()=>{n.style.pointerEvents="none",n.style.opacity="0.6",x&&k()},enable:()=>{n.style.pointerEvents="auto",n.style.opacity="1"},open:N,close:k,toggle:()=>x?k():N()}}ie.version="7.1.0",ie.createIndex=I,ie.parseIndex=function(e,{getFn:t=N.getFn,fieldNormWeight:n=N.fieldNormWeight}={}){const{keys:r,records:o}=e,i=new T({getFn:t,fieldNormWeight:n});return i.setKeys(r),i.setIndexRecords(o),i},ie.config=N,ie.parseQuery=ne,function(...e){Y.push(...e)}(X);const ae=(e=>{var t={};return d.d(t,e),t})({persona_description_positions:()=>e.persona_description_positions,renderStoryString:()=>e.renderStoryString});const ce=(e=>{var t={};return d.d(t,e),t})({baseChatReplace:()=>t.baseChatReplace,chat_metadata:()=>t.chat_metadata,depth_prompt_depth_default:()=>t.depth_prompt_depth_default,depth_prompt_role_default:()=>t.depth_prompt_role_default,extension_prompt_types:()=>t.extension_prompt_types,getMaxContextSize:()=>t.getMaxContextSize,name1:()=>t.name1,name2:()=>t.name2,parseMesExamples:()=>t.parseMesExamples,this_chid:()=>t.this_chid});const le=(e=>{var t={};return d.d(t,e),t})({wi_anchor_position:()=>n.wi_anchor_position,world_info_include_names:()=>n.world_info_include_names,world_names:()=>n.world_names});const ue=(e=>{var t={};return d.d(t,e),t})({formatInstructModeExamples:()=>r.formatInstructModeExamples,formatInstructModeSystemPrompt:()=>r.formatInstructModeSystemPrompt});const he=(e=>{var t={};return d.d(t,e),t})({appendFileContent:()=>o.appendFileContent});const de=(e=>{var t={};return d.d(t,e),t})({formatWorldInfo:()=>i.formatWorldInfo,getPromptPosition:()=>i.getPromptPosition,getPromptRole:()=>i.getPromptRole,prepareOpenAIMessages:()=>i.prepareOpenAIMessages,setOpenAIMessageExamples:()=>i.setOpenAIMessageExamples,setOpenAIMessages:()=>i.setOpenAIMessages});const pe=(e=>{var t={};return d.d(t,e),t})({metadata_keys:()=>s.metadata_keys});const fe=(e=>{var t={};return d.d(t,e),t})({getGroupDepthPrompts:()=>a.getGroupDepthPrompts,selected_group:()=>a.selected_group});const ge=(e=>{var t={};return d.d(t,e),t})({getRegexedString:()=>c.getRegexedString,regex_placement:()=>c.regex_placement});(e=>{var t={};d.d(t,e)})({});(e=>{var t={};d.d(t,e)})({});async function me(e,t,{escapeHtml:n=!0}={}){await async function(e,...t){await SillyTavern.getContext().SlashCommandParser.commands[e].callback(...t)}("echo",{severity:e,escapeHtml:Boolean(n).toString()},t)}function ve(e){return(0,ce.getMaxContextSize)(e)}function ye(e,t){return(0,ce.parseMesExamples)(e,t)}function xe(e,t,n){return(0,ce.baseChatReplace)(e,t,n)}function be(e){return(0,de.getPromptRole)(e)}function we(e,{wiFormat:t}={}){return(0,de.formatWorldInfo)(e,{wiFormat:t})}function Ce(e){return(0,de.getPromptPosition)(e)}function Ee(e,t={}){const n=SillyTavern.getContext(),r=t.readOnlyValues||[],o=document.querySelector(e);if(!o)throw new Error(`Could not find preset select: ${e}`);const i=t.label||"preset",s=document.createElement("div");s.className="preset-select-container",s.style.display="flex",s.style.alignItems="center";const a=e=>r.includes(e);if(o.parentNode?.insertBefore(s,o),s.appendChild(o),t.initialList&&t.initialList.length>0){o.innerHTML="";for(const e of t.initialList){const t=document.createElement("option");t.value=e,t.textContent=e,a(e)&&(t.dataset.readonly="true"),o.appendChild(t)}}if(t.initialValue){const e=Array.from(o.options).find((e=>e.value===t.initialValue||e.textContent===t.initialValue));e&&(o.value=e.value)}let c=o.value;if(o.addEventListener("change",(async()=>{const e=o.value;t.onSelectChange&&c!==e&&await t.onSelectChange(c,e),c=e})),t.create){const e=document.createElement("i");e.className="menu_button fa-solid fa-file-circle-plus",e.title=`Create a new ${i}`,e.setAttribute("data-i18n",`[title]Create a new ${i}`),e.addEventListener("click",(async()=>{t.create?.onPopupOpen&&await t.create.onPopupOpen();const e=await n.Popup.show.input(`Create a new ${i}`,`Please enter a name for the new ${i}:`,"");if(null===e||""===e.trim())return;const r=e.trim();if(Array.from(o.options).some((e=>e.textContent===r)))return void await me("warning",`A ${i} with this name already exists.`);if(t.create?.onBeforeCreate){if(!await t.create.onBeforeCreate(r))return}const s=document.createElement("option");s.value=r,s.textContent=r,o.appendChild(s);const a=o.value;o.value=r,t.create?.onAfterCreate&&await t.create.onAfterCreate(r),t.onSelectChange&&a!==r&&await t.onSelectChange(a,r),c=r})),s.appendChild(e)}if(t.rename){const e=document.createElement("i");e.className="menu_button fa-solid fa-pencil",e.title=`Rename a ${i}`,e.setAttribute("data-i18n",`[title]Rename a ${i}`),e.addEventListener("click",(async()=>{if(-1===o.selectedIndex)return void await me("warning",`Please select a ${i} to rename.`);const e=o.options[o.selectedIndex];let r=e.value;if(a(r))return void await me("warning",`This ${i} cannot be renamed as it is read-only.`);t.rename?.onPopupOpen&&await t.rename.onPopupOpen();const s=await n.Popup.show.input(`Rename ${i}`,`Please enter a new name for "${r}":`,r);if(null===s||""===s.trim()||s===r)return;const l=s.trim();if(Array.from(o.options).some((t=>t.textContent===l&&t!==e)))await me("warning",`A ${i} with this name already exists.`);else{if(t.rename?.onBeforeRename){if(!await t.rename.onBeforeRename(r,l))return}e.value=l,e.textContent=l,r===c&&(c=l),t.rename?.onAfterRename&&await t.rename.onAfterRename(r,l),t.onSelectChange&&o.value===l&&await t.onSelectChange(r,l)}})),s.appendChild(e)}if(t.delete){const e=document.createElement("i");e.className="menu_button fa-solid fa-trash-can",e.title=`Delete a ${i}`,e.setAttribute("data-i18n",`[title]Delete a ${i}`),e.addEventListener("click",(async()=>{if(-1===o.selectedIndex)return void await me("warning",`Please select a ${i} to delete.`);const e=o.options[o.selectedIndex],r=e.value,s=o.selectedIndex;if(a(r))return void await me("warning",`This ${i} cannot be deleted as it is read-only.`);t.delete?.onPopupOpen&&await t.delete.onPopupOpen();if(!await n.Popup.show.confirm(`Are you sure you want to delete "${r}"?`,`Delete ${i}`))return;if(t.delete?.onBeforeDelete){if(!await t.delete.onBeforeDelete(r))return}const l=r;let u,h=-1;o.options.length>1&&(h=s<o.options.length-1?s:s-1,u=o.options[h].value),o.removeChild(e),h>=0?(o.selectedIndex=h,c=u,t.onSelectChange&&await t.onSelectChange(l,u)):(t.onSelectChange&&await t.onSelectChange(l,void 0),c=void 0),t.delete?.onAfterDelete&&await t.delete.onAfterDelete(l)})),s.appendChild(e)}return{select:o,container:s}}async function Se(e,{targetCharacterId:t,presetName:n,instructName:r,contextName:o,syspromptName:i,maxContext:s,includeNames:a,ignoreCharacterFields:c,ignoreAuthorNote:l,ignoreWorldInfo:u,messageIndexesBetween:h}={}){if(!["textgenerationwebui","openai"].includes(e))throw new Error("Unsupported API");const d=SillyTavern.getContext();let p=[],{description:f,personality:g,persona:m,scenario:v,mesExamples:y,system:x,jailbreak:b}=c?{description:"",personality:"",persona:"",scenario:"",mesExamples:"",system:"",jailbreak:""}:d.getCharacterCardFields({chid:t});const w="textgenerationwebui"===e?d.getPresetManager("instruct")?.getCompletionPresetByName(r):void 0,C=!!w?.enabled;let E=ye(y,C);const S=function(){if("number"==typeof s)return s;if(!s)return ve();if("active"===s||!n)return ve();if("number"==typeof s)return s;let t;if("textgenerationwebui"===e){const e=d.getPresetManager("textgenerationwebui")?.getCompletionPresetByName(n);t=e?.max_length}else{const e=d.getPresetManager("openai")?.getCompletionPresetByName(n);t=e?.openai_max_context}return"number"==typeof t?t:ve()}();if(S<=0)return[];const A=d.ToolManager.isToolCallingSupported(),_=h?.start??0,P=h?.end?h.end+1:void 0;let N=-1===_&&0===P?[]:d.chat.slice(_,P).filter((e=>!e.is_system||A&&Array.isArray(e.extra?.tool_invocations)));N=await Promise.all(N.map((async(e,t)=>{let n=function(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:i,depth:s}){return(0,ge.getRegexedString)(e,t,{characterOverride:n,isMarkdown:r,isPrompt:o,isEdit:i,depth:s})}(e.mes,e.is_user?ge.regex_placement.USER_INPUT:ge.regex_placement.AI_OUTPUT,{isPrompt:!0,depth:N.length-t-1});return n=await async function(e,t){return await(0,he.appendFileContent)(e,t)}(e,n),e?.extra?.append_title&&e?.extra?.title&&(n=`${n}\n\n${e.extra.title}`),{...e,mes:n,index:t}})));const k=N.map((e=>le.world_info_include_names?`${e.name}: ${e.mes}`:e.mes)).reverse(),{worldInfoString:T,worldInfoBefore:I,worldInfoAfter:O,worldInfoExamples:D,worldInfoDepth:F,anBefore:L,anAfter:M}=u?{worldInfoString:"",worldInfoBefore:"",worldInfoAfter:"",worldInfoExamples:[],worldInfoDepth:[],anBefore:[],anAfter:[]}:await d.getWorldInfoPrompt(k,S,!1);for(const U of D){const H=U.content;if(0===H.length)continue;const X=ye(xe(H,ce.name1,ce.name2),C);U.position===le.wi_anchor_position.before?E.unshift(...X):E.push(...X)}function j(){let e=0;const t=[];for(let n=N.length-1;n>=0;n--){const r=N[n];if(r.extra?.token_count&&e+r.extra.token_count>S)break;e+=r.extra?.token_count||0,t.unshift({role:r.is_user?"user":"assistant",content:a?`${r.name}: ${r.mes}`:r.mes})}p.push(...t)}if("textgenerationwebui"===e){const Y=[...E];E&&(E=function(e,t,n){return(0,ue.formatInstructModeExamples)(e,t,n)}(E,ce.name1,ce.name2));const z=d.getPresetManager("sysprompt")?.getCompletionPresetByName(i);z&&(x=d.powerUserSettings.prefer_character_prompt&&x?x:xe(z.content,ce.name1,ce.name2),x=C?(R=d.substituteParams(x,ce.name1,ce.name2,z.content),$=w,(0,ue.formatInstructModeSystemPrompt)(R,$)):x);const J={description:f,personality:g,persona:d.powerUserSettings.persona_description_position==ae.persona_description_positions.IN_PROMPT?m:"",scenario:v,system:x,char:ce.name2,user:ce.name1,wiBefore:I,wiAfter:O,loreBefore:I,loreAfter:O,mesExamples:E.join(""),mesExamplesRaw:Y.join("")},K=d.getPresetManager("context")?.getCompletionPresetByName(o);let Z=function(e,{customStoryString:t,customInstructSettings:n}={}){return(0,ae.renderStoryString)(e,{customStoryString:t,customInstructSettings:n})}(J,{customInstructSettings:w,customStoryString:K?.story_string});p.push({role:"system",content:Z,ignoreInstruct:!0}),j()}else{let Q=(B=N,(0,de.setOpenAIMessages)(B)),ee=function(e){return(0,de.setOpenAIMessageExamples)(e)}(E);async function te(){let[e,t]=await function({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:i,bias:s,type:a,quietPrompt:c,quietImage:l,extensionPrompts:u,cyclePrompt:h,systemPromptOverride:d,jailbreakPromptOverride:p,personaDescription:f,messages:g,messageExamples:m},v){return(0,de.prepareOpenAIMessages)({name2:e,charDescription:t,charPersonality:n,Scenario:r,worldInfoBefore:o,worldInfoAfter:i,bias:s,type:a,quietPrompt:c,quietImage:l,cyclePrompt:h,systemPromptOverride:d,jailbreakPromptOverride:p,personaDescription:f,extensionPrompts:u,messages:g,messageExamples:m},v)}({name2:ce.name2,charDescription:f,charPersonality:g,Scenario:v,worldInfoBefore:I,worldInfoAfter:O,extensionPrompts:d.extensionPrompts,bias:"",type:"normal",quietPrompt:void 0,quietImage:void 0,cyclePrompt:"",systemPromptOverride:x,jailbreakPromptOverride:b,personaDescription:m,messages:Q,messageExamples:ee},!1);p.push(...e)}if(!n)return await te(),p;const ne=d.getPresetManager("openai")?.getCompletionPresetByName(n);if(!ne)return console.warn(`Preset not found: ${n}. Using current preset.`),te(),p;let re=ne.prompt_order.find((e=>e.character_id===ce.this_chid));if(!re&&ne.prompt_order.length>0&&(re=ne.prompt_order[0]),!re)return console.warn(`No prompt order found for preset: ${n}. Using current preset.`),te(),p;const oe=v&&ne.scenario_format?d.substituteParams(ne.scenario_format):"",ie=g&&ne.personality_format?d.substituteParams(ne.personality_format):"",se=d.substituteParams(ne.group_nudge_prompt),me=ne.impersonation_prompt?d.substituteParams(ne.impersonation_prompt):"",Ee=[];u&&Ee.push({role:"system",content:we(I,{wiFormat:ne.wi_format}),identifier:"worldInfoBefore"},{role:"system",content:we(O,{wiFormat:ne.wi_format}),identifier:"worldInfoAfter"}),c||Ee.push({role:"system",content:f,identifier:"charDescription"},{role:"system",content:ie,identifier:"charPersonality"},{role:"system",content:oe,identifier:"scenario"}),Ee.push({role:"system",content:me,identifier:"impersonate"},{role:"system",content:se,identifier:"groupNudge"});const Se=d.extensionPrompts["1_memory"];Se&&Se.value&&Ee.push({role:be(Se.role),content:Se.value,identifier:"summary",position:Ce(Se.position)});const Ae=d.extensionPrompts["2_floating_prompt"];!l&&Ae&&Ae.value&&Ee.push({role:be(Ae.role),content:Ae.value,identifier:"authorsNote",position:Ce(Ae.position)});const _e=d.extensionPrompts["3_vectors"];_e&&_e.value&&Ee.push({role:"system",content:_e.value,identifier:"vectorsMemory",position:Ce(_e.position)});const Pe=d.extensionPrompts["4_vectors_data_bank"];Pe&&Pe.value&&Ee.push({role:be(Pe.role),content:Pe.value,identifier:"vectorsDataBank",position:Ce(Pe.position)});const Ne=d.extensionPrompts.chromadb;Ne&&Ne.value&&Ee.push({role:"system",content:Ne.value,identifier:"smartContext",position:Ce(Ne.position)}),!c&&d.powerUserSettings.persona_description&&d.powerUserSettings.persona_description_position===ae.persona_description_positions.IN_PROMPT&&Ee.push({role:"system",content:d.powerUserSettings.persona_description,identifier:"personaDescription"}),re.order.forEach((e=>{if(!e.enabled)return;const t=(n=e.identifier,Ee.find((e=>e.identifier===n)));var n;t&&t.content?p.push({role:t.role??"system",content:d.substituteParams(t.content)}):"chatHistory"===e.identifier&&j()}))}var B,R,$;const V=["1_memory","2_floating_prompt","3_vectors","4_vectors_data_bank","chromadb","PERSONA_DESCRIPTION","QUIET_PROMPT","DEPTH_PROMPT"];for(const ke in d.extensionPrompts)if(Object.hasOwn(d.extensionPrompts,ke)){const Te=d.extensionPrompts[ke];if(V.includes(ke))continue;if(!d.extensionPrompts[ke].value)continue;if(![ce.extension_prompt_types.BEFORE_PROMPT,ce.extension_prompt_types.IN_PROMPT].includes(Te.position))continue;if("function"==typeof Te.filter&&!await Te.filter())continue;Te.position===ce.extension_prompt_types.BEFORE_PROMPT?p=[...p.slice(0,Te.depth),{role:be(Te.role)??"system",content:Te.value},...p.slice(Te.depth)]:Te.position===ce.extension_prompt_types.IN_PROMPT&&(p=[...p.slice(0,p.length-Te.depth),{role:be(Te.role)??"system",content:Te.value},...p.slice(p.length-Te.depth)])}for(const Ie of F)p=[...p.slice(0,p.length-Ie.depth),{role:be(Ie.role),content:Ie.entries.join("\n")},...p.slice(p.length-Ie.depth)];if(!c){const Oe=(q=fe.selected_group,W=Number(ce.this_chid),(0,fe.getGroupDepthPrompts)(q,W));if(fe.selected_group&&Array.isArray(Oe)&&Oe.length>0)Oe.filter((e=>e.text)).forEach(((e,t)=>{p=[...p.slice(0,p.length-e.depth),{role:e.role,content:e.text},...p.slice(p.length-e.depth)]}));else{const De=xe(d.characters[ce.this_chid]?.data?.extensions?.depth_prompt?.prompt?.trim(),ce.name1,ce.name2)||"";if(De){const Fe=ce.depth_prompt_depth_default,Le=d.characters[ce.this_chid]?.data?.extensions?.depth_prompt?.role??ce.depth_prompt_role_default;p=[...p.slice(0,p.length-Fe),{role:be(Le),content:De},...p.slice(p.length-Fe)]}}}var q,W;let G=-1;if(!l){const Me={prompt:ce.chat_metadata[pe.metadata_keys.prompt],interval:ce.chat_metadata[pe.metadata_keys.interval],position:ce.chat_metadata[pe.metadata_keys.position],depth:ce.chat_metadata[pe.metadata_keys.depth],role:ce.chat_metadata[pe.metadata_keys.role]};if(Me.prompt)switch(Me.prompt=xe(Me.prompt,ce.name1,ce.name2),Me.position){case ce.extension_prompt_types.IN_PROMPT:p=[...p.slice(0,1),{role:"user",content:Me.prompt},...p.slice(1)],G=1;break;case ce.extension_prompt_types.IN_CHAT:p=[...p.slice(0,p.length-Me.depth),{role:be(Me.role),content:Me.prompt},...p.slice(p.length-Me.depth)],G=p.length-Me.depth-1;break;case ce.extension_prompt_types.BEFORE_PROMPT:p.unshift({role:"user",content:Me.prompt}),G=0}}return G>=0&&(L.length>0&&(p=[...p.slice(0,G),{role:"system",content:L.join("\n")},...p.slice(G)],G++),M.length>0&&(p=[...p.slice(0,G+1),{role:"system",content:M.join("\n")},...p.slice(G+1)])),p}var Ae,_e;!function(e){e[e.TEXT=1]="TEXT",e[e.CONFIRM=2]="CONFIRM",e[e.INPUT=3]="INPUT",e[e.DISPLAY=4]="DISPLAY"}(Ae||(Ae={})),function(e){e[e.AFFIRMATIVE=1]="AFFIRMATIVE",e[e.NEGATIVE=0]="NEGATIVE",e[e.CANCELLED=null]="CANCELLED"}(_e||(_e={}));const Pe=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",Ne=new RegExp("^"+("["+Pe+"]["+(Pe+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040")+"]*")+"$");function ke(e,t){const n=[];let r=t.exec(e);for(;r;){const o=[];o.startIndex=t.lastIndex-r[0].length;const i=r.length;for(let e=0;e<i;e++)o.push(r[e]);n.push(o),r=t.exec(e)}return n}const Te=function(e){const t=Ne.exec(e);return!(null==t)};const Ie={allowBooleanAttributes:!1,unpairedTags:[]};function Oe(e,t){t=Object.assign({},Ie,t);const n=[];let r=!1,o=!1;"\ufeff"===e[0]&&(e=e.substr(1));for(let i=0;i<e.length;i++)if("<"===e[i]&&"?"===e[i+1]){if(i+=2,i=Fe(e,i),i.err)return i}else{if("<"!==e[i]){if(De(e[i]))continue;return qe("InvalidChar","char '"+e[i]+"' is not expected.",Ge(e,i))}{let s=i;if(i++,"!"===e[i]){i=Le(e,i);continue}{let a=!1;"/"===e[i]&&(a=!0,i++);let c="";for(;i<e.length&&">"!==e[i]&&" "!==e[i]&&"\t"!==e[i]&&"\n"!==e[i]&&"\r"!==e[i];i++)c+=e[i];if(c=c.trim(),"/"===c[c.length-1]&&(c=c.substring(0,c.length-1),i--),!Te(c)){let t;return t=0===c.trim().length?"Invalid space after '<'.":"Tag '"+c+"' is an invalid name.",qe("InvalidTag",t,Ge(e,i))}const l=Be(e,i);if(!1===l)return qe("InvalidAttr","Attributes for '"+c+"' have open quote.",Ge(e,i));let u=l.value;if(i=l.index,"/"===u[u.length-1]){const n=i-u.length;u=u.substring(0,u.length-1);const o=$e(u,t);if(!0!==o)return qe(o.err.code,o.err.msg,Ge(e,n+o.err.line));r=!0}else if(a){if(!l.tagClosed)return qe("InvalidTag","Closing tag '"+c+"' doesn't have proper closing.",Ge(e,i));if(u.trim().length>0)return qe("InvalidTag","Closing tag '"+c+"' can't have attributes or invalid starting.",Ge(e,s));if(0===n.length)return qe("InvalidTag","Closing tag '"+c+"' has not been opened.",Ge(e,s));{const t=n.pop();if(c!==t.tagName){let n=Ge(e,t.tagStartPos);return qe("InvalidTag","Expected closing tag '"+t.tagName+"' (opened in line "+n.line+", col "+n.col+") instead of closing tag '"+c+"'.",Ge(e,s))}0==n.length&&(o=!0)}}else{const a=$e(u,t);if(!0!==a)return qe(a.err.code,a.err.msg,Ge(e,i-u.length+a.err.line));if(!0===o)return qe("InvalidXml","Multiple possible root nodes found.",Ge(e,i));-1!==t.unpairedTags.indexOf(c)||n.push({tagName:c,tagStartPos:s}),r=!0}for(i++;i<e.length;i++)if("<"===e[i]){if("!"===e[i+1]){i++,i=Le(e,i);continue}if("?"!==e[i+1])break;if(i=Fe(e,++i),i.err)return i}else if("&"===e[i]){const t=Ve(e,i);if(-1==t)return qe("InvalidChar","char '&' is not expected.",Ge(e,i));i=t}else if(!0===o&&!De(e[i]))return qe("InvalidXml","Extra text at the end",Ge(e,i));"<"===e[i]&&i--}}}return r?1==n.length?qe("InvalidTag","Unclosed tag '"+n[0].tagName+"'.",Ge(e,n[0].tagStartPos)):!(n.length>0)||qe("InvalidXml","Invalid '"+JSON.stringify(n.map((e=>e.tagName)),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1}):qe("InvalidXml","Start tag expected.",1)}function De(e){return" "===e||"\t"===e||"\n"===e||"\r"===e}function Fe(e,t){const n=t;for(;t<e.length;t++)if("?"!=e[t]&&" "!=e[t]);else{const r=e.substr(n,t-n);if(t>5&&"xml"===r)return qe("InvalidXml","XML declaration allowed only at the start of the document.",Ge(e,t));if("?"==e[t]&&">"==e[t+1]){t++;break}}return t}function Le(e,t){if(e.length>t+5&&"-"===e[t+1]&&"-"===e[t+2]){for(t+=3;t<e.length;t++)if("-"===e[t]&&"-"===e[t+1]&&">"===e[t+2]){t+=2;break}}else if(e.length>t+8&&"D"===e[t+1]&&"O"===e[t+2]&&"C"===e[t+3]&&"T"===e[t+4]&&"Y"===e[t+5]&&"P"===e[t+6]&&"E"===e[t+7]){let n=1;for(t+=8;t<e.length;t++)if("<"===e[t])n++;else if(">"===e[t]&&(n--,0===n))break}else if(e.length>t+9&&"["===e[t+1]&&"C"===e[t+2]&&"D"===e[t+3]&&"A"===e[t+4]&&"T"===e[t+5]&&"A"===e[t+6]&&"["===e[t+7])for(t+=8;t<e.length;t++)if("]"===e[t]&&"]"===e[t+1]&&">"===e[t+2]){t+=2;break}return t}const Me='"',je="'";function Be(e,t){let n="",r="",o=!1;for(;t<e.length;t++){if(e[t]===Me||e[t]===je)""===r?r=e[t]:r!==e[t]||(r="");else if(">"===e[t]&&""===r){o=!0;break}n+=e[t]}return""===r&&{value:n,index:t,tagClosed:o}}const Re=new RegExp("(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['\"])(([\\s\\S])*?)\\5)?","g");function $e(e,t){const n=ke(e,Re),r={};for(let e=0;e<n.length;e++){if(0===n[e][1].length)return qe("InvalidAttr","Attribute '"+n[e][2]+"' has no space in starting.",Ue(n[e]));if(void 0!==n[e][3]&&void 0===n[e][4])return qe("InvalidAttr","Attribute '"+n[e][2]+"' is without value.",Ue(n[e]));if(void 0===n[e][3]&&!t.allowBooleanAttributes)return qe("InvalidAttr","boolean attribute '"+n[e][2]+"' is not allowed.",Ue(n[e]));const o=n[e][2];if(!We(o))return qe("InvalidAttr","Attribute '"+o+"' is an invalid name.",Ue(n[e]));if(r.hasOwnProperty(o))return qe("InvalidAttr","Attribute '"+o+"' is repeated.",Ue(n[e]));r[o]=1}return!0}function Ve(e,t){if(";"===e[++t])return-1;if("#"===e[t])return function(e,t){let n=/\d/;for("x"===e[t]&&(t++,n=/[\da-fA-F]/);t<e.length;t++){if(";"===e[t])return t;if(!e[t].match(n))break}return-1}(e,++t);let n=0;for(;t<e.length;t++,n++)if(!(e[t].match(/\w/)&&n<20)){if(";"===e[t])break;return-1}return t}function qe(e,t,n){return{err:{code:e,msg:t,line:n.line||n,col:n.col}}}function We(e){return Te(e)}function Ge(e,t){const n=e.substring(0,t).split(/\r?\n/);return{line:n.length,col:n[n.length-1].length+1}}function Ue(e){return e.startIndex+e[1].length}const He={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(e,t,n){return e}};class Xe{constructor(e){this.tagname=e,this.child=[],this[":@"]={}}add(e,t){"__proto__"===e&&(e="#__proto__"),this.child.push({[e]:t})}addChild(e){"__proto__"===e.tagname&&(e.tagname="#__proto__"),e[":@"]&&Object.keys(e[":@"]).length>0?this.child.push({[e.tagname]:e.child,":@":e[":@"]}):this.child.push({[e.tagname]:e.child})}}function Ye(e,t){const n={};if("O"!==e[t+3]||"C"!==e[t+4]||"T"!==e[t+5]||"Y"!==e[t+6]||"P"!==e[t+7]||"E"!==e[t+8])throw new Error("Invalid Tag instead of DOCTYPE");{t+=9;let r=1,o=!1,i=!1,s="";for(;t<e.length;t++)if("<"!==e[t]||i)if(">"===e[t]){if(i?"-"===e[t-1]&&"-"===e[t-2]&&(i=!1,r--):r--,0===r)break}else"["===e[t]?o=!0:s+=e[t];else{if(o&&Ke(e,t)){let r,o;t+=7,[r,o,t]=ze(e,t+1),-1===o.indexOf("&")&&(n[tt(r)]={regx:RegExp(`&${r};`,"g"),val:o})}else if(o&&Ze(e,t))t+=8;else if(o&&Qe(e,t))t+=8;else if(o&&et(e,t))t+=9;else{if(!Je)throw new Error("Invalid DOCTYPE");i=!0}r++,s=""}if(0!==r)throw new Error("Unclosed DOCTYPE")}return{entities:n,i:t}}function ze(e,t){let n="";for(;t<e.length&&"'"!==e[t]&&'"'!==e[t];t++)n+=e[t];if(n=n.trim(),-1!==n.indexOf(" "))throw new Error("External entites are not supported");const r=e[t++];let o="";for(;t<e.length&&e[t]!==r;t++)o+=e[t];return[n,o,t]}function Je(e,t){return"!"===e[t+1]&&"-"===e[t+2]&&"-"===e[t+3]}function Ke(e,t){return"!"===e[t+1]&&"E"===e[t+2]&&"N"===e[t+3]&&"T"===e[t+4]&&"I"===e[t+5]&&"T"===e[t+6]&&"Y"===e[t+7]}function Ze(e,t){return"!"===e[t+1]&&"E"===e[t+2]&&"L"===e[t+3]&&"E"===e[t+4]&&"M"===e[t+5]&&"E"===e[t+6]&&"N"===e[t+7]&&"T"===e[t+8]}function Qe(e,t){return"!"===e[t+1]&&"A"===e[t+2]&&"T"===e[t+3]&&"T"===e[t+4]&&"L"===e[t+5]&&"I"===e[t+6]&&"S"===e[t+7]&&"T"===e[t+8]}function et(e,t){return"!"===e[t+1]&&"N"===e[t+2]&&"O"===e[t+3]&&"T"===e[t+4]&&"A"===e[t+5]&&"T"===e[t+6]&&"I"===e[t+7]&&"O"===e[t+8]&&"N"===e[t+9]}function tt(e){if(Te(e))return e;throw new Error(`Invalid entity name ${e}`)}const nt=/^[-+]?0x[a-fA-F0-9]+$/,rt=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,ot={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function it(e,t={}){if(t=Object.assign({},ot,t),!e||"string"!=typeof e)return e;let n=e.trim();if(void 0!==t.skipLike&&t.skipLike.test(n))return e;if("0"===e)return 0;if(t.hex&&nt.test(n))return function(e,t){if(parseInt)return parseInt(e,t);if(Number.parseInt)return Number.parseInt(e,t);if(window&&window.parseInt)return window.parseInt(e,t);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}(n,16);if(-1!==n.search(/[eE]/)){const r=n.match(/^([-\+])?(0*)([0-9]*(\.[0-9]*)?[eE][-\+]?[0-9]+)$/);if(r){if(t.leadingZeros)n=(r[1]||"")+r[3];else if("0"!==r[2]||"."!==r[3][0])return e;return t.eNotation?Number(n):e}return e}{const r=rt.exec(n);if(r){const o=r[1],i=r[2];let s=function(e){if(e&&-1!==e.indexOf("."))return"."===(e=e.replace(/0+$/,""))?e="0":"."===e[0]?e="0"+e:"."===e[e.length-1]&&(e=e.substr(0,e.length-1)),e;return e}(r[3]);if(!t.leadingZeros&&i.length>0&&o&&"."!==n[2])return e;if(!t.leadingZeros&&i.length>0&&!o&&"."!==n[1])return e;if(t.leadingZeros&&i===e)return 0;{const r=Number(n),a=""+r;return-1!==a.search(/[eE]/)?t.eNotation?r:e:-1!==n.indexOf(".")?"0"===a&&""===s||a===s||o&&a==="-"+s?r:e:i?s===a||o+s===a?r:e:n===a||n===o+a?r:e}}return e}}function st(e){return"function"==typeof e?e:Array.isArray(e)?t=>{for(const n of e){if("string"==typeof n&&t===n)return!0;if(n instanceof RegExp&&n.test(t))return!0}}:()=>!1}class at{constructor(e){this.options=e,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(e,t)=>String.fromCodePoint(Number.parseInt(t,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(e,t)=>String.fromCodePoint(Number.parseInt(t,16))}},this.addExternalEntities=ct,this.parseXml=pt,this.parseTextData=lt,this.resolveNameSpace=ut,this.buildAttributesMap=dt,this.isItStopNode=vt,this.replaceEntitiesValue=gt,this.readStopNodeData=bt,this.saveTextToParentTag=mt,this.addChild=ft,this.ignoreAttributesFn=st(this.options.ignoreAttributes)}}function ct(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];this.lastEntities[r]={regex:new RegExp("&"+r+";","g"),val:e[r]}}}function lt(e,t,n,r,o,i,s){if(void 0!==e&&(this.options.trimValues&&!r&&(e=e.trim()),e.length>0)){s||(e=this.replaceEntitiesValue(e));const r=this.options.tagValueProcessor(t,e,n,o,i);if(null==r)return e;if(typeof r!=typeof e||r!==e)return r;if(this.options.trimValues)return wt(e,this.options.parseTagValue,this.options.numberParseOptions);return e.trim()===e?wt(e,this.options.parseTagValue,this.options.numberParseOptions):e}}function ut(e){if(this.options.removeNSPrefix){const t=e.split(":"),n="/"===e.charAt(0)?"/":"";if("xmlns"===t[0])return"";2===t.length&&(e=n+t[1])}return e}const ht=new RegExp("([^\\s=]+)\\s*(=\\s*(['\"])([\\s\\S]*?)\\3)?","gm");function dt(e,t,n){if(!0!==this.options.ignoreAttributes&&"string"==typeof e){const n=ke(e,ht),r=n.length,o={};for(let e=0;e<r;e++){const r=this.resolveNameSpace(n[e][1]);if(this.ignoreAttributesFn(r,t))continue;let i=n[e][4],s=this.options.attributeNamePrefix+r;if(r.length)if(this.options.transformAttributeName&&(s=this.options.transformAttributeName(s)),"__proto__"===s&&(s="#__proto__"),void 0!==i){this.options.trimValues&&(i=i.trim()),i=this.replaceEntitiesValue(i);const e=this.options.attributeValueProcessor(r,i,t);o[s]=null==e?i:typeof e!=typeof i||e!==i?e:wt(i,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(o[s]=!0)}if(!Object.keys(o).length)return;if(this.options.attributesGroupName){const e={};return e[this.options.attributesGroupName]=o,e}return o}}const pt=function(e){e=e.replace(/\r\n?/g,"\n");const t=new Xe("!xml");let n=t,r="",o="";for(let i=0;i<e.length;i++){if("<"===e[i])if("/"===e[i+1]){const t=yt(e,">",i,"Closing Tag is not closed.");let s=e.substring(i+2,t).trim();if(this.options.removeNSPrefix){const e=s.indexOf(":");-1!==e&&(s=s.substr(e+1))}this.options.transformTagName&&(s=this.options.transformTagName(s)),n&&(r=this.saveTextToParentTag(r,n,o));const a=o.substring(o.lastIndexOf(".")+1);if(s&&-1!==this.options.unpairedTags.indexOf(s))throw new Error(`Unpaired tag can not be used as closing tag: </${s}>`);let c=0;a&&-1!==this.options.unpairedTags.indexOf(a)?(c=o.lastIndexOf(".",o.lastIndexOf(".")-1),this.tagsNodeStack.pop()):c=o.lastIndexOf("."),o=o.substring(0,c),n=this.tagsNodeStack.pop(),r="",i=t}else if("?"===e[i+1]){let t=xt(e,i,!1,"?>");if(!t)throw new Error("Pi Tag is not closed.");if(r=this.saveTextToParentTag(r,n,o),this.options.ignoreDeclaration&&"?xml"===t.tagName||this.options.ignorePiTags);else{const e=new Xe(t.tagName);e.add(this.options.textNodeName,""),t.tagName!==t.tagExp&&t.attrExpPresent&&(e[":@"]=this.buildAttributesMap(t.tagExp,o,t.tagName)),this.addChild(n,e,o)}i=t.closeIndex+1}else if("!--"===e.substr(i+1,3)){const t=yt(e,"--\x3e",i+4,"Comment is not closed.");if(this.options.commentPropName){const s=e.substring(i+4,t-2);r=this.saveTextToParentTag(r,n,o),n.add(this.options.commentPropName,[{[this.options.textNodeName]:s}])}i=t}else if("!D"===e.substr(i+1,2)){const t=Ye(e,i);this.docTypeEntities=t.entities,i=t.i}else if("!["===e.substr(i+1,2)){const t=yt(e,"]]>",i,"CDATA is not closed.")-2,s=e.substring(i+9,t);r=this.saveTextToParentTag(r,n,o);let a=this.parseTextData(s,n.tagname,o,!0,!1,!0,!0);null==a&&(a=""),this.options.cdataPropName?n.add(this.options.cdataPropName,[{[this.options.textNodeName]:s}]):n.add(this.options.textNodeName,a),i=t+2}else{let s=xt(e,i,this.options.removeNSPrefix),a=s.tagName;const c=s.rawTagName;let l=s.tagExp,u=s.attrExpPresent,h=s.closeIndex;this.options.transformTagName&&(a=this.options.transformTagName(a)),n&&r&&"!xml"!==n.tagname&&(r=this.saveTextToParentTag(r,n,o,!1));const d=n;if(d&&-1!==this.options.unpairedTags.indexOf(d.tagname)&&(n=this.tagsNodeStack.pop(),o=o.substring(0,o.lastIndexOf("."))),a!==t.tagname&&(o+=o?"."+a:a),this.isItStopNode(this.options.stopNodes,o,a)){let t="";if(l.length>0&&l.lastIndexOf("/")===l.length-1)"/"===a[a.length-1]?(a=a.substr(0,a.length-1),o=o.substr(0,o.length-1),l=a):l=l.substr(0,l.length-1),i=s.closeIndex;else if(-1!==this.options.unpairedTags.indexOf(a))i=s.closeIndex;else{const n=this.readStopNodeData(e,c,h+1);if(!n)throw new Error(`Unexpected end of ${c}`);i=n.i,t=n.tagContent}const r=new Xe(a);a!==l&&u&&(r[":@"]=this.buildAttributesMap(l,o,a)),t&&(t=this.parseTextData(t,a,o,!0,u,!0,!0)),o=o.substr(0,o.lastIndexOf(".")),r.add(this.options.textNodeName,t),this.addChild(n,r,o)}else{if(l.length>0&&l.lastIndexOf("/")===l.length-1){"/"===a[a.length-1]?(a=a.substr(0,a.length-1),o=o.substr(0,o.length-1),l=a):l=l.substr(0,l.length-1),this.options.transformTagName&&(a=this.options.transformTagName(a));const e=new Xe(a);a!==l&&u&&(e[":@"]=this.buildAttributesMap(l,o,a)),this.addChild(n,e,o),o=o.substr(0,o.lastIndexOf("."))}else{const e=new Xe(a);this.tagsNodeStack.push(n),a!==l&&u&&(e[":@"]=this.buildAttributesMap(l,o,a)),this.addChild(n,e,o),n=e}r="",i=h}}else r+=e[i]}return t.child};function ft(e,t,n){const r=this.options.updateTag(t.tagname,n,t[":@"]);!1===r||("string"==typeof r?(t.tagname=r,e.addChild(t)):e.addChild(t))}const gt=function(e){if(this.options.processEntities){for(let t in this.docTypeEntities){const n=this.docTypeEntities[t];e=e.replace(n.regx,n.val)}for(let t in this.lastEntities){const n=this.lastEntities[t];e=e.replace(n.regex,n.val)}if(this.options.htmlEntities)for(let t in this.htmlEntities){const n=this.htmlEntities[t];e=e.replace(n.regex,n.val)}e=e.replace(this.ampEntity.regex,this.ampEntity.val)}return e};function mt(e,t,n,r){return e&&(void 0===r&&(r=0===t.child.length),void 0!==(e=this.parseTextData(e,t.tagname,n,!1,!!t[":@"]&&0!==Object.keys(t[":@"]).length,r))&&""!==e&&t.add(this.options.textNodeName,e),e=""),e}function vt(e,t,n){const r="*."+n;for(const n in e){const o=e[n];if(r===o||t===o)return!0}return!1}function yt(e,t,n,r){const o=e.indexOf(t,n);if(-1===o)throw new Error(r);return o+t.length-1}function xt(e,t,n,r=">"){const o=function(e,t,n=">"){let r,o="";for(let i=t;i<e.length;i++){let t=e[i];if(r)t===r&&(r="");else if('"'===t||"'"===t)r=t;else if(t===n[0]){if(!n[1])return{data:o,index:i};if(e[i+1]===n[1])return{data:o,index:i}}else"\t"===t&&(t=" ");o+=t}}(e,t+1,r);if(!o)return;let i=o.data;const s=o.index,a=i.search(/\s/);let c=i,l=!0;-1!==a&&(c=i.substring(0,a),i=i.substring(a+1).trimStart());const u=c;if(n){const e=c.indexOf(":");-1!==e&&(c=c.substr(e+1),l=c!==o.data.substr(e+1))}return{tagName:c,tagExp:i,closeIndex:s,attrExpPresent:l,rawTagName:u}}function bt(e,t,n){const r=n;let o=1;for(;n<e.length;n++)if("<"===e[n])if("/"===e[n+1]){const i=yt(e,">",n,`${t} is not closed`);if(e.substring(n+2,i).trim()===t&&(o--,0===o))return{tagContent:e.substring(r,n),i};n=i}else if("?"===e[n+1]){n=yt(e,"?>",n+1,"StopNode is not closed.")}else if("!--"===e.substr(n+1,3)){n=yt(e,"--\x3e",n+3,"StopNode is not closed.")}else if("!["===e.substr(n+1,2)){n=yt(e,"]]>",n,"StopNode is not closed.")-2}else{const r=xt(e,n,">");if(r){(r&&r.tagName)===t&&"/"!==r.tagExp[r.tagExp.length-1]&&o++,n=r.closeIndex}}}function wt(e,t,n){if(t&&"string"==typeof e){const t=e.trim();return"true"===t||"false"!==t&&it(e,n)}return void 0!==e?e:""}function Ct(e,t){return Et(e,t)}function Et(e,t,n){let r;const o={};for(let i=0;i<e.length;i++){const s=e[i],a=St(s);let c="";if(c=void 0===n?a:n+"."+a,a===t.textNodeName)void 0===r?r=s[a]:r+=""+s[a];else{if(void 0===a)continue;if(s[a]){let e=Et(s[a],t,c);const n=_t(e,t);s[":@"]?At(e,s[":@"],c,t):1!==Object.keys(e).length||void 0===e[t.textNodeName]||t.alwaysCreateTextNode?0===Object.keys(e).length&&(t.alwaysCreateTextNode?e[t.textNodeName]="":e=""):e=e[t.textNodeName],void 0!==o[a]&&o.hasOwnProperty(a)?(Array.isArray(o[a])||(o[a]=[o[a]]),o[a].push(e)):t.isArray(a,c,n)?o[a]=[e]:o[a]=e}}}return"string"==typeof r?r.length>0&&(o[t.textNodeName]=r):void 0!==r&&(o[t.textNodeName]=r),o}function St(e){const t=Object.keys(e);for(let e=0;e<t.length;e++){const n=t[e];if(":@"!==n)return n}}function At(e,t,n,r){if(t){const o=Object.keys(t),i=o.length;for(let s=0;s<i;s++){const i=o[s];r.isArray(i,n+"."+i,!0,!0)?e[i]=[t[i]]:e[i]=t[i]}}}function _t(e,t){const{textNodeName:n}=t,r=Object.keys(e).length;return 0===r||!(1!==r||!e[n]&&"boolean"!=typeof e[n]&&0!==e[n])}function Pt(e,t){let n="";return t.format&&t.indentBy.length>0&&(n="\n"),Nt(e,t,"",n)}function Nt(e,t,n,r){let o="",i=!1;for(let s=0;s<e.length;s++){const a=e[s],c=kt(a);if(void 0===c)continue;let l="";if(l=0===n.length?c:`${n}.${c}`,c===t.textNodeName){let e=a[c];It(l,t)||(e=t.tagValueProcessor(c,e),e=Ot(e,t)),i&&(o+=r),o+=e,i=!1;continue}if(c===t.cdataPropName){i&&(o+=r),o+=`<![CDATA[${a[c][0][t.textNodeName]}]]>`,i=!1;continue}if(c===t.commentPropName){o+=r+`\x3c!--${a[c][0][t.textNodeName]}--\x3e`,i=!0;continue}if("?"===c[0]){const e=Tt(a[":@"],t),n="?xml"===c?"":r;let s=a[c][0][t.textNodeName];s=0!==s.length?" "+s:"",o+=n+`<${c}${s}${e}?>`,i=!0;continue}let u=r;""!==u&&(u+=t.indentBy);const h=r+`<${c}${Tt(a[":@"],t)}`,d=Nt(a[c],t,l,u);-1!==t.unpairedTags.indexOf(c)?t.suppressUnpairedNode?o+=h+">":o+=h+"/>":d&&0!==d.length||!t.suppressEmptyNode?d&&d.endsWith(">")?o+=h+`>${d}${r}</${c}>`:(o+=h+">",d&&""!==r&&(d.includes("/>")||d.includes("</"))?o+=r+t.indentBy+d+r:o+=d,o+=`</${c}>`):o+=h+"/>",i=!0}return o}function kt(e){const t=Object.keys(e);for(let n=0;n<t.length;n++){const r=t[n];if(e.hasOwnProperty(r)&&":@"!==r)return r}}function Tt(e,t){let n="";if(e&&!t.ignoreAttributes)for(let r in e){if(!e.hasOwnProperty(r))continue;let o=t.attributeValueProcessor(r,e[r]);o=Ot(o,t),!0===o&&t.suppressBooleanAttributes?n+=` ${r.substr(t.attributeNamePrefix.length)}`:n+=` ${r.substr(t.attributeNamePrefix.length)}="${o}"`}return n}function It(e,t){let n=(e=e.substr(0,e.length-t.textNodeName.length-1)).substr(e.lastIndexOf(".")+1);for(let r in t.stopNodes)if(t.stopNodes[r]===e||t.stopNodes[r]==="*."+n)return!0;return!1}function Ot(e,t){if(e&&e.length>0&&t.processEntities)for(let n=0;n<t.entities.length;n++){const r=t.entities[n];e=e.replace(r.regex,r.val)}return e}const Dt={attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,cdataPropName:!1,format:!1,indentBy:"  ",suppressEmptyNode:!1,suppressUnpairedNode:!0,suppressBooleanAttributes:!0,tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},preserveOrder:!1,commentPropName:!1,unpairedTags:[],entities:[{regex:new RegExp("&","g"),val:"&amp;"},{regex:new RegExp(">","g"),val:"&gt;"},{regex:new RegExp("<","g"),val:"&lt;"},{regex:new RegExp("'","g"),val:"&apos;"},{regex:new RegExp('"',"g"),val:"&quot;"}],processEntities:!0,stopNodes:[],oneListGroup:!1};function Ft(e){this.options=Object.assign({},Dt,e),!0===this.options.ignoreAttributes||this.options.attributesGroupName?this.isAttribute=function(){return!1}:(this.ignoreAttributesFn=st(this.options.ignoreAttributes),this.attrPrefixLen=this.options.attributeNamePrefix.length,this.isAttribute=jt),this.processTextOrObjNode=Lt,this.options.format?(this.indentate=Mt,this.tagEndChar=">\n",this.newLine="\n"):(this.indentate=function(){return""},this.tagEndChar=">",this.newLine="")}function Lt(e,t,n,r){const o=this.j2x(e,n+1,r.concat(t));return void 0!==e[this.options.textNodeName]&&1===Object.keys(e).length?this.buildTextValNode(e[this.options.textNodeName],t,o.attrStr,n):this.buildObjectNode(o.val,t,o.attrStr,n)}function Mt(e){return this.options.indentBy.repeat(e)}function jt(e){return!(!e.startsWith(this.options.attributeNamePrefix)||e===this.options.textNodeName)&&e.substr(this.attrPrefixLen)}Ft.prototype.build=function(e){return this.options.preserveOrder?Pt(e,this.options):(Array.isArray(e)&&this.options.arrayNodeName&&this.options.arrayNodeName.length>1&&(e={[this.options.arrayNodeName]:e}),this.j2x(e,0,[]).val)},Ft.prototype.j2x=function(e,t,n){let r="",o="";const i=n.join(".");for(let s in e)if(Object.prototype.hasOwnProperty.call(e,s))if(void 0===e[s])this.isAttribute(s)&&(o+="");else if(null===e[s])this.isAttribute(s)||s===this.options.cdataPropName?o+="":"?"===s[0]?o+=this.indentate(t)+"<"+s+"?"+this.tagEndChar:o+=this.indentate(t)+"<"+s+"/"+this.tagEndChar;else if(e[s]instanceof Date)o+=this.buildTextValNode(e[s],s,"",t);else if("object"!=typeof e[s]){const n=this.isAttribute(s);if(n&&!this.ignoreAttributesFn(n,i))r+=this.buildAttrPairStr(n,""+e[s]);else if(!n)if(s===this.options.textNodeName){let t=this.options.tagValueProcessor(s,""+e[s]);o+=this.replaceEntitiesValue(t)}else o+=this.buildTextValNode(e[s],s,"",t)}else if(Array.isArray(e[s])){const r=e[s].length;let i="",a="";for(let c=0;c<r;c++){const r=e[s][c];if(void 0===r);else if(null===r)"?"===s[0]?o+=this.indentate(t)+"<"+s+"?"+this.tagEndChar:o+=this.indentate(t)+"<"+s+"/"+this.tagEndChar;else if("object"==typeof r)if(this.options.oneListGroup){const e=this.j2x(r,t+1,n.concat(s));i+=e.val,this.options.attributesGroupName&&r.hasOwnProperty(this.options.attributesGroupName)&&(a+=e.attrStr)}else i+=this.processTextOrObjNode(r,s,t,n);else if(this.options.oneListGroup){let e=this.options.tagValueProcessor(s,r);e=this.replaceEntitiesValue(e),i+=e}else i+=this.buildTextValNode(r,s,"",t)}this.options.oneListGroup&&(i=this.buildObjectNode(i,s,a,t)),o+=i}else if(this.options.attributesGroupName&&s===this.options.attributesGroupName){const t=Object.keys(e[s]),n=t.length;for(let o=0;o<n;o++)r+=this.buildAttrPairStr(t[o],""+e[s][t[o]])}else o+=this.processTextOrObjNode(e[s],s,t,n);return{attrStr:r,val:o}},Ft.prototype.buildAttrPairStr=function(e,t){return t=this.options.attributeValueProcessor(e,""+t),t=this.replaceEntitiesValue(t),this.options.suppressBooleanAttributes&&"true"===t?" "+e:" "+e+'="'+t+'"'},Ft.prototype.buildObjectNode=function(e,t,n,r){if(""===e)return"?"===t[0]?this.indentate(r)+"<"+t+n+"?"+this.tagEndChar:this.indentate(r)+"<"+t+n+this.closeTag(t)+this.tagEndChar;{let o="</"+t+this.tagEndChar,i="";return"?"===t[0]&&(i="?",o=""),!n&&""!==n||-1!==e.indexOf("<")?!1!==this.options.commentPropName&&t===this.options.commentPropName&&0===i.length?this.indentate(r)+`\x3c!--${e}--\x3e`+this.newLine:this.indentate(r)+"<"+t+n+i+this.tagEndChar+e+this.indentate(r)+o:this.indentate(r)+"<"+t+n+i+">"+e+o}},Ft.prototype.closeTag=function(e){let t="";return-1!==this.options.unpairedTags.indexOf(e)?this.options.suppressUnpairedNode||(t="/"):t=this.options.suppressEmptyNode?"/":`></${e}`,t},Ft.prototype.buildTextValNode=function(e,t,n,r){if(!1!==this.options.cdataPropName&&t===this.options.cdataPropName)return this.indentate(r)+`<![CDATA[${e}]]>`+this.newLine;if(!1!==this.options.commentPropName&&t===this.options.commentPropName)return this.indentate(r)+`\x3c!--${e}--\x3e`+this.newLine;if("?"===t[0])return this.indentate(r)+"<"+t+n+"?"+this.tagEndChar;{let o=this.options.tagValueProcessor(t,e);return o=this.replaceEntitiesValue(o),""===o?this.indentate(r)+"<"+t+n+this.closeTag(t)+this.tagEndChar:this.indentate(r)+"<"+t+n+">"+o+"</"+t+this.tagEndChar}},Ft.prototype.replaceEntitiesValue=function(e){if(e&&e.length>0&&this.options.processEntities)for(let t=0;t<this.options.entities.length;t++){const n=this.options.entities[t];e=e.replace(n.regex,n.val)}return e};var Bt=new class{constructor(e){this.externalEntities={},this.options=function(e){return Object.assign({},He,e)}(e)}parse(e,t){if("string"==typeof e);else{if(!e.toString)throw new Error("XML data is accepted in String or Bytes[] form.");e=e.toString()}if(t){!0===t&&(t={});const n=Oe(e,t);if(!0!==n)throw Error(`${n.err.msg}:${n.err.line}:${n.err.col}`)}const n=new at(this.options);n.addExternalEntities(this.externalEntities);const r=n.parseXml(e);return this.options.preserveOrder||void 0===r?r:Ct(r,this.options)}addEntity(e,t){if(-1!==t.indexOf("&"))throw new Error("Entity value can't have '&'");if(-1!==e.indexOf("&")||-1!==e.indexOf(";"))throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if("&"===t)throw new Error("An entity with value '&' is not permitted");this.externalEntities[e]=t}}({ignoreAttributes:!1,allowBooleanAttributes:!0});function Rt(e,t){var n,r,o,i,s=e.replace(/```(xml|json)?/g,"").replace(/```/g,"").trim();try{switch(t){case"xml":var a=Bt.parse(s),c=null!==(n=null!==(r=null==a?void 0:a.response)&&void 0!==r?r:null==a||null===(o=a.root)||void 0===o?void 0:o.response)&&void 0!==n?n:null==a||null===(i=a.data)||void 0===i?void 0:i.response;if("string"==typeof c)return c.trim();if(c&&"string"==typeof c["#text"])return c["#text"].trim();if(c&&Object.keys(c).length>0){var l=Object.values(c)[0];if("string"==typeof l)return l.trim();if("string"==typeof(null==l?void 0:l["#text"]))return l["#text"].trim()}throw new Error("Invalid XML format: <response> tag content not found or not a string.");case"json":var u=JSON.parse(s);if(u&&"string"==typeof u.response)return u.response.trim();if(u&&Object.keys(u.response).length>0)return String(Object.values(u.response)[0]).trim();throw new Error('Invalid JSON format: "response" key not found or its value is not a string.');case"none":return s;default:throw new Error("Unsupported format specified: ".concat(t))}}catch(n){throw console.error("Error parsing response in format '".concat(t,"':"),n),console.error("Raw content received:",e),"xml"===t&&n.message.includes("Invalid XML")?new Error("Model response is not valid XML or does not contain the <response> tag."):"json"===t&&n instanceof SyntaxError?new Error('Model response is not valid JSON or does not follow the {"response": "..."} structure.'):new Error("Failed to parse response as ".concat(t,": ").concat(n.message))}}const $t=(e=>{var t={};return d.d(t,e),t})({Handlebars:()=>h.Handlebars});function Vt(e){return Vt="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},Vt(e)}function qt(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */qt=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},i="function"==typeof Symbol?Symbol:{},s=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var i=t&&t.prototype instanceof v?t:v,s=Object.create(i.prototype),a=new T(r||[]);return o(s,"_invoke",{value:_(e,n,a)}),s}function h(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var d="suspendedStart",p="suspendedYield",f="executing",g="completed",m={};function v(){}function y(){}function x(){}var b={};l(b,s,(function(){return this}));var w=Object.getPrototypeOf,C=w&&w(w(I([])));C&&C!==n&&r.call(C,s)&&(b=C);var E=x.prototype=v.prototype=Object.create(b);function S(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function A(e,t){function n(o,i,s,a){var c=h(e[o],e,i);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==Vt(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,s,a)}),(function(e){n("throw",e,s,a)})):t.resolve(u).then((function(e){l.value=e,s(l)}),(function(e){return n("throw",e,s,a)}))}a(c.arg)}var i;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return i=i?i.then(o,o):o()}})}function _(t,n,r){var o=d;return function(i,s){if(o===f)throw Error("Generator is already running");if(o===g){if("throw"===i)throw s;return{value:e,done:!0}}for(r.method=i,r.arg=s;;){var a=r.delegate;if(a){var c=P(a,r);if(c){if(c===m)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===d)throw o=g,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=f;var l=h(t,n,r);if("normal"===l.type){if(o=r.done?g:p,l.arg===m)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o=g,r.method="throw",r.arg=l.arg)}}}function P(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,P(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var i=h(o,t.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,m;var s=i.arg;return s?s.done?(n[t.resultName]=s.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,m):s:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function N(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function k(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(N,this),this.reset(!0)}function I(t){if(t||""===t){var n=t[s];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,i=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return i.next=i}}throw new TypeError(Vt(t)+" is not iterable")}return y.prototype=x,o(E,"constructor",{value:x,configurable:!0}),o(x,"constructor",{value:y,configurable:!0}),y.displayName=l(x,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,x):(e.__proto__=x,l(e,c,"GeneratorFunction")),e.prototype=Object.create(E),e},t.awrap=function(e){return{__await:e}},S(A.prototype),l(A.prototype,a,(function(){return this})),t.AsyncIterator=A,t.async=function(e,n,r,o,i){void 0===i&&(i=Promise);var s=new A(u(e,n,r,o),i);return t.isGeneratorFunction(n)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},S(E),l(E,c,"Generator"),l(E,s,(function(){return this})),l(E,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=I,T.prototype={constructor:T,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(k),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return a.type="throw",a.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i],a=s.completion;if("root"===s.tryLoc)return o("end");if(s.tryLoc<=this.prev){var c=r.call(s,"catchLoc"),l=r.call(s,"finallyLoc");if(c&&l){if(this.prev<s.catchLoc)return o(s.catchLoc,!0);if(this.prev<s.finallyLoc)return o(s.finallyLoc)}else if(c){if(this.prev<s.catchLoc)return o(s.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return o(s.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var s=i?i.completion:{};return s.type=e,s.arg=t,i?(this.method="next",this.next=i.finallyLoc,m):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),k(n),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;k(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:I(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),m}},t}function Wt(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=Ht(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var i,s=!0,a=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return s=e.done,e},e:function(e){a=!0,i=e},f:function(){try{s||null==n.return||n.return()}finally{if(a)throw i}}}}function Gt(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,i,s,a=[],c=!0,l=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=i.call(n)).done)&&(a.push(r.value),a.length!==t);c=!0);}catch(e){l=!0,o=e}finally{try{if(!c&&null!=n.return&&(s=n.return(),Object(s)!==s))return}finally{if(l)throw o}}return a}}(e,t)||Ht(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ut(e){return function(e){if(Array.isArray(e))return Xt(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||Ht(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ht(e,t){if(e){if("string"==typeof e)return Xt(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Xt(e,t):void 0}}function Xt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function Yt(e,t,n,r,o,i,s){try{var a=e[i](s),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,o)}var zt=SillyTavern.getContext(),Jt=["name","description","personality","scenario","first_mes","mes_example"];function Kt(e){return Zt.apply(this,arguments)}function Zt(){var e;return e=qt().mark((function e(t){var n,r,o,i,s,a,c,l,u,h,d,p,f,g,m,v,y,x,b,w,C,E,S,A,_,P,N,k,T,I,O;return qt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.profileId,o=t.userPrompt,i=t.buildPromptOptions,s=t.contextToSend,a=t.session,c=t.allCharacters,l=t.entriesGroupByWorldName,u=t.promptSettings,h=t.maxResponseToken,d=t.targetField,p=t.outputFormat,t.currentFieldValues,r){e.next=3;break}throw new Error("No connection profile selected.");case 3:if(f=null===(n=zt.extensionSettings.connectionManager)||void 0===n||null===(n=n.profiles)||void 0===n?void 0:n.find((function(e){return e.id===r}))){e.next=6;break}throw new Error('Connection profile with ID "'.concat(r,'" not found.'));case 6:if(g=zt.substituteParams(o.trim()),m=[],v=f.api?zt.CONNECT_API_MAP[f.api].selected:void 0){e.next=11;break}throw new Error('Could not determine API for profile "'.concat(f.name,'".'));case 11:return e.t0=m.push,e.t1=m,e.t2=Ut,e.next=16,Se(v,i);case 16:if(e.t3=e.sent,e.t4=(0,e.t2)(e.t3),e.t0.apply.call(e.t0,e.t1,e.t4),s.stDescription&&m.push({role:"system",content:u.stCharCardPrompt}),s.charCard&&a.selectedCharacterIndexes.length>0)try{y=$t.Handlebars.compile(u.charCardDefinitionPrompt,{noEscape:!0}),x={},a.selectedCharacterIndexes.forEach((function(e){var t=parseInt(e),n=c[t];n&&(x[t]=n)})),Object.keys(x).length>0&&(b=y({characters:x}))&&m.push({role:"system",content:"=== CONTEXT FROM SELECTED CHARACTERS ===\n".concat(b)})}catch(e){console.error("Error compiling or executing Handlebars template for character definitions:",e),m.push({role:"system",content:"Error: Could not generate character definitions for context."})}if(s.worldInfo&&a.selectedWorldNames.length>0)try{w=$t.Handlebars.compile(u.lorebookDefinitionPrompt,{noEscape:!0}),C={},Object.entries(l).filter((function(e){var t=Gt(e,2),n=t[0];return t[1].length>0&&a.selectedWorldNames.includes(n)})).forEach((function(e){var t=Gt(e,2),n=t[0],r=t[1];C[n]=r})),Object.keys(C).length>0&&(E=w({lorebooks:C}))&&m.push({role:"system",content:"=== CONTEXT FROM SELECTED LOREBOOKS (WORLD INFO) ===\n".concat(E)})}catch(e){console.error("Error compiling or executing Handlebars template for lorebook definitions:",e),m.push({role:"system",content:"Error: Could not generate lorebook definitions for context."})}if(s.existingFields&&a.fields&&Object.keys(a.fields).length>0){S="=== CURRENT CHARACTER FIELD VALUES ===\n",A=Wt(Jt);try{for(A.s();!(_=A.n()).done;)P=_.value,N=a.fields[P],(P!==d||null!=N&&N.value&&""!==N.value.trim())&&(S+="- ".concat(P,": ").concat((null==N?void 0:N.value)||"*Not filled*","\n"))}catch(e){A.e(e)}finally{A.f()}m.push({role:"system",content:S})}return m.push({role:"system",content:"=== RESPONSE FORMAT INSTRUCTIONS ===\n".concat(u.formatDescription)}),k='Your task is to generate the content for the "'.concat(d,'" field of a character card.'),k+=" Base your response on the chat history, persona (if provided), existing field values (if provided), context from other characters (if provided), and context from relevant lorebooks (if provided).",null!=(T=a.fields[d])&&T.prompt&&(k+="\n\nField-specific instructions: ".concat(T.prompt)),g&&(k+="\n\nFollow these specific instructions: ".concat(g)),m.push({role:"user",content:k}),e.next=32,zt.ConnectionManagerRequestService.sendRequest(r,m,h);case 32:return I=e.sent,O=Rt(I.content,p),e.abrupt("return",O);case 35:case"end":return e.stop()}}),e)})),Zt=function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function s(e){Yt(i,r,o,s,a,"next",e)}function a(e){Yt(i,r,o,s,a,"throw",e)}s(void 0)}))},Zt.apply(this,arguments)}var Qt='=======\n\nWhen creating a **character card** in SillyTavern, you can define a structured profile to guide the AI\'s behavior and ensure consistency in roleplay or storytelling. Below are the common fields and their purposes, based on community templates and best practices:\n\n---\n\n### **1. Name**\n**Purpose**:\nThe character’s primary identifier. The AI uses this to reference the character in dialogue and narration.\n**Key Tips**:\n- Use a memorable name that reflects their role (e.g., "Zara the Shadowblade" implies stealth/combat).\n- Avoid overly complex or ambiguous names (e.g., "Xy’lthraa" may confuse the AI).\n**Example**:\n`"Seraphina Vale"` (Elegant, hints at nobility) vs. `"Rusty"` (Casual, rugged).\n\n---\n\n### **2. Description**\n**Purpose**:\nA snapshot of the character’s identity, combining **appearance**, **personality**, and **key traits** to guide the AI’s "mental image."\n**Structure**:\n- **Appearance**: Physical traits (e.g., scars, clothing, species).\n- **Personality**: Core demeanor (e.g., stoic, playful).\n- **Mannerisms**: Unique habits (e.g., "taps fingers when lying").\n**Example**:\n> *"A hulking orc with moss-green skin and a chipped tusk, wearing a patchwork cloak. Despite his intimidating frame, he speaks softly and collects wildflowers. Secretly fears fire."*\n**Tips**:\n- Use vivid, concise language.\n- Prioritize traits critical to roleplay (e.g., "blind in one eye" affects interactions).\n\n---\n\n### **3. Personality**\n**Purpose**:\nExplicitly defines **how the character thinks/behaves**, reducing ambiguity for the AI.\n**What to Include**:\n- Core traits (e.g., "optimistic", "paranoid").\n- Motivations (e.g., "seeks revenge against the crown").\n- Flaws (e.g., "impulsive", "overly trusting").\n**Example**:\n`"Charismatic but manipulative; values loyalty only when it benefits him. Haunted by guilt over a failed rescue mission."`\n**Tips**:\n- Use bullet points or short phrases for clarity.\n- Avoid contradictions (e.g., "shy" vs. "loves public speaking").\n\n---\n\n### **4. Scenario**\n**Purpose**:\nSets the stage for the interaction, providing **contextual boundaries** for the AI.\n**What to Include**:\n- **Location**: Where the scene takes place (e.g., "a smoky tavern").\n- **Time**: Era or time-sensitive context (e.g., "during a solar eclipse").\n- **Relationship**: Predefined ties to the user (e.g., "childhood rivals reunited").\n**Example**:\n`"A cyberpunk night market in 2147. {{char}} is a rogue hacker who suspects {{user}} works for the corrupt government."`\n**Tips**:\n- Use dynamic placeholders like `{{user}}` to personalize the scenario.\n\n---\n\n### **5. First Message**\n**Purpose**:\nThe character’s **opening line**, critical for establishing tone, voice, and narrative momentum.\n**Key Elements**:\n- **Dialogue**: Shows speech style (formal, slang-heavy).\n- **Actions**: Subtle body language (e.g., "crosses arms skeptically").\n- **Hook**: Encourages user engagement (e.g., a question or mystery).\n**Example**:\n`*{{char}} adjusts her gas mask, voice muffled.* "You’re the third outsider this week. What makes you think you’ll survive the Wastes?"`\n**Tips**:\n- Avoid passive openings (e.g., "Hello, how can I help you?").\n- Mirror the character’s personality (e.g., a shy character might stammer).\n\n---\n\n### **6. Example Dialogue**\n**Purpose**:\nTeaches the AI the character’s **speech patterns**, **formatting preferences**, and **interaction style**.\n**Structure**:\n- Use `{{char}}` and `{{user}}` placeholders.\n- Mix dialogue and actions (e.g., `*{{char}} smirks.* "You’re bold. I like that."`).\n- Show range (e.g., anger, sarcasm, vulnerability).\n**Example**:\n```\n{{user}}: Why should I trust you?\n{{char}}: *Pulls a dagger from her boot and twirls it.* "You shouldn’t. But I’m your only way out of this alive."\n```\n**Tips**:\n- Include 3–5 varied exchanges.\n- Match the character’s voice (e.g., a poet might use metaphors).\n\n---\n\n### **Advanced Tips**\n- **Avoid "Wall of Text"**: Use line breaks and punctuation to improve readability for the AI.\n\n---\n\n### **Example Character Card Snippet**\n```json\n{\n  "name": "Kael Stormveil",\n  "description": "A storm sorcerer with crackling electricity in his eyes. Wears a cloak woven from thunderclouds. Pragmatic to a fault, but secretly fears losing control of his powers.",\n  "personality": "Analytical, blunt, distrusts authority. Motto: \'Chaosis just order waiting to be deciphered.\'",\n  "scenario": "A floating library during a magical hurricane. {{user}} is a novice mage Kael reluctantly mentors.",\n  "first_message": "*Kael’s hands spark as he slams a tome shut.* ‘You’ve got five minutes to explain why I shouldn’t toss you into the storm.’",\n  "example_dialogue": "{{user}}: Can you teach me to control the storm?\n{{char}}: *Snorts.* ‘Control is an illusion. You ride the storm or drown.’"\n}\n```\n\n=======',en="{{#if characters}}\n## SELECTED CHARACTERS FOR CONTEXT\n{{#each characters}}\n### Character: {{this.name}}\n- **Description:** {{#if this.description}}{{this.description}}{{else}}*Not provided*{{/if}}\n- **Personality:** {{#if this.personality}}{{this.personality}}{{else}}*Not provided*{{/if}}\n- **Scenario:** {{#if this.scenario}}{{this.scenario}}{{else}}*Not provided*{{/if}}\n- **First Message:** {{#if this.first_mes}}{{this.first_mes}}{{else}}*Not provided*{{/if}}\n- **Example Dialogue:**\n  {{#if this.mes_example}}{{this.mes_example}}{{else}}*Not provided*{{/if}}\n\n---\n{{/each}}\n{{/if}}",tn="You MUST provide your response wrapped ONLY in a single <response> XML tag.\nExample:\n<response>Generated content for the field goes here.</response>",nn='You MUST provide your response as a JSON object with a single key "response" containing the generated content as a string.\nExample:\n{\n  "response": "Generated content for the field goes here."\n}',rn="You MUST provide ONLY the raw text content for the field, without any formatting, XML tags, JSON structure, or explanatory text. Just the content itself.",on="{{#each lorebooks}}\n  {{#if this.length}}\n## WORLD NAME: {{@key}}\n    {{#each this as |entry|}}\n      {{#unless entry.disable}}\n- {{entry.comment}}\nTriggers: {{#if entry.key}}{{join entry.key ', '}}{{else}}*No triggers*{{/if}}\nContent: {{#if entry.content}}{{entry.content}}{{else}}*No content*{{/if}}\n\n      {{/unless}}\n    {{/each}}\n  {{/if}}\n{{/each}}",sn="SillyTavern-Character-Creator",an={version:"0.1.0",formatVersion:"F_1.0",profileId:"",maxContextType:"profile",maxContextValue:16384,maxResponseToken:1024,outputFormat:"xml",contextToSend:{stDescription:!0,messages:{type:"last",first:10,last:10,range:{start:0,end:10}},charCard:!0,existingFields:!0,worldInfo:!0},stCharCardPrompt:Qt,usingDefaultStCharCardPrompt:!0,charCardDefinitionPrompt:en,usingDefaultCharCardDefinitionPrompt:!0,lorebookDefinitionPrompt:on,usingDefaultLorebookDefinitionPrompt:!0,xmlFormatDesc:tn,usingDefaultXmlFormatDesc:!0,jsonFormatDesc:nn,usingDefaultJsonFormatDesc:!0,noneFormatDesc:rn,usingDefaultNoneFormatDesc:!0,promptPreset:"default",promptPresets:{default:{content:"Generate the field content based on the chat history and existing character details. Be creative but consistent."}}},cn=new class{settingsKey;defaultSettings;constructor(e,t){this.settingsKey=e,this.defaultSettings=t}async initializeSettings(e={}){const{strategy:t="recursive"}=e,n=this.defaultSettings.version,r=this.defaultSettings.formatVersion,o=SillyTavern.getContext().extensionSettings[this.settingsKey],i={version:{changed:!1,new:n??""},formatVersion:{changed:!1,new:r??""},oldSettings:null,newSettings:this.defaultSettings};if(!o)return SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings(),i;const s={...i,oldSettings:structuredClone(o),version:{changed:!1,old:o.version,new:o.version},formatVersion:{changed:!1,old:o.formatVersion,new:o.formatVersion}};if("recursive"===t){function a(e,t){let n=!1;for(const r of Object.keys(t))void 0===e[r]?(e[r]=t[r],n=!0):"object"==typeof t[r]&&null!==t[r]&&(e[r]=e[r]||{},a(e[r],t[r])&&(n=!0));return n}n&&o.version!==n&&(s.version.changed=!0,s.version.new=n,o.version=n),r&&o.formatVersion!==r&&(s.formatVersion.changed=!0,s.formatVersion.new=r,o.formatVersion=r),(a(o,this.defaultSettings)||s.version.changed||s.formatVersion.changed)&&this.saveSettings()}else if(Array.isArray(t)){n&&!o.version&&(o.version=n,s.version.changed=!0,s.version.new=n),r&&!o.formatVersion&&(o.formatVersion=r,s.formatVersion.changed=!0,s.formatVersion.new=r);let c=structuredClone(o),l=o.formatVersion;try{for(const u of t)if(l===u.from){c=await u.action(c),l=u.to,c.formatVersion=u.to;const h=this.defaultSettings.version;h&&(c.version=h),s.formatVersion.changed=!0,s.formatVersion.new=u.to}if(s.formatVersion.changed){Object.assign(o,c);for(const d of Object.keys(o))Object.keys(c).includes(d)||delete o[d];this.saveSettings()}}catch(p){throw console.error("Failed to apply version changes:",p),new Error(`Version migration failed: ${p instanceof Error?p.message:p}`,{cause:p})}}return s.newSettings=o,s}getSettings(){return SillyTavern.getContext().extensionSettings[this.settingsKey]}updateSetting(e,t){SillyTavern.getContext().extensionSettings[this.settingsKey][e]=t,this.saveSettings()}saveSettings(){SillyTavern.getContext().saveSettingsDebounced()}resetSettings(){SillyTavern.getContext().extensionSettings[this.settingsKey]=this.defaultSettings,this.saveSettings()}}("charCreator",an);function ln(e){return ln="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},ln(e)}function un(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function hn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?un(Object(n),!0).forEach((function(t){dn(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):un(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function dn(e,t,n){return(t=function(e){var t=function(e,t){if("object"!=ln(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=ln(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==ln(t)?t:t+""}(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function pn(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,i,s,a=[],c=!0,l=!1;try{if(i=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=i.call(n)).done)&&(a.push(r.value),a.length!==t);c=!0);}catch(e){l=!0,o=e}finally{try{if(!c&&null!=n.return&&(s=n.return(),Object(s)!==s))return}finally{if(l)throw o}}return a}}(e,t)||function(e,t){if(e){if("string"==typeof e)return fn(e,t);var n={}.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?fn(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function fn(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function gn(){/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */gn=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},i="function"==typeof Symbol?Symbol:{},s=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",c=i.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function u(e,t,n,r){var i=t&&t.prototype instanceof v?t:v,s=Object.create(i.prototype),a=new T(r||[]);return o(s,"_invoke",{value:_(e,n,a)}),s}function h(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=u;var d="suspendedStart",p="suspendedYield",f="executing",g="completed",m={};function v(){}function y(){}function x(){}var b={};l(b,s,(function(){return this}));var w=Object.getPrototypeOf,C=w&&w(w(I([])));C&&C!==n&&r.call(C,s)&&(b=C);var E=x.prototype=v.prototype=Object.create(b);function S(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function A(e,t){function n(o,i,s,a){var c=h(e[o],e,i);if("throw"!==c.type){var l=c.arg,u=l.value;return u&&"object"==ln(u)&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){n("next",e,s,a)}),(function(e){n("throw",e,s,a)})):t.resolve(u).then((function(e){l.value=e,s(l)}),(function(e){return n("throw",e,s,a)}))}a(c.arg)}var i;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return i=i?i.then(o,o):o()}})}function _(t,n,r){var o=d;return function(i,s){if(o===f)throw Error("Generator is already running");if(o===g){if("throw"===i)throw s;return{value:e,done:!0}}for(r.method=i,r.arg=s;;){var a=r.delegate;if(a){var c=P(a,r);if(c){if(c===m)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===d)throw o=g,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=f;var l=h(t,n,r);if("normal"===l.type){if(o=r.done?g:p,l.arg===m)continue;return{value:l.arg,done:r.done}}"throw"===l.type&&(o=g,r.method="throw",r.arg=l.arg)}}}function P(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,P(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var i=h(o,t.iterator,n.arg);if("throw"===i.type)return n.method="throw",n.arg=i.arg,n.delegate=null,m;var s=i.arg;return s?s.done?(n[t.resultName]=s.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,m):s:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function N(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function k(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(N,this),this.reset(!0)}function I(t){if(t||""===t){var n=t[s];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,i=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return i.next=i}}throw new TypeError(ln(t)+" is not iterable")}return y.prototype=x,o(E,"constructor",{value:x,configurable:!0}),o(x,"constructor",{value:y,configurable:!0}),y.displayName=l(x,c,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,x):(e.__proto__=x,l(e,c,"GeneratorFunction")),e.prototype=Object.create(E),e},t.awrap=function(e){return{__await:e}},S(A.prototype),l(A.prototype,a,(function(){return this})),t.AsyncIterator=A,t.async=function(e,n,r,o,i){void 0===i&&(i=Promise);var s=new A(u(e,n,r,o),i);return t.isGeneratorFunction(n)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},S(E),l(E,c,"Generator"),l(E,s,(function(){return this})),l(E,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=I,T.prototype={constructor:T,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(k),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return a.type="throw",a.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i],a=s.completion;if("root"===s.tryLoc)return o("end");if(s.tryLoc<=this.prev){var c=r.call(s,"catchLoc"),l=r.call(s,"finallyLoc");if(c&&l){if(this.prev<s.catchLoc)return o(s.catchLoc,!0);if(this.prev<s.finallyLoc)return o(s.finallyLoc)}else if(c){if(this.prev<s.catchLoc)return o(s.catchLoc,!0)}else{if(!l)throw Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return o(s.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var i=o;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var s=i?i.completion:{};return s.type=e,s.arg=t,i?(this.method="next",this.next=i.finallyLoc,m):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),m},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),k(n),m}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;k(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:I(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),m}},t}function mn(e,t,n,r,o,i,s){try{var a=e[i](s),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,o)}function vn(e){return function(){var t=this,n=arguments;return new Promise((function(r,o){var i=e.apply(t,n);function s(e){mn(i,r,o,s,a,"next",e)}function a(e){mn(i,r,o,s,a,"throw",e)}s(void 0)}))}}function yn(){return(yn=vn(gn().mark((function e(){var t,n,r,o;return gn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,zt.renderExtensionTemplateAsync("third-party/".concat(sn),"templates/settings");case 2:if(t=e.sent,$("#extensions_settings").append(t),n=document.querySelector(".charCreator_settings")){e.next=7;break}return e.abrupt("return");case 7:r=cn.getSettings(),(o=function(e,t,o,i){var s=n.querySelector(".".concat(e));if(s){var a=s.querySelector("textarea"),c=s.querySelector(".restore_default");a.value=String(r[t]),c.addEventListener("click",vn(gn().mark((function e(){var t;return gn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,zt.Popup.show.confirm("Character Creator",'Are you sure you want to restore the default for "'.concat(null===(t=s.querySelector("span"))||void 0===t?void 0:t.textContent,'"?'));case 2:e.sent&&(a.value=o,a.dispatchEvent(new Event("change")));case 4:case"end":return e.stop()}}),e)})))),a.addEventListener("change",(function(){r[t]=a.value,r[i]=a.value===o,cn.saveSettings()}))}})("stCharCardPrompt","stCharCardPrompt",Qt,"usingDefaultStCharCardPrompt"),o("charCardDefinitionPrompt","charCardDefinitionPrompt",en,"usingDefaultCharCardDefinitionPrompt"),o("lorebookDefinitionPrompt","lorebookDefinitionPrompt",on,"usingDefaultLorebookDefinitionPrompt"),o("xmlFormatDesc","xmlFormatDesc",tn,"usingDefaultXmlFormatDesc"),o("jsonFormatDesc","jsonFormatDesc",nn,"usingDefaultJsonFormatDesc"),o("noneFormatDesc","noneFormatDesc",rn,"usingDefaultNoneFormatDesc");case 15:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function xn(){return xn=vn(gn().mark((function e(){var t;return gn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t='<div class="menu_button fa-solid fa-user-astronaut interactable charCreator-icon" title="Character Creator"></div>',$(".form_create_bottom_buttons_block").prepend(t),$("#GroupFavDelOkBack").prepend(t),$("#form_character_search_form").prepend(t),document.querySelectorAll(".charCreator-icon").forEach((function(e){e.addEventListener("click",vn(gn().mark((function e(){var t,n,r,o,i,s,a,c,l,u,h,d,p,g,m,v,y,x,b,w,C,E,S,A,_,P,N,k,T,I,O,D,F,L,M,j,B,R,$,V,q,W,G,U,H,X;return gn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,zt.renderExtensionTemplateAsync("third-party/".concat(sn),"templates/popup");case 2:if(u=e.sent,zt.callGenericPopup(u,Ae.DISPLAY,void 0,{large:!0,wide:!0}),h=document.getElementById("charCreatorPopup")){e.next=7;break}return e.abrupt("return");case 7:d=cn.getSettings(),zt.ConnectionManagerRequestService.handleDropdown("#charCreatorPopup #charCreator_connectionProfile",d.profileId,(function(e){var t;d.profileId=null!==(t=null==e?void 0:e.id)&&void 0!==t?t:"",cn.saveSettings()})),p=h.querySelector("#charCreator_stDescription"),g=h.querySelector("#charCreator_includeChars"),m=h.querySelector("#charCreator_charIncludeContainer"),v=h.querySelector("#charCreator_includeWorldInfo"),y=h.querySelector("#charCreator_worldInfoIncludeContainer"),x=h.querySelector("#charCreator_includeExistingFields"),p.checked=d.contextToSend.stDescription,g.checked=d.contextToSend.charCard,x.checked=d.contextToSend.existingFields,v.checked=d.contextToSend.worldInfo,m.style.display=g.checked?"block":"none",y.style.display=v.checked?"block":"none",p.addEventListener("change",(function(){d.contextToSend.stDescription=p.checked,cn.saveSettings()})),g.addEventListener("change",(function(){d.contextToSend.charCard=g.checked,m.style.display=g.checked?"block":"none",cn.saveSettings()})),v.addEventListener("change",(function(){d.contextToSend.worldInfo=v.checked,y.style.display=v.checked?"block":"none",cn.saveSettings()})),x.addEventListener("change",(function(){d.contextToSend.existingFields=x.checked,cn.saveSettings()})),b=h.querySelector(".message-options"),w=h.querySelector("#charCreator_messageType"),C=h.querySelector("#charCreator_firstX"),E=h.querySelector("#charCreator_lastX"),S=h.querySelector("#charCreator_rangeX"),A=h.querySelector("#charCreator_firstXMessages"),_=h.querySelector("#charCreator_lastXMessages"),P=h.querySelector("#charCreator_rangeStart"),N=h.querySelector("#charCreator_rangeEnd"),w.value=d.contextToSend.messages.type,A.value=String(null!==(t=d.contextToSend.messages.first)&&void 0!==t?t:10),_.value=String(null!==(n=d.contextToSend.messages.last)&&void 0!==n?n:10),P.value=String(null!==(r=null===(o=d.contextToSend.messages.range)||void 0===o?void 0:o.start)&&void 0!==r?r:0),N.value=String(null!==(i=null===(s=d.contextToSend.messages.range)||void 0===s?void 0:s.end)&&void 0!==i?i:10),(k=function(e){C.style.display="first"===e?"block":"none",E.style.display="last"===e?"block":"none",S.style.display="range"===e?"block":"none"})(w.value),"none"!==d.contextToSend.messages.type||void 0!==ce.this_chid||fe.selected_group||(b.style.display="none"),w.addEventListener("change",(function(){var e=w.value;d.contextToSend.messages.type=e,cn.saveSettings(),k(e)})),A.addEventListener("change",(function(){d.contextToSend.messages.first=parseInt(A.value)||10,cn.saveSettings()})),_.addEventListener("change",(function(){d.contextToSend.messages.last=parseInt(_.value)||10,cn.saveSettings()})),P.addEventListener("change",(function(){var e,t;d.contextToSend.messages.range={start:parseInt(P.value)||0,end:null!==(e=null===(t=d.contextToSend.messages.range)||void 0===t?void 0:t.end)&&void 0!==e?e:10},cn.saveSettings()})),N.addEventListener("change",(function(){var e,t;d.contextToSend.messages.range={start:null!==(e=null===(t=d.contextToSend.messages.range)||void 0===t?void 0:t.start)&&void 0!==e?e:0,end:parseInt(N.value)||10},cn.saveSettings()})),T=h.querySelector("#charCreator_maxContextType"),I=h.querySelector("#charCreator_maxTokens_container"),O=h.querySelector("#charCreator_maxTokens"),T.value=d.maxContextType,I.style.display="custom"===d.maxContextType?"block":"none",O.value=String(d.maxContextValue),T.addEventListener("change",(function(){var e=T.value;d.maxContextType=e,cn.saveSettings(),I.style.display="custom"===e?"block":"none"})),O.addEventListener("change",(function(){d.maxContextValue=Number(O.value)||16384,cn.saveSettings()})),(D=h.querySelector("#charCreator_maxResponseTokens")).value=String(d.maxResponseToken),D.addEventListener("change",(function(){d.maxResponseToken=Number(D.value)||1024,cn.saveSettings()})),(F=h.querySelector("#charCreator_outputFormat")).value=d.outputFormat,F.addEventListener("change",(function(){d.outputFormat=F.value,cn.saveSettings()})),L="charCreator",(M=JSON.parse(null!==(a=localStorage.getItem(L))&&void 0!==a?a:"{}")).selectedCharacterIndexes||(M.selectedCharacterIndexes=ce.this_chid?[ce.this_chid]:[]),M.selectedWorldNames||(M.selectedWorldNames=[]),M.fields||(M.fields={}),Jt.forEach((function(e){M.fields[e]||(M.fields[e]={value:"",prompt:""})})),j=function(){localStorage.setItem(L,JSON.stringify(M))},B=SillyTavern.getContext(),M.selectedCharacterIndexes=M.selectedCharacterIndexes.filter((function(e){return B.characters[Number(e)]})),h.querySelector("#charCreator_characterSelector")&&se("#charCreator_characterSelector",{initialList:R=B.characters.map((function(e){return{value:B.characters.indexOf(e).toString(),label:e.name}})),initialValues:M.selectedCharacterIndexes,placeholderText:"Select characters...",enableSearch:R.length>10,onSelectChange:function(e,t){M.selectedCharacterIndexes=t,j()}}),$=h.querySelector("#charCreator_worldInfoSelector"),V=structuredClone(le.world_names);try{$&&V.length>0?se("#charCreator_worldInfoSelector",{initialList:V,initialValues:M.selectedWorldNames,placeholderText:"Select lorebooks...",enableSearch:V.length>10,onSelectChange:function(e,t){M.selectedWorldNames=t,j()}}):$&&($.textContent="No active lorebooks found.")}catch(e){console.error("Failed to get active world info:",e),$&&($.textContent="Error loading lorebooks.")}q=h.querySelector("#charCreator_prompt"),Ee("#charCreatorPopup #charCreator_promptPreset",{label:"instructionPreset",initialValue:d.promptPreset,initialList:Object.keys(d.promptPresets),readOnlyValues:["default"],onSelectChange:function(){var e=vn(gn().mark((function e(t,n){var r,o,i;return gn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=null!=n?n:"default",d.promptPreset=i,cn.saveSettings(),q.value=null!==(r=null===(o=d.promptPresets[i])||void 0===o?void 0:o.content)&&void 0!==r?r:"";case 4:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}(),create:{onAfterCreate:function(e){var t,n=d.promptPresets[d.promptPreset];d.promptPresets[e]={content:null!==(t=null==n?void 0:n.content)&&void 0!==t?t:""}}},rename:{onAfterRename:function(e,t){d.promptPresets[t]=d.promptPresets[e],delete d.promptPresets[e]}},delete:{onAfterDelete:function(e){delete d.promptPresets[e]}}}),q.value=null!==(c=null===(l=d.promptPresets[d.promptPreset])||void 0===l?void 0:l.content)&&void 0!==c?c:"",q.addEventListener("change",(function(){d.promptPresets[d.promptPreset]&&(d.promptPresets[d.promptPreset].content=q.value,cn.saveSettings())})),W={name:{label:"Name",rows:1,large:!1,promptEnabled:!1},description:{label:"Description",rows:5,large:!0,promptEnabled:!0},personality:{label:"Personality",rows:4,large:!0,promptEnabled:!0},scenario:{label:"Scenario",rows:3,large:!0,promptEnabled:!0},first_mes:{label:"First Message",rows:3,large:!0,promptEnabled:!0},mes_example:{label:"Example Dialogue",rows:6,large:!0,promptEnabled:!0}},G=h.querySelector("#charCreator_fieldTemplate"),U=h.querySelector("#charCreator_fieldsContainer"),H={},G&&U&&Jt.forEach((function(e){var t=W[e],n=G.content.cloneNode(!0),r=n.querySelector(".character-field"),o=n.querySelector("label"),i=n.querySelector(".field-container textarea"),s=n.querySelector(".generate-field-button"),a=n.querySelector(".field-prompt-container textarea");if(r&&o&&i&&s&&a){var c,l,u,h,d,p;if(i.id="charCreator_field_".concat(e),a.id="charCreator_prompt_".concat(e),o.dataset.for=i.id,o.textContent=t.label,i.rows=t.rows,i.value=null!==(c=null===(l=M.fields[e])||void 0===l?void 0:l.value)&&void 0!==c?c:"",s.dataset.field=e,s.title="Generate ".concat(t.label),a.placeholder="Enter addiitonal prompt for ".concat(t.label.toLowerCase(),"..."),a.value=null!==(u=null===(h=M.fields[e])||void 0===h?void 0:h.prompt)&&void 0!==u?u:"",!t.promptEnabled)null===(d=a.closest(".field-prompt-container"))||void 0===d||d.remove();if(t.large)null===(p=i.closest(".field-container"))||void 0===p||p.classList.add("large-field");H[e]={textarea:i,button:s,promptTextarea:a}}U.appendChild(n)})),h.querySelector("#charCreator_loadCharSelector")&&se("#charCreator_loadCharSelector",{initialList:X=B.characters.map((function(e){return{value:B.characters.indexOf(e).toString(),label:e.name}})),initialValues:[],placeholderText:"Load Character Data...",enableSearch:X.length>10,multiple:!1,closeOnSelect:!0,onBeforeSelection:function(e,t){return vn(gn().mark((function e(){return gn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.length){e.next=2;break}return e.abrupt("return",!1);case 2:if(0!==t[0].length){e.next=5;break}return e.abrupt("return",!1);case 5:if(Jt.every((function(e){var t,n=null===(t=H[e])||void 0===t?void 0:t.textarea;return n&&""===n.value.trim()}))){e.next=12;break}return e.next=9,zt.Popup.show.confirm("Load Character Data","Are you sure you want to overwrite existing data? This cannot be undone.");case 9:if(e.sent){e.next=12;break}return e.abrupt("return",!1);case 12:return e.abrupt("return",!0);case 13:case"end":return e.stop()}}),e)})))()},onSelectChange:function(){var e=vn(gn().mark((function e(t,n){var r,o;return gn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==n.length){e.next=2;break}return e.abrupt("return");case 2:if(0!==(r=n[0]).length){e.next=5;break}return e.abrupt("return");case 5:if(o=B.characters[parseInt(r)]){e.next=9;break}return me("warning","Selected character not found."),e.abrupt("return");case 9:Jt.forEach((function(e){var t,n,r,i=null===(t=H[e])||void 0===t?void 0:t.textarea,s=null===(n=H[e])||void 0===n?void 0:n.promptTextarea;i&&(i.value=null!==(r=o[e])&&void 0!==r?r:"",i.dispatchEvent(new Event("change")));s&&""!==s.value.trim()&&(s.value="",s.dispatchEvent(new Event("change")))}));case 10:case"end":return e.stop()}}),e)})));return function(t,n){return e.apply(this,arguments)}}()}),h.querySelector("#charCreator_reset").addEventListener("click",vn(gn().mark((function e(){return gn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,zt.Popup.show.confirm("Reset Fields","Are you sure you want to reset all fields? This cannot be undone.");case 2:e.sent&&Jt.forEach((function(e){var t,n;null!==(t=H[e])&&void 0!==t&&t.textarea&&(H[e].textarea.value="",H[e].textarea.dispatchEvent(new Event("change"))),null!==(n=H[e])&&void 0!==n&&n.promptTextarea&&(H[e].promptTextarea.value="",H[e].promptTextarea.dispatchEvent(new Event("change")))}));case 4:case"end":return e.stop()}}),e)})))),h.querySelector("#charCreator_saveAsNewCharacter").addEventListener("click",vn(gn().mark((function e(){var t;return gn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(M.fields.name.value){e.next=3;break}return me("warning","Please enter a name for the new character."),e.abrupt("return");case 3:return e.next=5,zt.Popup.show.confirm("Save as New Character","Are you sure?");case 5:if(e.sent){e.next=8;break}return e.abrupt("return");case 8:return t={name:M.fields.name.value,description:M.fields.description.value,personality:M.fields.personality.value,scenario:M.fields.scenario.value,first_mes:M.fields.first_mes.value,mes_example:M.fields.mes_example.value,data:{name:M.fields.name.value,description:M.fields.description.value,personality:M.fields.personality.value,scenario:M.fields.scenario.value,first_mes:M.fields.first_mes.value,mes_example:M.fields.mes_example.value,tags:[],avatar:"none"},avatar:"none",tags:[],spec:"chara_card_v3",spec_version:"3.0"},e.prev=9,e.next=12,f(t,!0);case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(9),me("error","Failed to create character: ".concat(e.t0.message));case 17:case"end":return e.stop()}}),e,null,[[9,14]])})))),Object.entries(H).forEach((function(e){var t=pn(e,2),n=t[0],r=t[1],o=r.textarea,i=r.button,s=r.promptTextarea;i&&(i.addEventListener("click",vn(gn().mark((function e(){var t,r,a,c,l,u,p,f,g,m,v,y,x,b,w,C,E,S,A,_,P;return gn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(g=n,i.disabled=!0,m=i.innerHTML,i.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>',e.prev=4,y=h.querySelector("#charCreator_prompt").value,d.profileId){e.next=9;break}return me("warning","Please select a connection profile."),e.abrupt("return");case 9:if(x=null===(v=B.extensionSettings.connectionManager)||void 0===v||null===(v=v.profiles)||void 0===v?void 0:v.find((function(e){return e.id===d.profileId}))){e.next=13;break}return me("warning","Connection profile not found."),e.abrupt("return");case 13:b={},Jt.forEach((function(e){b[e]={value:o.value,prompt:(null==s?void 0:s.value)||""}})),w={presetName:null==x?void 0:x.preset,contextName:null==x?void 0:x.context,instructName:null==x?void 0:x.instruct,targetCharacterId:ce.this_chid,ignoreCharacterFields:!0,ignoreWorldInfo:!0,ignoreAuthorNote:!0,maxContext:"custom"===d.maxContextType?d.maxContextValue:"profile"===d.maxContextType?"preset":"active",includeNames:!!fe.selected_group},C=d.contextToSend.messages,e.t0=C.type,e.next="none"===e.t0?20:"first"===e.t0?22:"last"===e.t0?24:"range"===e.t0?28:(e.t0,30);break;case 20:return w.messageIndexesBetween={start:-1,end:-1},e.abrupt("break",31);case 22:return w.messageIndexesBetween={start:0,end:null!==(t=C.first)&&void 0!==t?t:10},e.abrupt("break",31);case 24:return E=null!==(r=null===(a=zt.chat)||void 0===a?void 0:a.length)&&void 0!==r?r:0,S=null!==(c=C.last)&&void 0!==c?c:10,w.messageIndexesBetween={end:Math.max(0,E-1),start:Math.max(0,E-S)},e.abrupt("break",31);case 28:return w.messageIndexesBetween={start:null!==(l=null===(u=C.range)||void 0===u?void 0:u.start)&&void 0!==l?l:0,end:null!==(p=null===(f=C.range)||void 0===f?void 0:f.end)&&void 0!==p?p:10},e.abrupt("break",31);case 30:return e.abrupt("break",31);case 31:void 0!==ce.this_chid||fe.selected_group||(w.messageIndexesBetween={start:-1,end:-1}),A="",e.t1=d.outputFormat,e.next="xml"===e.t1?36:"json"===e.t1?38:"none"===e.t1?40:42;break;case 36:return A=d.xmlFormatDesc,e.abrupt("break",42);case 38:return A=d.jsonFormatDesc,e.abrupt("break",42);case 40:return A=d.noneFormatDesc,e.abrupt("break",42);case 42:return _={},le.world_names.filter((function(e){return M.selectedWorldNames.includes(e)})).forEach(function(){var e=vn(gn().mark((function e(t){var n;return gn().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,zt.loadWorldInfo(t);case 2:(n=e.sent)&&(_[t]=Object.values(n.entries));case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),e.next=46,Kt({profileId:d.profileId,userPrompt:y,buildPromptOptions:w,contextToSend:d.contextToSend,session:M,allCharacters:B.characters,entriesGroupByWorldName:_,promptSettings:{stCharCardPrompt:d.stCharCardPrompt,charCardDefinitionPrompt:d.charCardDefinitionPrompt,lorebookDefinitionPrompt:d.lorebookDefinitionPrompt,formatDescription:A},maxResponseToken:d.maxResponseToken,targetField:g,outputFormat:d.outputFormat,currentFieldValues:b});case 46:P=e.sent,o.value=P,o.dispatchEvent(new Event("change")),e.next=55;break;case 51:e.prev=51,e.t2=e.catch(4),console.error("Error generating field ".concat(g,":"),e.t2),me("error","Failed to generate ".concat(g,": ").concat(e.t2.message||e.t2));case 55:return e.prev=55,i.disabled=!1,i.innerHTML=m,e.finish(55);case 59:case"end":return e.stop()}}),e,null,[[4,51,55,59]])})))),o.addEventListener("change",(function(){var e=n;M.fields[e]=hn(hn({},M.fields[e]),{},{value:o.value}),j()})),null==s||s.addEventListener("change",(function(){var e=n;M.fields[e]=hn(hn({},M.fields[e]),{},{prompt:s.value}),j()})))}));case 91:case"end":return e.stop()}}),e)}))))}));case 6:case"end":return e.stop()}}),e)}))),xn.apply(this,arguments)}function bn(){!function(){yn.apply(this,arguments)}(),function(){xn.apply(this,arguments)}()}$t.Handlebars.helpers.join||$t.Handlebars.registerHelper("join",(function(e,t){return Array.isArray(e)?e.join("string"==typeof t?t:", "):""})),$t.Handlebars.registerHelper("ifValue",(function(e,t){return e&&String(e).trim().length>0?t.fn(this):t.inverse(this)})),zt.ConnectionManagerRequestService?cn.initializeSettings().then((function(e){if(e.version.changed){var t=cn.getSettings(),n=!1,r=function(e,r,o){t[o]&&t[e]!==r&&(console.log("[".concat(sn,"] Updating default for ").concat(e)),t[e]=r,n=!0)};r("stCharCardPrompt",Qt,"usingDefaultStCharCardPrompt"),r("charCardDefinitionPrompt",en,"usingDefaultCharCardDefinitionPrompt"),r("xmlFormatDesc",tn,"usingDefaultXmlFormatDesc"),r("jsonFormatDesc",nn,"usingDefaultJsonFormatDesc"),r("noneFormatDesc",rn,"usingDefaultNoneFormatDesc"),n&&(console.log("[".concat(sn,"] Saving updated default settings.")),cn.saveSettings())}bn()})).catch((function(e){console.error("[".concat(sn,"] Error initializing settings:"),e),me("error","[".concat(sn,"] Failed to initialize settings: ").concat(e.message)),zt.Popup.show.confirm("[".concat(sn,"] Failed to load settings. This might be due to an update. Reset settings to default?"),"Extension Error").then((function(e){e&&(cn.resetSettings(),me("success","[".concat(sn,"] Settings reset. Reloading may be required.")),bn())}))})):(console.error("[".concat(sn,"] Error: Required SillyTavern functions not found. Make sure ST is up-to-date.")),me("error","[".concat(sn,"] Initialization failed. Please ensure SillyTavern is updated.")));